---
title: "Gene Expression"
author: "Ittai Eres"
date: 2017-11-01
output: html_document
---

<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
```{r read-chunk, include=FALSE, cache=FALSE}
knitr::read_chunk("chunks.R")
```

<!-- Update knitr chunk options -->
```{r knitr-opts-chunk, include=FALSE}
```

<!-- Insert the date the file was last updated -->
```{r last-updated, echo=FALSE, results='asis'}
```

<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
```{r code-version, echo=FALSE, results='asis'}
```

<!-- Add your analysis here -->
```{r library loading, include=FALSE, echo=FALSE}
#First, get necessary packages.
library(limma)
library(plyr)
library(tidyr)
library(data.table)
library(reshape2)
library(ggplot2)
library(plotly)
library(dplyr)
library(Hmisc)
library(gplots)
library(stringr)
library(heatmaply)
library(RColorBrewer)
library(edgeR)
library(tidyverse)
library(compiler)
library(bedr)
library(ashr)
library(vashr)
library(medinome)
library(glmnet)
enableJIT(3)
```
###Preparing the gene expression data
Here I read in a dataframe of counts summarized at the gene-level, then do some pre-processing and normalization to obtain a voom object to later run linear modeling analyses on.
```{r Prepping gene expression data}
#Read in counts data, create DGEList object out of them and convert to log counts per million (CPM). Also read in metadata.
counts <- fread("~/Desktop/Hi-C/gene_expression/counts_iPSC.txt", header=TRUE, data.table=FALSE, stringsAsFactors = FALSE, na.strings=c("NA",""))
colnames(counts) <- c("genes", "C-3649", "G-3624", "H-3651", "D-40300", "F-28834", "B-28126", "E-28815", "A-21792")
rownames(counts) <- counts$genes
counts <- counts[,-1]
dge <- DGEList(counts, genes=rownames(counts))

#Now, convert counts into RPKM to account for gene length differences between species. First load in and re-organize metadata, then the gene lengths for both species, and then the function to convert counts to RPKM.
meta_data <- fread("~/Desktop/Hi-C/gene_expression/Meta_data.txt", sep="\t",stringsAsFactors = FALSE,header=T,na.strings=c("NA",""))
meta_data$fullID <- c("C-3649", "H-3651", "B-28126", "D-40300", "G-3624", "A-21792", "E-28815", "F-28834")
ord <- data.frame(fullID=colnames(counts)) #Pull order of samples from expression object
left_join(ord, meta_data, by="fullID") -> group_ref #left join meta data to this to make sure sample IDs correct

#Read in human and chimp gene lengths for the RPKM function:
human_lengths<- fread("~/Desktop/Hi-C/gene_expression/human_lengths.txt", sep="\t",stringsAsFactors = FALSE,header=T,na.strings=c("NA",""))
chimp_lengths<- fread("~/Desktop/Hi-C/gene_expression/chimp_lengths.txt", sep="\t",stringsAsFactors = FALSE,header=T,na.strings=c("NA",""))

#The function for RPKM conversion.
vRPKM <- function(expr.obj,chimp_lengths,human_lengths,meta4) {
  if (is.null(expr.obj$E)) {
    meta4%>%filter(SP=="C" & fullID %in% colnames(counts))->chimp_meta
    meta4%>%filter(SP=="H" & fullID %in% colnames(counts))->human_meta
    
    #using RPKM function:
    #Put genes in correct order:
    expr.obj$genes %>%select(Geneid=genes)%>%
      left_join(.,chimp_lengths,by="Geneid")%>%select(Geneid,ch.length)->chlength
    
    expr.obj$genes %>%select(Geneid=genes)%>%
      left_join(.,human_lengths,by="Geneid")%>%select(Geneid,hu.length)->hulength
    
    #Chimp RPKM
    expr.obj$genes$Length<-(chlength$ch.length)
    RPKMc=rpkm(expr.obj,normalized.lib.sizes=TRUE, log=TRUE)
    RPKMc[,colnames(RPKMc) %in% chimp_meta$fullID]->rpkm_chimp
    
    #Human RPKM
    expr.obj$genes$Length<-hulength$hu.length
    RPKMh=rpkm(expr.obj,normalized.lib.sizes=TRUE, log=TRUE)
    RPKMh[,colnames(RPKMh) %in% human_meta$fullID]->rpkm_human
    
    
    cbind(rpkm_chimp,rpkm_human)->allrpkm
    expr.obj$E <- allrpkm
    return(expr.obj)
    
  }
  else {
    #Pull out gene order from voom object and add in gene lengths from feature counts file
    #Put genes in correct order:
    expr.obj$genes %>%select(Geneid=genes)%>%
      left_join(.,chimp_lengths,by="Geneid")%>%select(Geneid,ch.length)->chlength
    
    expr.obj$genes %>%select(Geneid=genes)%>%
      left_join(.,human_lengths,by="Geneid")%>%select(Geneid,hu.length)->hulength
    
    
    #Filter meta data to be able to separate human and chimp
    meta4%>%filter(SP=="C")->chimp_meta
    meta4%>%filter(SP=="H")->human_meta
    
    #Pull out the expression data in cpm to convert to RPKM
    expr.obj$E->forRPKM
    
    forRPKM[,colnames(forRPKM) %in% chimp_meta$fullID]->rpkm_chimp
    forRPKM[,colnames(forRPKM) %in% human_meta$fullID]->rpkm_human
    
    #Make log2 in KB:
    row.names(chlength)=chlength$Geneid
    chlength %>% select(-Geneid)->chlength
    as.matrix(chlength)->chlength
    
    row.names(hulength)=hulength$Geneid
    hulength %>% select(-Geneid)->hulength
    as.matrix(hulength)->hulength
    
    log2(hulength/1000)->l2hulength
    log2(chlength/1000)->l2chlength
    
    
    #Subtract out log2 kb:
    sweep(rpkm_chimp, 1,l2chlength,"-")->chimp_rpkm
    sweep(rpkm_human, 1,l2hulength,"-")->human_rpkm
    
    colnames(forRPKM)->column_order
    
    cbind(chimp_rpkm,human_rpkm)->vRPKMS
    #Put RPKMS back into the VOOM object:
    expr.obj$E <- (vRPKMS[,colnames(vRPKMS) %in% column_order])
    return(expr.obj)
  }
}

dge <- vRPKM(dge, chimp_lengths, human_lengths, group_ref) #Normalize via log2 RPKM.

#A typical low-expression filtering step: use default prior count adding (0.25), and filtering out anything that has fewer than half the individuals within each species having logCPM less than 1.5 (so want 2 humans AND 2 chimps with log2CPM >= 1.5)
lcpms <- cpm(dge$counts, log=TRUE) #Obtain log2CPM!
good.chimps <- which(rowSums(lcpms[,1:4]>=1.5)>=2) #Obtain good chimp indices
good.humans <- which(rowSums(lcpms[,5:8]>=1.5)>=2) #Obtain good human indices
filt <- good.humans[which(good.humans %in% good.chimps)] #Subsets us down to a solid 11,292 genes--will go for a similar percentage with RPKM cutoff vals! (25.6% of total)

#Repeat filtering step, this time on RPKMs. 0.4 was chosen as a cutoff as it obtains close to the same results as 1.5 lcpm (in terms of percentage of genes retained)
good.chimps <- which(rowSums(dge$E[,1:4]>=0.4)>=2) #Obtain good chimp indices.
good.humans <- which(rowSums(dge$E[,5:8]>=0.4)>=2) #Obtain good human indices.
RPKM_filt <- good.humans[which(good.humans %in% good.chimps)] #Still leaves us with 11,946 genes (27.1% of total)

#Do the actual filtering.
dge_filt <- dge[RPKM_filt,]
dge_filt$E <- dge$E[RPKM_filt,]
dge_filt$counts <- dge$counts[RPKM_filt,]
dge_final <- calcNormFactors(dge_filt, method="TMM") #Calculate normalization factors with trimmed mean of M-values (TMM).
dge_norm <- calcNormFactors(dge, method="TMM") #Calculate normalization factors with TMM on dge before filtering out lowly expressed genes, for normalization visualization.

#Quick visualization of the filtering I've just performed:
col <- brewer.pal(8, "Paired")
par(mfrow=c(1,2))
plot(density(dge$E[,1]), col=col[1], lwd=2, ylim=c(0,0.35), las=2, 
     main="", xlab="")
title(main="A. Raw data", xlab="Log-RPKM")
abline(v=1, lty=3)
for (i in 2:8){
 den <- density(dge$E[,i])
 lines(den$x, den$y, col=col[i], lwd=2)
}
legend("topright", colnames(dge$E[,1:8]), text.col=col, bty="n")

plot(density(dge_final$E[,1]), col=col[1], lwd=2, ylim=c(0,0.35), las=2, 
     main="", xlab="")
title(main="B. Filtered data", xlab="Log-RPKM")
abline(v=1, lty=3)
for (i in 2:8){
   den <- density(dge_final$E[,i])
   lines(den$x, den$y, col=col[i], lwd=2)
}
legend("topright", colnames(dge_final[,1:8]), text.col=col, bty="n")


#Quick visualization of the normalization on the whole set of genes.
col <- brewer.pal(8, "Paired")
raw <- as.data.frame(dge$E[,1:8])
normed <- as.data.frame(dge_norm$E[,1:8])
par(mfrow=c(1,2))
boxplot(raw, las=2, col=col, main="")
title(main="Unnormalized data",ylab="Log-RPKM")
boxplot(normed, las=2, col=col, main="")
title(main="Normalized data",ylab="Log-RPKM")

#Now, observe normalization on the filtered set of genes.
col <- brewer.pal(8, "Paired")
raw <- as.data.frame(dge_filt$E[,1:8])
normed <- as.data.frame(dge_final$E[,1:8])
par(mfrow=c(1,2))
boxplot(raw, las=2, col=col, main="")
title(main="Unnormalized data",ylab="Log-RPKM")
boxplot(normed, las=2, col=col, main="")
title(main="Normalized data",ylab="Log-RPKM")

#Now, do some quick MDS plotting to make sure this expression data separates out species properly.
species <- c("C", "C", "C", "C", "H", "H", "H", "H")
color <- c(rep("red", 4), rep("blue", 4))
par(mfrow=c(1,1))
plotMDS(dge_final$E[,1:8], labels=species, col=color, main="MDS Plot") #Shows separation of the species along the logFC dimension representing the majority of the variance--orthogonal check to PCA, and looks great!

###Now, apply voom to get quality weights.
meta.exp.data <- data.frame("SP"=c("C", "C", "C", "C", "H", "H", "H", "H"), "SX"=c("M","M" ,"F","F","F", "M","M","F"))
SP <- factor(meta.exp.data$SP,levels = c("H","C"))
exp.design <- model.matrix(~0+SP)#(~1+meta.exp.data$SP+meta.exp.data$SX)
colnames(exp.design) <- c("Human", "Chimp")
weighted.data <- voom(dge_final, exp.design, plot=TRUE, normalize.method = "cyclicloess")

##Obtain rest of LM results, with particular eye to DE table!
vfit <- lmFit(weighted.data, exp.design)
efit <- eBayes(vfit)

mycon <- makeContrasts(HvC = Human-Chimp, levels = exp.design)
diff_species <- contrasts.fit(efit, mycon)
finalfit <- eBayes(diff_species)
detable <- topTable(finalfit, coef = 1, adjust.method = "BH", number = Inf, sort.by="none")
plotSA(efit, main="Final model: Meanâˆ’variance trend")

#Get lists of the DE and non-DE genes so I can run separate analyses on them at any point.
DEgenes <- detable$genes[which(detable$adj.P.Val<=0.05)]
nonDEgenes <- detable$genes[-which(detable$adj.P.Val<=0.05)]

#Rearrange RPKM and weight columns in voom object to be similar to the rest of my setup throughout in other dataframes.
weighted.data$E <- weighted.data$E[,c(8, 6, 1, 4, 7, 5, 2, 3)]
weighted.data$weights <- weighted.data$weights[,c(8, 6, 1, 4, 7, 5, 2, 3)]
RPKM <- weighted.data$E
rownames(RPKM) <- NULL #Just to match what I had before on midway2, about to write this out.
saveRDS(RPKM, file="~/Desktop/Hi-C/HiC_covs/IEE.RPKM.RDS")
saveRDS(weighted.data, file="~/Desktop/Hi-C/HiC_covs/IEE_voom_object.RDS") #write this object out, can then be read in with readRDS.
```

###Overlap Between Hi-C Data and Orthogonal Gene Expression Data
In this section I find the overlap between the final filtered set of Hi-C significant hits and genes picked up on by an orthogonal RNA-seq experiment in the same set of cell lines. I utilize an in-house curated set of orthologous genes between humans and chimpanzees. Given that the resolution of the data is 10kb, I choose a simple and conservative approach and use a 1-nucleotide interval at the start of each gene as a proxy for the promoter. I then take a conservative pass and only use genes that had direct overlap with a bin from the Hi-C significant hits data, with more motivation explained below.
```{r Overlap between Hi-C data and orthogonal gene expression data}
#Now, read in filtered data from linear_modeling_QC.Rmd.
data.filtered <- fread("~/Desktop/Hi-C/data.4.filtered.txt", header=TRUE, data.table=FALSE, stringsAsFactors = FALSE, showProgress=FALSE)
meta.data <- data.frame("SP"=c("H", "H", "C", "C", "H", "H", "C", "C"), "SX"=c("F", "M", "M", "F", "M", "F", "M", "F"), "Batch"=c(1, 1, 1, 1, 2, 2, 2, 2))

#####GENE Hi-C Hit overlap: First, I obtain and rearrange the necessary files to get genes from both species and their overlaps with Hi-C bins.
#Read in necessary files: human and chimp orthologous genes from the meta ortho exon trios file. Then rearrange the columns of humgenes and chimpgenes to use group_by on them.
humgenes <- fread("~/Desktop/Hi-C/2017_July_ortho (1)/Human_orthoexon_extended_info.txt", stringsAsFactors = FALSE, header=TRUE, data.table=FALSE)
chimpgenes <- fread("~/Desktop/Hi-C/2017_July_ortho (1)/Chimp_orthoexon_extended_info.txt", stringsAsFactors = FALSE, header=TRUE, data.table=FALSE)
humgenes <- as.data.frame(humgenes[,c(1,5:8)])
chimpgenes <- as.data.frame(chimpgenes[,c(1,5:8)])
colnames(humgenes) <- c("genes", "Hchr", "Hstart", "Hend", "Hstrand")
colnames(chimpgenes) <- c("genes", "Cchr", "Cstart", "Cend", "Cstrand")
humgenes$Hchr <- paste("chr", humgenes$Hchr, sep="") #All properly formatted now!

#Bedtools groupby appears to have not worked properly to create files of single TSSs for genes from the meta ortho exons file, but this totally does! I've also utilized dplyr's group_by on the original file as well to ensure the same results. Now just making gene BED files that are 1-nt overlap at the very beginning of the first exon. Since I maintain strand information and will utilize it in bedtools closest-to, I am not concerned about whether the nt overlap goes the right direction or not.
group_by(humgenes, genes) %>% summarise(Hchr=unique(Hchr), Hstart=min(Hstart), Hstrand=unique(Hstrand)) -> humgenes
group_by(chimpgenes, genes) %>% summarise(Cchr=unique(Cchr), Cstart=min(Cstart), Cstrand=unique(Cstrand)) -> chimpgenes

#Now add in an extra column placeholder so strand is in the right column for bedtools, and rearrange columns as well for bedtools' ease.
humgenes$placeholder <- "."
chimpgenes$placeholder <- "."
humgenes$Hend <- humgenes$Hstart+1
chimpgenes$Cend <- chimpgenes$Cstart+1
humgenes <- humgenes[,c(2:3, 6, 1, 5, 4)]
chimpgenes <- chimpgenes[,c(2:3, 6, 1, 5, 4)]

#Turn off scientific notation for writing the file out for bedtools to be able to use correctly.
options(scipen=999)

#Now, prep bed files from the filtered data for each bin, in order to run bedtools-closest on them with the human and chimp gene data. This is for getting each bin's proximity to TSS by overlapping with the dfs just made (humgenes and chimpgenes). In the end this set of bedfiles is fairly useless, because really it would be preferable to get rid of duplicates so that I can merely group_by on a given bin afterwards and left_join as necessary. So somewhat deprecated, but I keep it here still:
hbin1 <- data.frame(chr=data.filtered$Hchr, start=as.numeric(gsub("chr.*-", "", data.filtered$H1)), end=as.numeric(gsub("chr.*-", "", data.filtered$H1))+10000)
hbin2 <- data.frame(chr=data.filtered$Hchr, start=as.numeric(gsub("chr.*-", "", data.filtered$H2)), end=as.numeric(gsub("chr.*-", "", data.filtered$H2))+10000)
cbin1 <- data.frame(chr=data.filtered$Cchr, start=as.numeric(gsub("chr.*-", "", data.filtered$C1)), end=as.numeric(gsub("chr.*-", "", data.filtered$C1))+10000)
cbin2 <- data.frame(chr=data.filtered$Cchr, start=as.numeric(gsub("chr.*-", "", data.filtered$C2)), end=as.numeric(gsub("chr.*-", "", data.filtered$C2))+10000)

#In most analyses, it will make more sense to have a single bed file for both sets of bins, and remove all duplicates. I create that here:
hbins <- rbind(hbin1[!duplicated(hbin1),], hbin2[!duplicated(hbin2),])
hbins <- hbins[!duplicated(hbins),]
cbins <- rbind(cbin1[!duplicated(cbin1),], cbin2[!duplicated(cbin2),])
cbins <- cbins[!duplicated(cbins),]

#Now, write all of these files out for analysis with bedtools.
write.table(hbin1, "~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/unsorted/hbin1.bed", quote = FALSE, sep="\t", row.names = FALSE, col.names=FALSE)
write.table(hbin2, "~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/unsorted/hbin2.bed", quote = FALSE, sep="\t", row.names = FALSE, col.names=FALSE)
write.table(cbin1, "~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/unsorted/cbin1.bed", quote = FALSE, sep="\t", row.names = FALSE, col.names=FALSE)
write.table(cbin2, "~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/unsorted/cbin2.bed", quote = FALSE, sep="\t", row.names = FALSE, col.names=FALSE)
write.table(humgenes, "~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/unsorted/humgenes.bed", quote=FALSE, sep="\t", row.names=FALSE, col.names=FALSE)
write.table(chimpgenes, "~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/unsorted/chimpgenes.bed", quote=FALSE, sep="\t", row.names=FALSE, col.names=FALSE)
write.table(hbins, "~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/unsorted/hbins.bed", quote=FALSE, sep="\t", row.names=FALSE, col.names=FALSE)
write.table(cbins, "~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/unsorted/cbins.bed", quote=FALSE, sep="\t", row.names=FALSE, col.names=FALSE)
options(scipen=0)

#Read in new, simpler bedtools closest files for genes. This is after running two commands, after sorting the files w/ sort -k1,1 -k2,2n in.bed > out.bed:
#bedtools closest -D a -a cgenes.sorted.bed -b cbins.sorted.bed > cgene.hic.overlap
#bedtools closest -D a -a hgenes.sorted.bed -b hbins.sorted.bed > hgene.hic.overlap
hgene.hic <- fread("~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/hgene.hic.overlap", header=FALSE, stringsAsFactors = FALSE, data.table=FALSE)
cgene.hic <- fread("~/Desktop/Hi-C/gene_expression/10kb_filt_overlaps/cgene.hic.overlap", header=FALSE, stringsAsFactors = FALSE, data.table=FALSE)


#Visualize the overlap of genes with bins and see how many genes we get back!
hum.genelap <- data.frame(overlap=seq(0, 100000, 1000), perc.genes = NA, tot.genes=NA)
for(row in 1:nrow(hum.genelap)){
  hum.genelap$perc.genes[row] <- sum(abs(hgene.hic$V10)<=hum.genelap$overlap[row])/length(hgene.hic$V10)
  hum.genelap$tot.genes[row] <- sum(abs(hgene.hic$V10)<=hum.genelap$overlap[row])
}

c.genelap <- data.frame(overlap=seq(0, 100000, 1000), perc.genes=NA, tot.genes=NA)
for(row in 1:nrow(c.genelap)){
  c.genelap$perc.genes[row] <- sum(abs(cgene.hic$V10)<=c.genelap$overlap[row])/length(cgene.hic$V10)
  c.genelap$tot.genes[row] <- sum(abs(cgene.hic$V10)<=c.genelap$overlap[row])
}
c.genelap$type <- "chimp"
hum.genelap$type <- "human"

#Examine what the potential gains are here if we are more lenient about the overlap/closeness to a TSS...
ggoverlap <- rbind(hum.genelap, c.genelap)
ggplot(data=ggoverlap) + geom_line(aes(x=overlap, y=perc.genes*100, color=type)) + ggtitle("Percent of Total Genes Picked Up | Min. Distance from TSS") + xlab("Distance from TSS") + ylab("Percentage of genes in ortho exon trios file (~44k)") + scale_color_discrete(guide=guide_legend(title="Species")) + coord_cartesian(xlim=c(0, 30000)) + scale_x_continuous(breaks=seq(0, 30000, 5000))
ggplot(data=ggoverlap) + geom_line(aes(x=overlap, y=tot.genes, color=type)) + ggtitle("Total # Genes Picked Up | Min. Distance from TSS") + xlab("Distance from TSS") + ylab("Total # of Genes Picked up On (of ~44k)") + scale_color_discrete(guide=guide_legend(title="Species")) + coord_cartesian(xlim=c(0, 30000)) + scale_x_continuous(breaks=seq(0, 30000, 5000))


#Start with a conservative pass--only take those genes that had an actual overlap with a bin, not ones that were merely close to one. Allowing some leeway to include genes that are within 1kb, 2kb, 3kb etc. of a Hi-C bin adds an average of ~800 genes per 1kb. We can also examine the distribution manually to motivate this decision:
quantile(abs(hgene.hic$V10), probs=seq(0, 1, 0.025))
quantile(abs(cgene.hic$V10), probs=seq(0, 1, 0.025))

#Note I looked at proportion of overlap with DE and with non-DE genes just for curiosity, and roughly 66% of the DE genes have overlap with a Hi-C bin while roughly 70% of the non-DE genes do. Since this result isn't particularly interesting I have collapsed that analysis here.
#Also are interested in seeing how this differs for DE and non-DE genes.
dehgene.hic <- hgene.hic[which(hgene.hic$V4 %in% DEgenes),]
decgene.hic <- cgene.hic[which(cgene.hic$V4 %in% DEgenes),]
nondehgene.hic <- hgene.hic[which(hgene.hic$V4 %in% nonDEgenes),]
nondecgene.hic <- cgene.hic[which(cgene.hic$V4 %in% nonDEgenes),]

sum(dehgene.hic$V10==0)
sum(nondehgene.hic$V10==0)
quantile(abs(dehgene.hic$V10), probs=seq(0, 1, 0.025))
quantile(abs(nondehgene.hic$V10), probs=seq(0, 1, 0.025))
```
And we can see that the majority of the genes (57.5%) have direct overlap with a bin. I'll thus start with one very conservative set with only genes that have direct overlap with a bin. Later I may return to this and add and another slightly more lenient bin capturing ~10% more of the genes by allowing +/- 5kb of wiggle room.


###Linear Modeling Annotation
In this next section I simply add information obtained from linear modeling on the Hi-C interaction frequencies to the appropriate genes having overlap with Hi-C bins. Because one Hi-C bin frequently shows up many times in the data, this means I must choose some kind of summary for Hi-C contact frequencies and linear modeling annotations for each gene. I toy with a variety of these summaries here, including choosing the minimum FDR contact, the maximum beta contact, the upstream contact, or summarizing all a bin's contacts with the weighted Z-combine method or median FDR values.
```{r Linear Modeling Annotation}
hgene.hic.overlap <- filter(hgene.hic, V10==0) #Still leaves a solid ~26k genes.
cgene.hic.overlap <- filter(cgene.hic, V10==0) #Still leaves a solid ~26k genes.

#Add a column to both dfs indicating where along a bin the gene in question is found (from 0-10k):
hgene.hic.overlap$bin_pos <- abs(hgene.hic.overlap$V8-hgene.hic.overlap$V2)
cgene.hic.overlap$bin_pos <- abs(cgene.hic.overlap$V8-cgene.hic.overlap$V2)

#Rearrange columns and create another column of the bin ID.
hgene.hic.overlap <- hgene.hic.overlap[,c(4, 7:9, 6, 11, 1:2)]
hgene.hic.overlap$HID <- paste(hgene.hic.overlap$V7, hgene.hic.overlap$V8, sep="-")
cgene.hic.overlap <- cgene.hic.overlap[,c(4, 7:9, 6, 11, 1:2)]
cgene.hic.overlap$CID <- paste(cgene.hic.overlap$V7, cgene.hic.overlap$V8, sep="-")
colnames(hgene.hic.overlap) <- c("genes", "HiC_chr", "H1start", "H1end", "Hstrand", "bin_pos", "genechr", "genepos", "HID")
colnames(cgene.hic.overlap) <- c("genes", "HiC_chr", "C1start", "C1end", "Cstrand", "bin_pos", "genechr", "genepos", "CID")
#Gets me an hfinal table with a lot of the information concatenated together--now need the same thing for chimps, only to get the n contacts (since this could differ!)
hbindf <- select(data.filtered, "H1", "H2", "ALLvar", "SE", "sp_beta", "sp_pval", "sp_BH_pval", "Hdist")
names(hbindf) <- c("HID", "HID2", "ALLvar", "SE", "sp_beta", "sp_pval", "sp_BH_pval", "distance") #I have confirmed that all the HID2s are higher numbered coordinates than the HID1s, the only instance in which this isn't the case is when the two bins are identical (this should have been filtered out long before now).

hbindf <- hbindf[(which(hbindf$dist!=0)),] #Removes pairs where the same bin represents both mates. These instances occur exclusively when liftOver of the genomic coordinates from one species to another, and the subsequent rounding to the nearest 10kb, results in a contact between adjacent bins in one species being mapped as a contact between the same bin in the other species. Because there are less than 50 instances of this total in the dataset I simply remove it here without further worry.

#Remembering that all the first mates in the pair are lower coordinates than the second mates:
#This works for getting the FDR of closest downstream hits for the first column. Technically this would also make these the closest upstream hits for any bins that are UNIQUE and NOT REPEATED to the second column. For unique bins in this column, they have no upstream hits, and this gets their downstream hits. I can do the same thing but on the second set of IDs to get the potential upstream hits for any bins, then do a full_join on the two to get everything! Many of these metrics need to be done on a duplicated df to ensure I have all copies of a bin in one column, but the upstream and downstream analyses need to be run separately.
group_by(hbindf, HID) %>% summarise(DS_bin=HID2[which.min(distance)], DS_FDR=sp_BH_pval[which.min(distance)], DS_dist=distance[which.min(distance)]) -> hbin1.downstream

group_by(hbindf, HID2) %>% summarise(US_bin=HID[which.min(distance)], US_FDR=sp_BH_pval[which.min(distance)], US_dist=distance[which.min(distance)]) -> hbin2.upstream
colnames(hbin2.upstream) <- c("HID", "US_bin", "US_FDR", "US_dist")

Hstreams <- full_join(hbin1.downstream, hbin2.upstream, by="HID")

#Now, need to create a df with all the hits duplicated (but columns reversed) to account for duplicated bins in each column. This is better for any analysis that shares information across the interactions (minimums, sums, means, medians, etc.)
hbindf.flip <- hbindf[,c(2, 1, 3:7)]
colnames(hbindf.flip)[1:2] <- c("HID", "HID2")
hbindf_x2 <- rbind(hbindf[,1:7], hbindf.flip) #It's worth noting that a version of this with duplicates removed would be very useful for enrichment analyses...

#Now, use group_by from dplyr to combine information for a given bin across all its Hi-C contacts. Here I'll be pulling out contact, p-value, and bin with minimum FDR, its beta; the median FDR; the maximum beta and its FDR and bin; and a weighted combination method for p-values for species from linear modeling. This is based off of (http://onlinelibrary.wiley.com/doi/10.1111/j.1420-9101.2005.00917.x/full) under the assumption $s2.post is the actual error variance. (forthcoming)
group_by(hbindf_x2, HID) %>% summarise(min_FDR_bin=HID2[which.min(sp_BH_pval)], min_FDR=min(sp_BH_pval), min_FDR_pval=sp_pval[which.min(sp_BH_pval)], min_FDR_B=sp_beta[which.min(sp_BH_pval)], median_FDR=median(sp_BH_pval),  weighted_Z.ALLvar=pnorm((sum((1/ALLvar)*((qnorm(1-sp_pval))))/sqrt(sum((1/ALLvar)^2))), lower.tail=FALSE), weighted_Z.s2post=pnorm(sum((1/(SE^2))*qnorm(1-sp_pval))/sqrt(sum(1/SE^2)), lower.tail=FALSE), fisher=-2*sum(log(sp_pval)), numcontacts=n(), max_B_bin=HID2[which.max(abs(sp_beta))], max_B_FDR=sp_BH_pval[which.max(abs(sp_beta))], max_B=sp_beta[which.max(abs(sp_beta))]) -> hbin.info

#Now, full_join the hbin.info and Hstreams dfs, incorporating all the information about the hbins in my data:
full_join(hbin.info, Hstreams, by="HID") -> hbin.full.info

#Now I combine the gene overlap tables and the full information tables for the human genes and bins!
left_join(hgene.hic.overlap, hbin.full.info, by="HID") -> humgenes.hic.full
colnames(humgenes.hic.full)[1:5] <- c("genes", "Hchr", "Hstart", "Hend", "Hstrand") #Fix column names for what was just created

###Now, do the whole thing over again for chimps, and then combine with the human gene overlap before joining on detable!
#Gets me a cfinal table with a lot of the information concatenated together.
cbindf <- select(data.filtered, "C1", "C2", "ALLvar", "SE", "sp_beta", "sp_pval", "sp_BH_pval", "Cdist") #Pulling out cols C1, C2, ALLvar, SE, sp_beta, sp_pval, sp_BH_pval, and Cdist
names(cbindf) <- c("CID", "CID2", "ALLvar", "SE", "sp_beta", "sp_pval", "sp_BH_pval", "distance") #I have confirmed that all the CID2s are higher numbered coordinates than the CID1s, the only instance in which this isn't the case is when the two bins are identical (this should have been filtered out long before now).

cbindf <- cbindf[(which(cbindf$dist!=0)),] #Removes rows from the cbindf that REALLY shouldn't be there to begin with. There are ~620 hits like this.

#Remembering that all the first mates in the pair are lower coordinates than the second mates:
#This works for getting the FDR of closest downstream hits for the first column. Technically this would also make these the closest upstream hits for any bins that are UNIQUE and NOT REPEATED to the second column. For unique bins in this column, they have no upstream hits, and this gets their downstream hits. I can do the same thing but on the second set of IDs to get the potential upstream hits for any bins, then do a full_join on the two to get everything! Many of these metrics need to be done on a duplicated df to ensure I have all copies of a bin in one column, but the upstream and downstream analyses need to be run separately.
group_by(cbindf, CID) %>% summarise(DS_bin=CID2[which.min(distance)], DS_FDR=sp_BH_pval[which.min(distance)], DS_dist=distance[which.min(distance)]) -> cbin1.downstream

group_by(cbindf, CID2) %>% summarise(US_bin=CID[which.min(distance)], US_FDR=sp_BH_pval[which.min(distance)], US_dist=distance[which.min(distance)]) -> cbin2.upstream
colnames(cbin2.upstream) <- c("CID", "US_bin", "US_FDR", "US_dist")

Cstreams <- full_join(cbin1.downstream, cbin2.upstream, by="CID")

#Now, need to create a df with all the hits duplicated (but columns reversed) to account for duplicated bins in each column. This is better for any analysis that shares information across the interactions (minimums, sums, means, medians, etc.)
cbindf.flip <- cbindf[,c(2, 1, 3:7)]
colnames(cbindf.flip)[1:2] <- c("CID", "CID2")
cbindf_x2 <- rbind(cbindf[,1:7], cbindf.flip)

#Group by again for chimp hits as was done for humans above.
group_by(cbindf_x2, CID) %>% summarise(min_FDR_bin=CID2[which.min(sp_BH_pval)], min_FDR=min(sp_BH_pval), min_FDR_B=sp_beta[which.min(sp_BH_pval)], median_FDR=median(sp_BH_pval), weighted_Z.ALLvar=pnorm((sum((1/ALLvar)*((qnorm(1-sp_pval))))/sqrt(sum((1/ALLvar)^2))), lower.tail=FALSE), weighted_Z.s2post=pnorm(sum((1/(SE^2))*qnorm(1-sp_pval))/sqrt(sum(1/SE^2)), lower.tail=FALSE), fisher=-2*sum(log(sp_pval)), numcontacts=n(), max_B_bin=CID2[which.max(abs(sp_beta))], max_B_FDR=sp_BH_pval[which.max(abs(sp_beta))], max_B=sp_beta[which.max(abs(sp_beta))]) -> cbin.info

#Now, full_join the cbin.info and Cstreams dfs, incorporating all the information about the cbins in my data:
full_join(cbin.info, Cstreams, by="CID") -> cbin.full.info

#Now I combine the gene overlap tables and the full information tables for the human genes and bins!
left_join(cgene.hic.overlap, cbin.full.info, by="CID") -> chimpgenes.hic.full
colnames(chimpgenes.hic.full)[1:5] <- c("genes", "Hchr", "Hstart", "Hend", "Hstrand") #Fix column names for what was just created

#Now, combine chimpgenes.hic.full and humgenes.hic.full before a final left_join on detable:
full_join(humgenes.hic.full, chimpgenes.hic.full, by="genes", suffix=c(".H", ".C")) -> genes.hic.info
left_join(detable, genes.hic.info, by="genes") -> gene.hic.overlap.info

#Clean this dataframe up, removing rows where there is absolutely no Hi-C information for the gene.
filt.indices <- rowSums(is.na(gene.hic.overlap.info)) #51 NA values are found when there is absolutely no Hi-C information.
filt.indices <- which(filt.indices==51)
gene.hic.filt <- gene.hic.overlap.info[-filt.indices,] #Still leaves a solid 8,174 genes. Note that I will have to choose human or chimp values here for many of these columns, as not all of the values are the same (and many are missing in one species relative to the other). In some cases, may be able to just take minimum or maximum value from either in order to get at what I want.
saveRDS(gene.hic.filt, "~/Desktop/Hi-C/gene.hic.filt.RDS")
```

###Differential Expression-Differential Hi-C Enrichment Analyses 
Now I look for enrichment of DHi-C in DE genes using a variety of different metrics to call DHi-C.
I now look to see if genes that are differentially expressed are also differential in Hi-C contacts (DHi-C). That is to say, are differentially expressed genes enriched in their overlapping bins for Hi-C contacts that are also differential between the species? To do this I utilize p-values from my prior linear modeling as well as previous RNA-seq analysis. I construct a function to calculate proportions of DE and DHi-C genes, as well as a function to plot this out in a variety of different ways.
```{r Differential Expression-Differential Hi-C Enrichment Analyses}
####Enrichment analyses!
#A function for calculating proportion of DE genes that are DHi-C under a variety of different paradigms. Accounts for when no genes are DHi-C and when all genes are DHi-C. Returns the proportion of DE genes that are also DHi-C, as well as the expected proportion based on conditional probability alone.
prop.calculator <- function(de.vec, hic.vec, i, k){
  my.result <- data.frame(prop=NA, exp.prop=NA, chisq.p=NA, Dneither=NA, DE=NA, DHiC=NA, Dboth=NA)
  bad.indices <- which(is.na(hic.vec)) #First obtain indices where Hi-C info is missing, if there are any, then remove from both vectors.
  if(length(bad.indices>0)){
  de.vec <- de.vec[-bad.indices]
  hic.vec <- hic.vec[-bad.indices]}
  de.vec <- ifelse(de.vec<=i, 1, 0)
  hic.vec <- ifelse(hic.vec<=k, 1, 0)
  if(sum(hic.vec, na.rm=TRUE)==0){#The case where no genes show up as DHi-C.
    my.result[1,] <- c(0, 0, 0, sum(de.vec==0, na.rm=TRUE), sum(de.vec==1, na.rm=TRUE), 0, 0) #Since no genes are DHi-C, the proportion is 0 and our expectation is 0, set p-val=0 since it's irrelevant.
  }
  else if(sum(hic.vec)==length(hic.vec)){ #The case where every gene shows up as DHi-C
    my.result[1,] <- c(1, 1, 0, 0, 0, sum(hic.vec==1&de.vec==0, na.rm = TRUE), sum(de.vec==1&hic.vec==1, na.rm=TRUE)) #If every gene is DHi-C, the observed proportion of DE genes DHi-C is 1, and the expected proportion of DE genes also DHi-C would also be 1 (all DE genes are DHi-C, since all genes are). Again set p-val to 0 since irrelevant comparison.
  }
  else{#The typical case, where we get an actual table
    mytable <- table(as.data.frame(cbind(de.vec, hic.vec)))
    my.result[1,1] <- mytable[2,2]/sum(mytable[2,]) #The observed proportion of DE genes that are also DHi-C. # that are both/total # DE
    my.result[1,2] <- (((sum(mytable[2,])/sum(mytable))*((sum(mytable[,2])/sum(mytable))))*sum(mytable))/sum(mytable[2,]) #The expected proportion: (p(DE) * p(DHiC)) * total # genes / # DE genes
    my.result[1,3] <- chisq.test(mytable)$p.value
    my.result[1,4] <- mytable[1,1]
    my.result[1,5] <- mytable[2,1]
    my.result[1,6] <- mytable[1,2]
    my.result[1,7] <- mytable[2,2]
  }
  return(my.result)
}

#This is a function that computes observed and expected proportions of DE and DHiC enrichments,  and spits out a variety of different visualizations for them. As input it takes a dataframe, the names of its DHiC and DE p-value columns, and a name to represent the type of Hi-C contact summary for the gene that ends up on the x-axis of all the plots.
enrichment.plotter <- function(df, HiC_col, DE_col, xlab, xmax=0.3, i=c(0.01, 0.025, 0.05, 0.075, 0.1), k=seq(0.01, 1, 0.01)){
  enrich.table <- data.frame(DEFDR = c(rep(i[1], 100), rep(i[2], 100), rep(i[3], 100), rep(i[4], 100), rep(i[5], 100)), DHICFDR=rep(k, 5), prop.obs=NA, prop.exp=NA, chisq.p=NA, Dneither=NA, DE=NA, DHiC=NA, Dboth=NA)
  for(de.FDR in i){
    for(hic.FDR in k){
      enrich.table[which(enrich.table$DEFDR==de.FDR&enrich.table$DHICFDR==hic.FDR), 3:9] <- prop.calculator(df[,DE_col], df[,HiC_col], de.FDR, hic.FDR)
    }
  }
  des.enriched <- ggplot(data=enrich.table, aes(x=DHICFDR, y=prop.obs, group=as.factor(DEFDR), color=as.factor(DEFDR))) +geom_line()+ geom_line(aes(y=prop.exp), linetype="dashed", size=0.5) + ggtitle("Enrichment of DC in DE Genes") + xlab(xlab) + ylab("Proportion of DE genes that are DC") + guides(color=guide_legend(title="FDR for DE Genes"))
  dhics.enriched <- ggplot(data=enrich.table, aes(x=DHICFDR, y=Dboth/(Dboth+DHiC), group=as.factor(DEFDR), color=as.factor(DEFDR))) + geom_line() + geom_line(aes(y=(((((DE+Dboth)/(Dneither+DE+DHiC+Dboth))*((DHiC+Dboth)/(Dneither+DE+DHiC+Dboth)))*(Dneither+DE+DHiC+Dboth))/(DHiC+Dboth))), linetype="dashed") + ylab("Proportion of DC genes that are DE") +xlab(xlab) + ggtitle("Enrichment of DE in DC Genes") + coord_cartesian(xlim=c(0, xmax)) + guides(color=guide_legend(title="DE FDR"))
  joint.enriched <- ggplot(data=enrich.table, aes(x=DHICFDR, y=Dboth/(Dneither+DE+DHiC+Dboth), group=as.factor(DEFDR), color=as.factor(DEFDR))) + geom_line() + ylab("Proportion of ALL Genes both DE & DHi-C") + xlab(xlab) + geom_line(aes(y=((DE+Dboth)/(Dneither+DE+DHiC+Dboth))*((DHiC+Dboth)/(Dneither+DE+DHiC+Dboth))), linetype="dashed") + ggtitle("Enrichment of Joint DE & DHi-C in All Genes")
  chisq.p <- ggplot(data=enrich.table, aes(x=DHICFDR, y=-log10(chisq.p), group=as.factor(DEFDR), color=as.factor(DEFDR))) + geom_point() + geom_hline(yintercept=-log10(0.05), color="red") + ggtitle("Chi-squared Test P-values for Enrichment of DC in DE Genes") + xlab(xlab) + ylab("-log10(chi-squared p-values)") + coord_cartesian(xlim=c(0, xmax)) + guides(color=guide_legend(title="DE FDR"))
  print(des.enriched)
  print(dhics.enriched)
  print(joint.enriched)
  print(chisq.p)
  print(enrich.table[which(enrich.table$DEFDR==0.025),]) #Added to figure out comparison for the paper.
}

#Visualization of enrichment of DE/DC in one another. For most of these, using the gene.hic.filt df is sufficient as their Hi-C FDR numbers are the same. For the upstream genes it's a little more complicated because gene.hic.filt doesn't incorporate strand information on the genes, so use the specific US dfs for that, with the USFDR column.
enrichment.plotter(gene.hic.filt, "min_FDR.H", "adj.P.Val", "Minimum FDR of Hi-C Contacts Overlapping Gene", xmax=1)
enrichment.plotter(gene.hic.filt, "min_FDR.C", "adj.P.Val", "Minimum FDR of Hi-C Contacts Overlapping Gene, Chimp")
#enrichment.plotter(h_US, "USFDR", "adj.P.Val", "FDR for Closest Upstream Hi-C Contact Overlapping Gene, Human") #These two are ugly, and can't be run anyway until next chunk is complete to create their DFs. It's OK without them.
#enrichment.plotter(c_US, "USFDR", "adj.P.Val", "FDR for Closest Upstream Hi-C Contact Overlapping Gene, Chimp")
enrichment.plotter(gene.hic.filt, "max_B_FDR.H", "adj.P.Val", "FDR for Hi-C Contact Overlapping Gene w/ Strongest Effect Size, Human")
enrichment.plotter(gene.hic.filt, "max_B_FDR.C", "adj.P.Val", "FDR for Hi-C Contact Overlapping Gene w/ Strongest Effect Size, Chimp")
enrichment.plotter(gene.hic.filt, "median_FDR.H", "adj.P.Val", "Median FDR of Hi-C Contacts Overlapping Gene, Human")
enrichment.plotter(gene.hic.filt, "median_FDR.C", "adj.P.Val", "Median FDR of Hi-C Contacts Overlapping Gene, Chimp")
enrichment.plotter(gene.hic.filt, "weighted_Z.s2post.H", "adj.P.Val", "FDR for Weighted p-val Combine of Hi-C Contacts Overlapping Gene, Human")
enrichment.plotter(gene.hic.filt, "weighted_Z.s2post.C", "adj.P.Val", "FDR for Weighted p-val Combine of Hi-C Contacts Overlapping Gene, Chimp")
enrichment.plotter(gene.hic.filt, "weighted_Z.ALLvar.H", "adj.P.Val", "FDR for Weighted p-val Combine of Hi-C Contacts Overlapping Gene", xmax=1)
enrichment.plotter(gene.hic.filt, "weighted_Z.ALLvar.C", "adj.P.Val", "FDR for Weighted p-val Combine of Hi-C Contacts Overlapping Gene, Chimp")
```
Now that I've seen some enrichment of differential contact (DC) in differential expression (DE) based on my linear modeling results from before, I would like to further quantify this effect. In order to do so, I now extract log2 observed/expected homer-normalized contact frequency values and RPKM expression values for each gene/bin set, so I can look at correlations of these values and assess their explanatory power.

###Contact Frequency Extraction
In this section, I proceed to create a function in order to extract the Hi-C interaction frequency values for the different types of summaries I've made gene overlaps with above. This allows for operations to be performed separately utilizing different summaries of Hi-C contacts.
```{r Contact frequency extraction}
#Get a df with the H and C coordinates of the hits, and the IF values from homer. This subset df makes things easier to extract.
contacts <- data.frame(h1=data.filtered$H1, h2=data.filtered$H2, c1=data.filtered$C1, c2=data.filtered$C2, A_21792_HIC=data.filtered$`A-21792_norm`, B_28126_HIC=data.filtered$`B-28126_norm`, C_3649_HIC=data.filtered$`C-3649_norm`, D_40300_HIC=data.filtered$`D-40300_norm`, E_28815_HIC=data.filtered$`E-28815_norm`, F_28834_HIC=data.filtered$`F-28834_norm`, G_3624_HIC=data.filtered$`G-3624_norm`, H_3651_HIC=data.filtered$`H-3651_norm`, stringsAsFactors = FALSE)

#Now ensure first member of a pair is always lower than second:
newH1 <- as.numeric(gsub(".*-", "", contacts$h1))
newH2 <- as.numeric(gsub(".*-", "", contacts$h2))
lower.HID <- ifelse(newH1<newH2, contacts$h1, contacts$h2)
higher.HID2 <- ifelse(newH1<newH2, contacts$h2, contacts$h1)
contacts$hpair <- paste(lower.HID, higher.HID2, sep="_")

newC1 <- as.numeric(gsub(".*-", "", contacts$c1))
newC2 <- as.numeric(gsub(".*-", "", contacts$c2))
lower.CID <- ifelse(newC1<newC2, contacts$c1, contacts$c2)
higher.CID2 <- ifelse(newC1<newC2, contacts$c2, contacts$c1)
contacts$cpair <- paste(lower.CID, higher.CID2, sep="_")

#A function that takes a dataframe (like gene.hic.filt) and two columns from the dataframe to create a pair vector for the given interaction. First ensures the first bin in a pair is always lowest to make this easier. Then extracts the IF values for that vector from the contacts df created above. This provides me with the appropriate Hi-C data values for the different bin classes we're examining here, so that I can later test them with linear modeling to quantify their effect on expression.
IF.extractor <- function(dataframe, col1, col2, contacts, species, strand=FALSE){
  new1 <- as.numeric(gsub(".*-", "", dataframe[,col1]))
  if(strand==FALSE){#In the case where I'm not worried about strand, I just work with the second column selected.
    new2 <- as.numeric(gsub(".*-", "", dataframe[,col2]))
    lower1 <- ifelse(new1<new2, dataframe[,col1], dataframe[,col2])
    higher2 <- ifelse(new1<new2, dataframe[,col2], dataframe[,col1]) #Fix all the columns first
    if(species=="H"){ #Then depending on species create the pair column and merge to contact info.
      dataframe[,"hpair"] <- paste(lower1, higher2, sep="_")
      finaldf <- left_join(dataframe, contacts[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "hpair")], by="hpair")
    }
    else if(species=="C"){
      dataframe[,"cpair"] <- paste(lower1, higher2, sep="_")
      finaldf <- left_join(dataframe, contacts[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "cpair")], by="cpair")
    }
  }
  else if(strand==TRUE){#If dealing with upstream and downstream hits, need to do things separately for genes on the + and - strand.
    if(species=="H"){
      US <- ifelse(dataframe[,"Hstrand.H"]=="+", dataframe[,"US_bin.H"], dataframe[,"DS_bin.H"]) #Obtain upstream bins depending on strand.
      new2 <- as.numeric(gsub(".*-", "", US)) #Now rearrange the pairs to ensure regardless of stream we can find the pair (first mate lower coordinates than 2nd).
      lower1 <- ifelse(new1<new2, dataframe[,col1], US)
      higher2 <- ifelse(new1<new2, US, dataframe[,col1])
      dataframe[,"hpair"] <- paste(lower1, higher2, sep="_")
      dataframe[,"USFDR"] <- ifelse(dataframe[,"Hstrand.H"]=="+", dataframe[,"US_FDR.H"], dataframe[,"DS_FDR.H"])
      finaldf <- left_join(dataframe, contacts[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "hpair")], by="hpair")
    }
    else if(species=="C"){
      US <- ifelse(dataframe[,"Hstrand.C"]=="+", dataframe[,"US_bin.C"], dataframe[,"DS_bin.C"]) #Obtain upstream bins depending on strand.
      new2 <- as.numeric(gsub(".*-", "", US)) #Now rearrange the pairs to ensure regardless of stream we can find the pair (first mate lower coordinates than 2nd).
      lower1 <- ifelse(new1<new2, dataframe[,col1], US)
      higher2 <- ifelse(new1<new2, US, dataframe[,col1])
      dataframe[,"cpair"] <- paste(lower1, higher2, sep="_")
      dataframe[,"USFDR"] <- ifelse(dataframe[,"Hstrand.C"]=="+", dataframe[,"US_FDR.C"], dataframe[,"DS_FDR.C"])
      finaldf <- left_join(dataframe, contacts[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "cpair")], by="cpair")
    }
  }
  #before finally returning, remove rows where we don't have full Hi-C data.
  finaldf <- finaldf[complete.cases(finaldf[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC")]),]
  return(finaldf)
}

#Now I can use the IF.extractor function to make a number of different dataframes for actually testing different IF values with the RPKM expression values.
h_minFDR <- IF.extractor(gene.hic.filt, "HID", "min_FDR_bin.H", contacts, "H")
c_minFDR <- IF.extractor(gene.hic.filt, "CID", "min_FDR_bin.C", contacts, "C")
h_maxB <- IF.extractor(gene.hic.filt, "HID", "max_B_bin.H", contacts, "H")
c_maxB <- IF.extractor(gene.hic.filt, "CID", "max_B_bin.C", contacts, "C")
h_US <- IF.extractor(gene.hic.filt, "HID", "US_bin.H", contacts, "H", TRUE)
c_US <- IF.extractor(gene.hic.filt, "CID", "US_bin.C", contacts, "C", TRUE)

#Write these out so they can be permuted upon on midway2.
fwrite(h_minFDR, "~/Desktop/Hi-C/HiC_covs/h_minFDR", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(c_minFDR, "~/Desktop/Hi-C/HiC_covs/c_minFDR", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(h_maxB, "~/Desktop/Hi-C/HiC_covs/h_maxB", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(c_maxB, "~/Desktop/Hi-C/HiC_covs/c_maxB", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(h_US, "~/Desktop/Hi-C/HiC_covs/h_US", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(c_US, "~/Desktop/Hi-C/HiC_covs/c_US", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)

#Now the same thing, but subsetting down to ONLY the genes that show evidence for DE at 5% FDR.
h_minFDR_DE <- filter(h_minFDR, adj.P.Val<=0.05)
c_minFDR_DE <- filter(c_minFDR, adj.P.Val<=0.05)
h_maxB_DE <- filter(h_maxB, adj.P.Val<=0.05)
c_maxB_DE <- filter(c_maxB, adj.P.Val<=0.05)
h_US_DE <- filter(h_US, adj.P.Val<=0.05)
c_US_DE <- filter(c_US, adj.P.Val<=0.05)

fwrite(h_minFDR_DE, "~/Desktop/Hi-C/HiC_covs/h_minFDR_DE", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(c_minFDR_DE, "~/Desktop/Hi-C/HiC_covs/c_minFDR_DE", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(h_maxB_DE, "~/Desktop/Hi-C/HiC_covs/h_maxB_DE", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(c_maxB_DE, "~/Desktop/Hi-C/HiC_covs/c_maxB_DE", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(h_US_DE, "~/Desktop/Hi-C/HiC_covs/h_US_DE", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
fwrite(c_US_DE, "~/Desktop/Hi-C/HiC_covs/c_US_DE", quote = FALSE, sep = "\t", na = "NA", col.names = TRUE)
```
Now I use these data frames and join each again on the RPKM table by genes, in order to obtain RPKM expression values for each gene-Hi-C bin set.


###Merging contact frequency values with expression values.
In this next section I join each of the data frames created above on the RPKM table by genes, in order to have a merged table with expression values and contact frequencies for each gene-Hi-C bin set. I move then to explore correlations between the values.
```{r Merging Expression and Hi-C; Followed by correlation exploration}
#Join all of the previously-made Hi-C interaction frequency tables to the RPKM table by genes, to obtain RPKM values in concert with contact frequency values.
RPKM <- as.data.frame(weighted.data$E)
RPKM$genes <- rownames(RPKM)
hmin <- left_join(h_minFDR, RPKM, by="genes")
cmin <- left_join(c_minFDR, RPKM, by="genes")
hmaxB <- left_join(h_maxB, RPKM, by="genes")
cmaxB <- left_join(c_maxB, RPKM, by="genes")
hUS <- left_join(h_US, RPKM, by="genes")
cUS <- left_join(c_US, RPKM, by="genes")

#Get the same thing filtered for only DE genes.
hminDE <- filter(hmin, adj.P.Val<=0.05)
cminDE <- filter(cmin, adj.P.Val<=0.05)
hmaxBDE <- filter(hmaxB, adj.P.Val<=0.05)
cmaxBDE <- filter(cmaxB, adj.P.Val <=0.05)
hUSDE <- filter(hUS, adj.P.Val<=0.05)
cUSDE <- filter(cUS, adj.P.Val<=0.05)

hmin_noDE <- filter(hmin, adj.P.Val>0.05) #Pull out specific set of non-DE hits.

#Extract contacts and expression for the contact with the lowest FDR from linear modeling.
mycontacts <- hmin[,61:68]
myexprs <- hmin[,69:76]
DEcontacts <- hminDE[,61:68]
DEexprs <- hminDE[,69:76]
nonDEcontacts <- hmin_noDE[,61:68]
nonDEexprs <- hmin_noDE[,69:76]

#Extract contacts and expression stratified by mean interspecies expression quantiles.
quant1contactexpr <- filter(hmin, AveExpr<=quantile(hmin$AveExpr)[2]) %>% select(., A_21792_HIC, B_28126_HIC, C_3649_HIC, D_40300_HIC, E_28815_HIC, F_28834_HIC, G_3624_HIC, H_3651_HIC, "A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")
quant2contactexpr <- filter(hmin, AveExpr>quantile(hmin$AveExpr)[2]&AveExpr<=quantile(hmin$AveExpr)[3]) %>% select(., A_21792_HIC, B_28126_HIC, C_3649_HIC, D_40300_HIC, E_28815_HIC, F_28834_HIC, G_3624_HIC, H_3651_HIC, "A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")
quant3contactexpr <- filter(hmin, AveExpr>quantile(hmin$AveExpr)[3]&AveExpr<=quantile(hmin$AveExpr)[4]) %>% select(., A_21792_HIC, B_28126_HIC, C_3649_HIC, D_40300_HIC, E_28815_HIC, F_28834_HIC, G_3624_HIC, H_3651_HIC, "A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")
quant4contactexpr <- filter(hmin, AveExpr>quantile(hmin$AveExpr)[4]&AveExpr<=quantile(hmin$AveExpr)[5]) %>% select(., A_21792_HIC, B_28126_HIC, C_3649_HIC, D_40300_HIC, E_28815_HIC, F_28834_HIC, G_3624_HIC, H_3651_HIC, "A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")

#Function for calculating gene-wise correlations.
cor.calc <- function(hicdata, exprdata){
  cor.exp <- vector(length=nrow(hicdata))
  for(i in 1:nrow(hicdata)){
    cor.exp[i] <- cor(as.numeric(hicdata[i,]), as.numeric(exprdata[i,]))
  }
  return(cor.exp)
}

#Calculate correlations for different sets! I've commented out the species-specific calculations here because they just aren't that interesting. If you look at DE dynamics within each species you do NOT get a gorgeous bimodal as you do for across--looks more uniform and messy.
fullcors <- data.frame(cor=cor.calc(mycontacts, myexprs), type="all")
fullDEcors <- data.frame(cor=cor.calc(DEcontacts, DEexprs), type="DE")
fullnoDEcors <- data.frame(cor=cor.calc(nonDEcontacts, nonDEexprs), type="non-DE")
quant1cor <- data.frame(cor=cor.calc(quant1contactexpr[,1:8], quant1contactexpr[,9:16]), type="quant1")
quant2cor <- data.frame(cor=cor.calc(quant2contactexpr[,1:8], quant2contactexpr[,9:16]), type="quant2")
quant3cor <- data.frame(cor=cor.calc(quant3contactexpr[,1:8], quant3contactexpr[,9:16]), type="quant3")
quant4cor <- data.frame(cor=cor.calc(quant4contactexpr[,1:8], quant4contactexpr[,9:16]), type="quant4")
# humcors <- data.frame(cor=cor.calc(mycontacts[,c(1:2, 5:6)], myexprs[,c(1:2, 5:6)]), type="h_ALL")
# humDEcors <- data.frame(cor=cor.calc(DEcontacts[,c(1:2, 5:6)], DEexprs[,c(1:2, 5:6)]), type="h_DE")
# humnoDEcors <- data.frame(cor=cor.calc(nonDEcontacts[,c(1:2, 5:6)], nonDEexprs[,c(1:2, 5:6)]), type="h_non-DE")
# chimpcors <- data.frame(cor=cor.calc(mycontacts[,c(3:4, 7:8)], myexprs[,c(3:4, 7:8)]), type="c_ALL")
# chimpDEcors <- data.frame(cor=cor.calc(DEcontacts[,c(3:4, 7:8)], DEexprs[,c(3:4, 7:8)]), type="c_DE")
# chimpnoDEcors <- data.frame(cor=cor.calc(nonDEcontacts[,c(3:4, 7:8)], nonDEexprs[,c(3:4, 7:8)]), type="c_non-DE")

#Combine these dfs to plot in one gorgeous ggplot!
ggcors <- rbind(fullcors, fullDEcors, fullnoDEcors, quant1cor, quant2cor, quant3cor, quant4cor)#, humcors, humDEcors, humnoDEcors, chimpcors, chimpDEcors, chimpnoDEcors)

#First without the expression quantiles, then with.
ggplot(data=filter(ggcors, type=="all"|type=="DE"|type=="non-DE")) + stat_density(aes(x=cor, group=type, color=type, y=..scaled..), position="identity", geom="line") + ggtitle("Correlation b/t RPKM Expression and Hi-C Contact Frequency") + xlab("Pearson Correlations b/t RPKM Expression and Hi-C Contact Frequency") + ylab("Density") + scale_color_manual("Gene Set", values=c("red", "blue", "green"), labels=c("All genes", "DE genes", "non-DE genes"))
ggplot(data=ggcors) + stat_density(aes(x=cor, group=type, color=type, y=..scaled..), position="identity", geom="line") + ggtitle("Correlation b/t RPKM Expression and Hi-C Contact Frequency") + xlab("Pearson Correlations b/t RPKM Expression and Hi-C Contact Frequency") + ylab("Density") + scale_color_manual("Gene Set", values=c("red", "blue", "green", "purple", "orange", "yellow", "brown"), labels=c("All genes", "DE genes", "non-DE genes", "expression.quant1", "expression.quant2", "expression.quant3", "expression.quant4"))
###This looks great, showing strong bimodal distribution for the DE genes and broader distributions with a peak at 0 for the non-DE set and the full set. Also see no difference in terms of the distribution of correlations on individual sets of genes stratified by quantiles of expression (mean b/t species). Note that I've done that on just DE genes as well and see slightly shorter peaks on the bimodality for the middle quantiles of expression, which makes sense (extreme unlikely to be as severe b/t species). Also, to assess if this is legit at all, I now re-run this correlation analysis after permuting the Hi-C values. I shuffle sample IDs on a gene-by-gene basis to accomplish this:
cor.permuter <- function(hicdata, exprdata, nperm){
  result <- data.frame(cor=NA, type=rep(1:nperm, each=nrow(exprdata)))
  for(perm in 1:nperm){
    permute <- hicdata
    for(row in 1:nrow(hicdata)){
      permute[row,] <- sample(hicdata[row,])
    }
    myindices <- which(result$type==perm)
    result[myindices,1] <- cor.calc(permute, exprdata)
  }
  return(result)
}

#Just do it with 10 permutations to see the general effect quickly:
full.perm <- cor.permuter(mycontacts, myexprs, 10)
DE.perm <-  cor.permuter(DEcontacts, DEexprs, 10)
nonDE.perm <- cor.permuter(nonDEcontacts, nonDEexprs, 10)

#Now visualize.
ggplot(data=filter(ggcors, type=="all"|type=="DE"|type=="non-DE")) + stat_density(aes(x=cor, group=type, color=type, y=..scaled..), position="identity", geom="line") + stat_density(data=full.perm, aes(x=cor, group=type), geom="line", linetype="dotted", position="identity") + stat_density(data=DE.perm, aes(x=cor, group=type), geom="line", linetype="dashed", position="identity") + stat_density(data=nonDE.perm, aes(x=cor, group=type), geom="line", linetype="twodash", position="identity") + ggtitle("Correlation b/t RPKM Expression and Hi-C Contact Frequency") + xlab("Pearson Correlations b/t RPKM Expression and Hi-C Contact Frequency") + ylab("Density") + scale_color_manual("Gene Set", values=c("red", "blue", "green"), labels=c("All genes", "DE genes", "non-DE genes"))
#See that permuted datasets have a tighter correlation distribution with a strong peak at 0. Reassuring. In the future I will repeat this analysis on Midway2, running 10000 permutations to see the full range of permuted data possible.

####Deprecated, for use in species-specific analysis.
# plotfull <- data.frame(fullcors=fullcors, Hcors=humcors, Ccors=chimpcors)
# plotDE <- data.frame(fullcors=fullDEcors[,1], Hcors=humDEcors[,1], Ccors=chimpDEcors[,1])
# 
# ggplot(data=plotfull) + stat_density(aes(x=fullcors), geom="line") + xlab("Pearson Correlations b/t RPKM Expression and Hi-C Contact Frequency") + ylab("Density") + ggtitle("Correlations between Hi-C and Expression, all genes")
# ggplot(data=plotfull) + stat_density(aes(x=Hcors), geom="line") + xlab("Pearson Correlations b/t RPKM Expression and Hi-C Contact Frequency") + ylab("Density") + ggtitle("Correlations between Hi-C and Expression, all genes, Humans")
# ggplot(data=plotfull) + stat_density(aes(x=Ccors), geom="line") + xlab("Pearson Correlations b/t RPKM Expression and Hi-C Contact Frequency") + ylab("Density") + ggtitle("Correlations between Hi-C and Expression, all genes, Chimps")
# 
# ggplot(data=plotDE) + stat_density(aes(x=fullcors), geom="line") + xlab("Pearson Correlations b/t RPKM Expression and Hi-C Contact Frequency") + ylab("Density") + ggtitle("Correlations between Hi-C and Expression, DE genes")
# ggplot(data=plotDE) + stat_density(aes(x=Hcors), geom="line") + xlab("Pearson Correlations b/t RPKM Expression and Hi-C Contact Frequency") + ylab("Density") + ggtitle("Correlations between Hi-C and Expression, DE genes, Humans")
# ggplot(data=plotDE) + stat_density(aes(x=Ccors), geom="line") + xlab("Pearson Correlations b/t RPKM Expression and Hi-C Contact Frequency") + ylab("Density") + ggtitle("Correlations between Hi-C and Expression, DE genes, Chimps")
```
Now that I've seen some nice effects in the correlation between expression and contact for different sets of genes, and for permutations on those sets, I move to see what kind of quantitiative explanatory power differential contact (DC) might actually have for differential expression (DE).

###How well does Hi-C data explain expression data?
In this next section I "regress out" the effect of Hi-C contacts from their overlapping genes' RPKM expression values, comparing a linear model run on the base values to one run on the residuals of expression after regressing out Hi-C data. Comparing the p-values before and after this regression can give some sense of whether the DE is being driven by differential Hi-C contacts (DC).
```{r Mediation effect by "regressing out" Hi-C effects from Expression Data}
###A function to calculate gene-wise correlations between Hi-C data and expression data, but for spearman correlations. Pearson correlation calculator function is in the chunk above.
cor.calc.spear <- function(hicdata, exprdata){
  cor.exp <- vector(length=nrow(hicdata))
  for(i in 1:nrow(hicdata)){
    cor.exp[i] <- cor(as.numeric(hicdata[i,]), as.numeric(exprdata[i,]), method="spearman")
  }
  return(cor.exp)
}

###A function to permute a Hi-C df by going gene-by-gene (row-by-row) and shuffling all sample IDs.
shuffler <- function(hicdata){
	for(row in 1:nrow(hicdata)){
      hicdata[row,] <- sample(hicdata[row,])
    }
    return(hicdata)
}

###A function that runs a linear model, both with and without Hi-C corrected expression values, and returns a dataframe of hit classes (DE or not before and after correction). Also spits back out p-values before and after correction, as well as correlations between Hi-C data and expression data. Since the former is a one-row data frame of 4 points and the latter is a 3-column data frame with the number of genes rows, returns a list.
lmcorrect <- function(voom.obj, exprs, cov_matrix, meta_df){
  mygenes <- cov_matrix$genes #Pull out the relevant genes here; used for subsetting the voom.obj in a bit.
  cov_matrix <- cov_matrix[, -9] #Remove genes from the cov matrix
  hic_present <- sapply(1:nrow(cov_matrix), function(i) !any(is.na(cov_matrix[i,]))) #First, remove any rows w/ missing Hi-C data.
  exprs <- data.matrix(exprs[hic_present,]) #Filter expression with this
  cov_matrix <- data.matrix(cov_matrix[hic_present,]) #Filter Hi-C data with this
  
  #Now, prepare to run the actual models. First run a model w/ Hi-C as a covariate to evaluate
  SP <- factor(meta_df$SP,levels = c("H","C"))
  design <- model.matrix(~0+SP)
  colnames(design) <- c("Human", "Chimp")
  resid_hic <- array(0, dim=c(nrow(exprs), ncol(cov_matrix))) #Initialize a dataframe for storing the residuals.
  for(i in 1:nrow(exprs)){#Loop through rows of the expression df, running linear modeling w/ Hi-C to obtain residuals.
   resid_hic[i,] <- lm(exprs[i,]~cov_matrix[i,])$resid 
  }
  
  mycon <- makeContrasts(HvC = Human-Chimp, levels = design)
  
  #Filter the voom object to only contain genes that had Hi-C information here.
  good.indices <- which(rownames(voom.obj$E) %in% mygenes)
  voom.obj <- voom.obj[good.indices,]
  
  #Now, replace the RPKM values in the voom object for after linear modeling with the residuals.
  voom.obj.after <- voom.obj
  voom.obj.after$E <- resid_hic
  
  lmFit(voom.obj, design=design) %>% eBayes(.) %>% contrasts.fit(., mycon) %>% eBayes(.) %>% topTable(., coef = 1, adjust.method = "BH", number = Inf, sort.by="none") -> fit_before
  lmFit(voom.obj.after, design=design) %>% eBayes(.) %>% contrasts.fit(., mycon) %>% eBayes(.) %>% topTable(., coef = 1, adjust.method = "BH", number = Inf, sort.by="none") -> fit_after

  result.DE.cats <- data.frame(DEneither=sum(fit_before$adj.P.Val>0.05&fit_after$adj.P.Val>0.05), DEbefore=sum(fit_before$adj.P.Val<=0.05&fit_after$adj.P.Val>0.05), DEafter=sum(fit_before$adj.P.Val>0.05&fit_after$adj.P.Val<=0.05), DEboth=sum(fit_before$adj.P.Val<=0.05&fit_after$adj.P.Val<=0.05))
  result.DE.stats <- data.frame(cor.pear=cor.calc(cov_matrix, exprs), cor.spear=cor.calc.spear(cov_matrix, exprs), pval.before=fit_before$adj.P.Val, pval.after=fit_after$adj.P.Val)
  result <- list("categories"=result.DE.cats, "stats"=result.DE.stats)
  return(result)
}

#Proceed to use the function on the different dataframes I've created with different sets of overlapping Hi-C contacts:
h_minFDR_pvals <- lmcorrect(weighted.data, hmin[,c("A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")], hmin[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "genes")], meta.data)
c_minFDR_pvals <- lmcorrect(weighted.data, cmin[,c("A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")], cmin[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "genes")], meta.data)
h_maxB_pvals <- lmcorrect(weighted.data, hmaxB[,c("A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")], hmaxB[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "genes")], meta.data)
c_maxB_pvals <- lmcorrect(weighted.data, cmaxB[,c("A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")], cmaxB[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "genes")], meta.data)
h_US_pvals <- lmcorrect(weighted.data, hUS[,c("A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")], hUS[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "genes")], meta.data)
c_US_pvals <- lmcorrect(weighted.data, cUS[,c("A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")], cUS[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "genes")], meta.data)

#I now proceed to visualize the difference in p-values for expression before and after "correcting" for the Hi-C data. I am hoping to see many hits in the bottom right quadrant of the following plots, indicating genes that showed up as DE before Hi-C correction, but not after. I also expect that p-values falling farther away from the null line of expectation for p-values being identical between models will have higher correlations, which I color here for the pearson correlation (results look similar for spearman).
ggplot(data=h_minFDR_pvals$stats, aes(x=-log10(pval.before), y=-log10(pval.after), color=abs(cor.pear))) + geom_point(size=0.01) + geom_hline(yintercept=-log10(0.05), color="red") + geom_vline(xintercept=-log10(0.05), color="red") + geom_abline(slope=1, intercept=0, color="green", linetype="dashed") + ggtitle("Evidence for DE before vs. after regressing out Hi-C min. FDR (H)") + xlab("-log10(p-value of DE before Hi-C regression)") + ylab("-log10(p-value of DE after Hi-C regression")
ggplot(data=h_minFDR_pvals$stats, aes(x=-log10(pval.before), y=-log10(pval.after))) + geom_point(size=0.01) + geom_hline(yintercept=-log10(0.05), color="red") + geom_vline(xintercept=-log10(0.05), color="red") + geom_abline(slope=1, intercept=0, color="green", linetype="dashed") + ggtitle("Evidence for DE Before vs. After Regressing out Hi-C Contact Frequency") + xlab("-log10(p-value of DE before Hi-C regression)") + ylab("-log10(p-value of DE after Hi-C regression)") + theme(plot.title=element_text(hjust=1)) #Slightly cleaner, for MindBytes 2018 poster
ggplot(data=h_maxB_pvals$stats, aes(x=-log10(pval.before), y=-log10(pval.after), color=abs(cor.pear))) + geom_point(size=0.01) + geom_hline(yintercept=-log10(0.05), color="red") + geom_vline(xintercept=-log10(0.05), color="red") + geom_abline(slope=1, intercept=0, color="green", linetype="dashed") + ggtitle("Evidence for DE before vs. after regressing out Hi-C max beta (H)") + xlab("-log10(p-value of DE before Hi-C regression)") + ylab("-log10(p-value of DE after Hi-C regression")
ggplot(data=h_US_pvals$stats, aes(x=-log10(pval.before), y=-log10(pval.after), color=abs(cor.spear))) + geom_point(size=0.01) + geom_hline(yintercept=-log10(0.05), color="red") + geom_vline(xintercept=-log10(0.05), color="red") + geom_abline(slope=1, intercept=0, color="green", linetype="dashed") + ggtitle("Evidence for DE before vs. after regressing out Hi-C US bin FDR (H)") + xlab("-log10(p-value of DE before Hi-C regression)") + ylab("-log10(p-value of DE after Hi-C regression")
ggplot(data=c_minFDR_pvals$stats, aes(x=-log10(pval.before), y=-log10(pval.after), color=abs(cor.pear))) + geom_point(size=0.01) + geom_hline(yintercept=-log10(0.05), color="red") + geom_vline(xintercept=-log10(0.05), color="red") + geom_abline(slope=1, intercept=0, color="green", linetype="dashed") + ggtitle("Evidence for DE before vs. after regressing out Hi-C min. FDR (C)") + xlab("-log10(p-value of DE before Hi-C regression)") + ylab("-log10(p-value of DE after Hi-C regression")
ggplot(data=c_maxB_pvals$stats, aes(x=-log10(pval.before), y=-log10(pval.after), color=abs(cor.pear))) + geom_point(size=0.01) + geom_hline(yintercept=-log10(0.05), color="red") + geom_vline(xintercept=-log10(0.05), color="red") + geom_abline(slope=1, intercept=0, color="green", linetype="dashed") + ggtitle("Evidence for DE before vs. after regressing out Hi-C max beta (C)") + xlab("-log10(p-value of DE before Hi-C regression)") + ylab("-log10(p-value of DE after Hi-C regression")
ggplot(data=c_US_pvals$stats, aes(x=-log10(pval.before), y=-log10(pval.after), color=abs(cor.pear))) + geom_point(size=0.01) + geom_hline(yintercept=-log10(0.05), color="red") + geom_vline(xintercept=-log10(0.05), color="red") + geom_abline(slope=1, intercept=0, color="green", linetype="dashed") + ggtitle("Evidence for DE before vs. after regressing out Hi-C US bin FDR (C)") + xlab("-log10(p-value of DE before Hi-C regression)") + ylab("-log10(p-value of DE after Hi-C regression")
```
Critically, here I see that "regressing out" Hi-C data and trying to model expression again moves many genes from being significantly differentially expressed (at FDR of 5%) to no longer showing differential expression. Seeing most of the hits in the bottom right corner of these visualizations is what confirms this. Reassuringly, I also see stronger correlations between RPKM expression values and normalized Hi-C interaction frequency values for points farther away from the diagonal green line of expectation. However, since this is not a statistical test, I have no assessment of significance. To accomplish this, I compare these results to running the same kind of analysis on permuted data in the next section.

###Permutation Visualizations
Here, I visualize the difference in classes of DE hits changing (either gaining, losing, or maintaining DE status) after "regressing out" the effect of Hi-C from expression. I show distributions of these percentages across 10000 permutations of the data, as compared to the observed percentages.
```{r Permutation Visualizations}
##Visualization of the permutations!
perm.vis <- function(categories.df.file, df, metadata, hictype, DE=FALSE){
  if(DE==TRUE){expected1 <- readRDS(paste("~/Desktop/Hi-C/HiC_covs/results/new_results/DE/batch1/", categories.df.file, sep=""))
  expected2 <-  readRDS(paste("~/Desktop/Hi-C/HiC_covs/results/new_results/DE/batch2/", categories.df.file, sep=""))
  observed <- lmcorrect(weighted.data, df[which(df$adj.P.Val<=0.05), c("A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")], df[which(df$adj.P.Val<=0.05), c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "genes")], metadata)
  }
  else{expected1 <- readRDS(paste("~/Desktop/Hi-C/HiC_covs/results/new_results/batch1/", categories.df.file, sep=""))
  expected2 <- readRDS(paste("~/Desktop/Hi-C/HiC_covs/results/new_results/batch2/", categories.df.file, sep=""))
  observed <- lmcorrect(weighted.data, df[,c("A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651")], df[,c("A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC", "genes")], metadata)
  }
  expected <- c(expected1[1:5000], expected2[1:5000])
  expected[[10001]] <- rbind(expected1[[5001]], expected2[[5001]])
  expected[[10001]] <- ((expected[[10001]])/sum(expected[[10001]][1,]))*100
  for(i in 1:(length(expected)-1)){
  expected[[i]]$type <- i
  expected[[i]]$data <- "expected"
  }
  observed$categories <- (observed$categories/sum(observed$categories[1,]))*100
  observed$stats$type <- 10001
  observed$stats$data <- "observed"
  expected[[10001]]$data <- "permutations"
  expected[[10001]][10001,] <- c(observed$categories, "observation")
  deneitherbox <- ggplot(data=expected[[10001]], aes(x="", y=DEneither)) + geom_boxplot(aes(color="Expected"), show.legend=FALSE) + geom_point(aes(y=observed$categories$DEneither, color="Observed"), size=3) + ggtitle("Percent of genes with no evidence for DE regardless") + ylab("% genes not DE in either") + xlab(paste("10000 Permutations of Hi-C data ", hictype, sep="")) + scale_color_manual(values=c("blue", "red"), guide=FALSE) +guides(color=guide_legend("Data", override.aes = list(shape=c(16, 16))))
  debeforebox <- ggplot(data=expected[[10001]], aes(x="", y=DEbefore)) + geom_boxplot(aes(color="Expected"), show.legend=FALSE) + geom_point(aes(y=observed$categories$DEbefore, color="Observed"), size=3) + ggtitle("Percent of genes with reduced evidence for DE after Hi-C correction") + ylab("% genes DE before, but not after, Hi-C correction") + xlab(paste("10000 Permutations of Hi-C data ", hictype, sep="")) + scale_color_manual(values=c("blue", "red"), guide=FALSE) +guides(color=guide_legend("Data", override.aes = list(shape=c(16, 16))))
  deafterbox <- ggplot(data=expected[[10001]], aes(x="", y=DEafter)) + geom_boxplot(aes(color="Expected"), show.legend=FALSE) + geom_point(aes(y=observed$categories$DEafter, color="Observed"), size=3) + ggtitle("Percent of genes with increased evidence for DE after Hi-C correction") + ylab("% genes DE after, but not before, Hi-C correction") + xlab(paste("10000 Permutations of Hi-C data ", hictype, sep="")) + scale_color_manual(values=c("blue", "red"), guide=FALSE) +guides(color=guide_legend("Data", override.aes = list(shape=c(16, 16))))
  debothbox <- ggplot(data=expected[[10001]], aes(x="", y=DEboth)) + geom_boxplot(aes(color="Expected"), show.legend=FALSE) + geom_point(aes(y=observed$categories$DEboth, color="Observed"), size=3) + ggtitle("Percent of genes with evidence for DE regardless") + ylab("% genes DE in both") + xlab(paste("10000 Permutations of Hi-C data ", hictype, sep="")) + scale_color_manual(values=c("blue", "red"), guide=FALSE) +guides(color=guide_legend("Data", override.aes = list(shape=c(16, 16))))
  print(deneitherbox)
  print(debeforebox)
  print(deafterbox)
  print(debothbox)
}

perm.vis("permout_h_minFDR", hmin, meta.data, "(min FDR contact, Humans)")
perm.vis("permout_h_maxB", hmaxB, meta.data,  "(max beta contact, Humans)")
perm.vis("permout_h_US", hUS, meta.data, "(upstream contact, Humans)")
perm.vis("permout_c_minFDR", cmin, meta.data, "(min FDR contact, Chimps)")
perm.vis("permout_c_maxB", cmaxB, meta.data, "(max beta contact, Chimps)")
perm.vis("permout_c_US", cUS, meta.data, "(upstream contact, Chimps)")

perm.vis("permout_h_minFDR_DE", hminDE, meta.data, "(min FDR contact, Humans)", DE=TRUE)
perm.vis("permout_h_maxB_DE", hmaxBDE, meta.data,  "(max beta contact, Humans)", DE=TRUE)
perm.vis("permout_h_US_DE", hUSDE, meta.data, "(upstream contact, Humans)", DE=TRUE)
perm.vis("permout_c_minFDR_DE", cminDE, meta.data, "(min FDR contact, Chimps)", DE=TRUE)
perm.vis("permout_c_maxB_DE", cmaxBDE, meta.data, "(max beta contact, Chimps)", DE=TRUE)
perm.vis("permout_c_US_DE", cUSDE, meta.data, "(upstream contact, Chimps)", DE=TRUE)
```
The permutations reveal that the observed data does appear pretty significant: it falls well outside the range of the distributions in each of the categories. The most important is showing that many more genes lose their DE status after regressing out Hi-C data in the observed case as compared to the permutations.

###Exploration of higher-order structure in relation to gene expression. A/B Compartment Analysis
Here, I look at A/B compartment calls from HOMER and see if DE and/or DC genes are more likely to be in different compartments between species.
```{r}
###Start with A/B compartments; much simpler. Read them in!
A_AB <- fread("~/Desktop/Hi-C/AB_compartments/50kb/A-21792.PC1.txt", header = TRUE, data.table=FALSE)
B_AB <- fread("~/Desktop/Hi-C/AB_compartments/50kb/B-28126.PC1.txt", header = TRUE, data.table=FALSE)
E_AB <- fread("~/Desktop/Hi-C/AB_compartments/50kb/E-28815.PC1.txt", header = TRUE, data.table=FALSE)
F_AB <- fread("~/Desktop/Hi-C/AB_compartments/50kb/F-28834.PC1.txt", header = TRUE, data.table=FALSE)
C_AB <- fread("~/Desktop/Hi-C/AB_compartments/50kb/C-3649.PC1.txt", header = TRUE, data.table=FALSE)
D_AB <- fread("~/Desktop/Hi-C/AB_compartments/50kb/D-40300.PC1.txt", header = TRUE, data.table=FALSE)
G_AB <- fread("~/Desktop/Hi-C/AB_compartments/50kb/G-3624.PC1.txt", header = TRUE, data.table=FALSE)
H_AB <- fread("~/Desktop/Hi-C/AB_compartments/50kb/H-3651.PC1.txt", header = TRUE, data.table=FALSE)

colnames(A_AB) <- colnames(B_AB) <- colnames(C_AB) <- colnames(D_AB) <- colnames(E_AB) <- colnames(F_AB) <- colnames(G_AB) <- colnames(H_AB) <- c("peakID", "chr", "start", "end", "strand", "PC1")

#Interestingly, within a species they're not all the same length (which doesn't make much sense as I thought these were identical genomes). A and F are females, B and E are males, so that's why B and E are larger--just remove chrY data to deal with that. But why aren't B and E identical, or A and F identical? Perhaps this is because not every individual gets enough reads at each of the regions to call compartments? Not really clear to me...for now, use ALL regions I can by combining these DFs, taking the mean PC1 value across individuals for those hits which ARE repeated (should be the vast majority).
humans.AB <- rbind(A_AB, B_AB, E_AB, F_AB)
humans.AB <- group_by(humans.AB, peakID) %>% summarise(chr=unique(chr), start=unique(start), end=unique(end), strand=unique(strand), PC1=mean(PC1))

chimps.AB <- rbind(C_AB, D_AB, G_AB, H_AB)
chimps.AB <- group_by(chimps.AB, peakID) %>% summarise(chr=unique(chr), start=unique(start), end=unique(end), strand=unique(strand), PC1=mean(PC1))

#Now, I want to assign a compartment (A or B) to each of these loci, so that they can then be examined WRT the Hi-C bins that might overlap them.
humans.AB$compartment <- ifelse(humans.AB$PC1>0, "A", "B")
chimps.AB$compartment <- ifelse(chimps.AB$PC1>0, "A", "B")

#Really, only want to look at genes we can actually call DE on based on expression levels, so only care about those genes in detable object. Can extract their exact positions from hgene.hic and cgene.hic and create peakIDs for them that match the AB compartment peak names. Basically, I just want to call which of the AB compartment peak bins they'll fall into. Note that those compartments were made 50kb at a time, so I need to round to lower 50k (or higher, depending on strand and proximity to boundary!) to figure out which compartment a gene belongs to.
colnames(hgene.hic) <- c("Hchr", "Hstart", "Hend", "genes", "Hplace", "Hstrand", "binchr", "binstart", "binend", "bindist.TSS")
colnames(cgene.hic) <- c("Cchr", "Cstart", "Cend", "genes", "Cplace", "Cstrand", "binchr", "binstart", "binend", "bindist.TSS")

#Add in lengths for appropriate PCA bin assignment in next part.
colnames(human_lengths) <- colnames(chimp_lengths) <- c("genes", "length")
hgene.PCA <- left_join(hgene.hic, human_lengths, by="genes")
cgene.PCA <- left_join(cgene.hic, chimp_lengths, by="genes")

#Assign genes to A/B compartment bins based on their position along the 50kb interval and their gene length, as well as strand orientation (trying to get the gene body in the actual 50kb interval).
hgene.PCA$HID <- paste(hgene.PCA$Hchr, ifelse(hgene.PCA$Hstrand=="+", ifelse(hgene.PCA$Hstart%%50000>=(50000-hgene.PCA$length), as.integer(50000*ceiling(hgene.PCA$Hstart/50000)), as.integer(50000*floor(hgene.PCA$Hstart/50000))), ifelse(hgene.PCA$Hstart%%50000<=hgene.PCA$length, as.integer((50000*floor(hgene.PCA$Hstart/50000)-50000)), as.integer(50000*floor(hgene.PCA$Hstart/50000)))), sep="-")
cgene.PCA$CID <- paste(cgene.PCA$Cchr, ifelse(cgene.PCA$Cstrand=="+", ifelse(cgene.PCA$Cstart%%50000>=(50000-cgene.PCA$length), as.integer(50000*ceiling(cgene.PCA$Cstart/50000)), as.integer(50000*floor(cgene.PCA$Cstart/50000))), ifelse(cgene.PCA$Cstart%%50000<=cgene.PCA$length, as.integer((50000*floor(cgene.PCA$Cstart/50000)-50000)), as.integer(50000*floor(cgene.PCA$Cstart/50000)))), sep="-")
#hgene.hic$HID <- ifelse(hgene.hic$Hstrand=="+", paste(hgene.hic$Hchr, as.integer(50000*floor(hgene.hic$Hstart/50000)), sep="-"))
#cgene.hic$CID <- paste(cgene.hic$Cchr, as.integer(50000*floor(cgene.hic$Cstart/50000)), sep="-")
hgenes.compartments <- select(hgene.PCA, Hchr, Hstart, genes, Hstrand, HID)
cgenes.compartments <- select(cgene.PCA, Cchr, Cstart, genes, Cstrand, CID)
compartment.genes <- left_join(detable, hgenes.compartments, by="genes") %>% left_join(., cgenes.compartments, by="genes")

#See how many genes fall within 5 kb of one of the boundaries here (at every 50kb interval): Though this was only considering the lower end, not if they fall on the other edge of the boundary (45k modulo remainder is equivalent and comparable #s!). REALLY what I should care about are positive strand genes falling at the upper edge of a boundary (implying their gene body may lie in the next compartment) and negative strand genes falling at the lower edge of a boundary (implying their gene body may lie in the previous compartment). If I have positive strand genes near the beginning or negative strand genes near the end that's not really an issue as their gene bodies should lie entirely within the compartment. It's really just those two specific cases.
sum((compartment.genes$Hstart%%50000)<=5000, na.rm=TRUE)
sum((compartment.genes$Cstart%%50000)<=5000, na.rm=TRUE)
#In both species, roughly 1k of the genes we can consider at all fall near (w/in 5kb) one of the A/B boundaries we've established here. Could there be issues with pos/neg strand and how close they are to the boundary? I can check on this...or can also assume it's balanced across both issues. If the results from a naive analysis don't look good I can go back and fix this part of that.

#Now, merge compartment.genes and the humans.AB and chimps.AB compartment assignment DFs!
HAB <- select(humans.AB, peakID, compartment, PC1)
CAB <- select(chimps.AB, peakID, compartment, PC1)
colnames(HAB) <- c("HID", "compartment.H", "PC.H")
colnames(CAB) <- c("CID", "compartment.C", "PC.C")

final.AB <- left_join(compartment.genes, HAB, by="HID") %>% left_join(., CAB, by="CID")
final.AB$comp.diff <- ifelse(final.AB$compartment.H==final.AB$compartment.C, "no", "yes") #Note that 311 of these rows have missing data from at least one species so this determination can't be made? Often b/c of being on a scaffold in chimps.
final.AB$PC.diff <- abs(final.AB$PC.H-final.AB$PC.C)
final.AB <- final.AB[order(final.AB$adj.P.Val),]
final.AB$DE <- ifelse(final.AB$adj.P.Val<=0.05, "yes", "no")
table(final.AB$DE, final.AB$comp.diff, dnn=c("DE?", "Different Compartment b/t Species?"))
chisq.test(table(final.AB$DE, final.AB$comp.diff, dnn=c("DE?", "Same Compartment b/t Species?")))
#So roughly 7.9% of DE genes are in different compartments between species, whereas ~8.1% of non-DE genes are in different compartments between species...shitty! And not significant!

#Would be nice to know if the differential compartments between species are at least concentrated in those differential contacts b/t species?! Add a column of the DC status between species.
final.AB$DC <- ifelse(final.AB$genes %in% filter(gene.hic.filt, min_FDR.H<=0.05|min_FDR.C<=0.05)$genes, "yes", "no")
table(final.AB$DC, final.AB$comp.diff, dnn=c("DC?", "Different Compartment b/t Species?"))
chisq.test(table(final.AB$DC, final.AB$comp.diff, dnn=c("DC?", "Different Compartment b/t Species?")))
#Again, not significant...can see that the genes which are DC have ~6.5% of them in different compartments b/t species, while the non-DC ones have 8.2% of them in different compartments b/t species. Note that this is also the exact opposite result I was hoping for...

#So a simple classification system is not sufficient for A/B compartment changes between the species. What if I actually took the mean PC value and plotted the difference bewtween species vs decreasing significance? The final.AB df is already ordered by DE p-val, so can do this real quick simply:
ggplot(data=final.AB) + geom_line(aes(x=adj.P.Val, y=PC.diff)) + ggtitle("Absolute Difference of PC1 Ordered by DE Significance") + xlab("Decreasing DE Significance") + ylab("|PC1 Difference b/t Species|")
t.test(filter(final.AB, adj.P.Val<=0.05)$PC.diff, filter(final.AB, adj.P.Val>0.05)$PC.diff)
ggplot(data=final.AB) + geom_violin(aes(group=DE, x=DE, y=PC.diff), draw_quantiles = c(0.25, 0.5, 0.75)) + ggtitle("Absolute Difference of PC1 | DE") + xlab("DE Status") + ylab("|PC1 Difference b/t Species|")
#None of this is particularly encouraging...but what if I did it on DC status? Can just check on binary status here to see if it'll even be significant or not:
t.test(filter(final.AB, DC=="yes")$PC.diff, filter(final.AB, DC=="no")$PC.diff)
#Aaaaand it's not. My inclination is to not spend any more time on the PCA element of this since the results don't seem to be good at all...

#Just a quick check to see if not using absolute difference would be better?
final.AB$PC.hdiff <- final.AB$PC.C-final.AB$PC.H
ggplot(data=final.AB) + geom_line(aes(x=adj.P.Val, y=PC.hdiff)) + ggtitle("Difference of PC1 Ordered by DE Significance") + xlab("Decreasing DE Significance") + ylab("PC1 Difference b/t Species (H-C)")
t.test(filter(final.AB, adj.P.Val<=0.05)$PC.hdiff, filter(final.AB, adj.P.Val>0.05)$PC.hdiff)
ggplot(data=final.AB) + geom_violin(aes(group=DE, x=DE, y=PC.hdiff), draw_quantiles = c(0.25, 0.5, 0.75)) + ggtitle("Difference of PC1 | DE") + xlab("DE Status") + ylab("PC1 Difference b/t Species (H-C)")
#None of this is particularly encouraging...but what if I did it on DC status? Can just check on binary status here to see if it'll even be significant or not:
t.test(filter(final.AB, DC=="yes")$PC.hdiff, filter(final.AB, DC=="no")$PC.hdiff) #Interestingly, if starting with humans as baseline here, this p-val is ALMOST significant!!!! Same if starting with chimps--just not using absolute value makes this almost significant...
#Note that I also tried coloring the differences of PC1 plots by DC status and saw lines of both short and long variety, no clear trend of a bigger difference b/t species there, so no point in putting in the work to look at DC on x-axis.
#With the finished AB compartment DFs, should be as easy as just assigning Hi-C bins to A or B! Note that this current paradigm is limited to the genes that had direct overlap with a significant Hi-C bin; there's no reason for this! FIX! gene.hic.filt may not be the best data frame for this to work on then, since it doesn't include position information on all genes--get that!
# ABall <- select(gene.hic.filt, genes, logFC, AveExpr, adj.P.Val, B, HID, min_FDR_bin.H, CID, min_FDR_bin.C)
# hcomps <- select(humans.AB, peakID, compartment)
# ccomps <- select(chimps.AB, peakID, compartment)
# colnames(hcomps) <- c("HID", "compartment.H")
# colnames(ccomps) <- c("CID", "compartment.C")
# left_join(ABall, hcomps, by="HID") %>% left_join(., ccomps, by="CID") -> AB.all
# 
# head(gene.hic.filt)

#Exploration of why they're not identically sized, not important. Also show some within-species exploration of the variance in these values; probably also not important. Collapsed.
# good.indices <- which(B_AB$`#peakID` %in% E_AB$`#peakID`)
# test <- B_AB[-good.indices,]
# good.indices <- which(E_AB$`#peakID` %in% B_AB$`#peakID`)
# test2 <- E_AB[-good.indices,]

#See how much within-species variance exists in these, after standardizing them to be identical across individuals from same species (remove X chromosome?). Or just do left joins on one and see what variance is like in that subset--most 
# left_join(A_AB, B_AB, by="peakID") %>% left_join(., E_AB, by="peakID") %>% left_join(., F_AB, by="peakID") -> newtest
# newtest <- select(newtest, peakID, PC1.x, PC1.y, PC1.x.x, PC1.y.y)
# colnames(newtest) <- c("peakID", "A", "B", "E", "F")
# newtest$var <- apply(newtest[,-1], 1, var)
# ggplot(data=newtest) + geom_violin(aes(x="", y=var))
# sum(newtest$var>1, na.rm=TRUE) #Returns ~1000, so of about 54k rows there are 1000 with high variance between individuals. Leave it be for now, just something to think about in case this looks wonky later.

#Look at some candidates of the strongest compartment differences real quick to see if anything interesting here?
quantile(final.AB$PC.diff, probs=c(0.5, 0.6, 0.7, 0.8, 0.85, 0.9, 0.95, 0.99), na.rm = TRUE)
theonepercent <- which(final.AB$PC.diff>=1.7327811)
extremes <- final.AB[theonepercent,]
#I went back with some of this to look...nothing looks great TBH. For what it's worth, at least there are more instances in compartment differences where it's open in humans and closed in chimps than vice versa:
sum(final.AB$comp.diff=="yes"&final.AB$compartment.H=="A"&final.AB$compartment.C=="B", na.rm=TRUE) #Open in humans, closed in chimps
sum(final.AB$comp.diff=="yes"&final.AB$compartment.H=="B"&final.AB$compartment.C=="A", na.rm=TRUE) #Open in chimps, closed in humans

####25kb PCA A/B compartment analysis. Repeat this entire analysis utilizing 25kb as the window size for PCA calls.
###Start with A/B compartments; much simpler. Read them in!
A_AB <- fread("~/Desktop/Hi-C/AB_compartments/25kb/A-21792.PC1.txt", header = TRUE, data.table=FALSE)
B_AB <- fread("~/Desktop/Hi-C/AB_compartments/25kb/B-28126.PC1.txt", header = TRUE, data.table=FALSE)
E_AB <- fread("~/Desktop/Hi-C/AB_compartments/25kb/E-28815.PC1.txt", header = TRUE, data.table=FALSE)
F_AB <- fread("~/Desktop/Hi-C/AB_compartments/25kb/F-28834.PC1.txt", header = TRUE, data.table=FALSE)
C_AB <- fread("~/Desktop/Hi-C/AB_compartments/25kb/C-3649.PC1.txt", header = TRUE, data.table=FALSE)
D_AB <- fread("~/Desktop/Hi-C/AB_compartments/25kb/D-40300.PC1.txt", header = TRUE, data.table=FALSE)
G_AB <- fread("~/Desktop/Hi-C/AB_compartments/25kb/G-3624.PC1.txt", header = TRUE, data.table=FALSE)
H_AB <- fread("~/Desktop/Hi-C/AB_compartments/25kb/H-3651.PC1.txt", header = TRUE, data.table=FALSE)

colnames(A_AB) <- colnames(B_AB) <- colnames(C_AB) <- colnames(D_AB) <- colnames(E_AB) <- colnames(F_AB) <- colnames(G_AB) <- colnames(H_AB) <- c("peakID", "chr", "start", "end", "strand", "PC1")

#Interestingly, within a species they're not all the same length (which doesn't make much sense as I thought these were identical genomes). A and F are females, B and E are males, so that's why B and E are larger--just remove chrY data to deal with that. But why aren't B and E identical, or A and F identical? Perhaps this is because not every individual gets enough reads at each of the regions to call compartments? Not really clear to me...for now, use ALL regions I can by combining these DFs, taking the mean PC1 value across individuals for those hits which ARE repeated (should be the vast majority).
humans.AB <- rbind(A_AB, B_AB, E_AB, F_AB)
humans.AB <- group_by(humans.AB, peakID) %>% summarise(chr=unique(chr), start=unique(start), end=unique(end), strand=unique(strand), PC1=mean(PC1))

chimps.AB <- rbind(C_AB, D_AB, G_AB, H_AB)
chimps.AB <- group_by(chimps.AB, peakID) %>% summarise(chr=unique(chr), start=unique(start), end=unique(end), strand=unique(strand), PC1=mean(PC1))

#Now, I want to assign a compartment (A or B) to each of these loci, so that they can then be examined WRT the Hi-C bins that might overlap them.
humans.AB$compartment <- ifelse(humans.AB$PC1>0, "A", "B")
chimps.AB$compartment <- ifelse(chimps.AB$PC1>0, "A", "B")

#Really, only want to look at genes we can actually call DE on based on expression levels, so only care about those genes in detable object. Can extract their exact positions from hgene.hic and cgene.hic and create peakIDs for them that match the AB compartment peak names. Basically, I just want to call which of the AB compartment peak bins they'll fall into. Note that those compartments were made 50kb at a time, so I need to round to lower 50k (or higher, depending on strand and proximity to boundary!) to figure out which compartment a gene belongs to.
colnames(hgene.hic) <- c("Hchr", "Hstart", "Hend", "genes", "Hplace", "Hstrand", "binchr", "binstart", "binend", "bindist.TSS")
colnames(cgene.hic) <- c("Cchr", "Cstart", "Cend", "genes", "Cplace", "Cstrand", "binchr", "binstart", "binend", "bindist.TSS")

#Add in lengths for appropriate PCA bin assignment in next part.
colnames(human_lengths) <- colnames(chimp_lengths) <- c("genes", "length")
hgene.PCA <- left_join(hgene.hic, human_lengths, by="genes")
cgene.PCA <- left_join(cgene.hic, chimp_lengths, by="genes")

#Assign genes to A/B compartment bins based on their position along the 50kb interval and their gene length, as well as strand orientation (trying to get the gene body in the actual 50kb interval).
hgene.PCA$HID <- paste(hgene.PCA$Hchr, ifelse(hgene.PCA$Hstrand=="+", ifelse(hgene.PCA$Hstart%%25000>=(25000-hgene.PCA$length), as.integer(25000*ceiling(hgene.PCA$Hstart/25000)), as.integer(25000*floor(hgene.PCA$Hstart/25000))), ifelse(hgene.PCA$Hstart%%25000<=hgene.PCA$length, as.integer((25000*floor(hgene.PCA$Hstart/25000)-25000)), as.integer(25000*floor(hgene.PCA$Hstart/25000)))), sep="-")
cgene.PCA$CID <- paste(cgene.PCA$Cchr, ifelse(cgene.PCA$Cstrand=="+", ifelse(cgene.PCA$Cstart%%25000>=(25000-cgene.PCA$length), as.integer(25000*ceiling(cgene.PCA$Cstart/25000)), as.integer(25000*floor(cgene.PCA$Cstart/25000))), ifelse(cgene.PCA$Cstart%%25000<=cgene.PCA$length, as.integer((25000*floor(cgene.PCA$Cstart/25000)-25000)), as.integer(25000*floor(cgene.PCA$Cstart/25000)))), sep="-")
#hgene.hic$HID <- ifelse(hgene.hic$Hstrand=="+", paste(hgene.hic$Hchr, as.integer(25000*floor(hgene.hic$Hstart/25000)), sep="-"))
#cgene.hic$CID <- paste(cgene.hic$Cchr, as.integer(25000*floor(cgene.hic$Cstart/25000)), sep="-")
hgenes.compartments <- select(hgene.PCA, Hchr, Hstart, genes, Hstrand, HID)
cgenes.compartments <- select(cgene.PCA, Cchr, Cstart, genes, Cstrand, CID)
compartment.genes <- left_join(detable, hgenes.compartments, by="genes") %>% left_join(., cgenes.compartments, by="genes")

#See how many genes fall within 5 kb of one of the boundaries here (at every 50kb interval): Though this was only considering the lower end, not if they fall on the other edge of the boundary (45k modulo remainder is equivalent and comparable #s!). REALLY what I should care about are positive strand genes falling at the upper edge of a boundary (implying their gene body may lie in the next compartment) and negative strand genes falling at the lower edge of a boundary (implying their gene body may lie in the previous compartment). If I have positive strand genes near the beginning or negative strand genes near the end that's not really an issue as their gene bodies should lie entirely within the compartment. It's really just those two specific cases.
sum((compartment.genes$Hstart%%25000)<=5000, na.rm=TRUE)
sum((compartment.genes$Cstart%%25000)<=5000, na.rm=TRUE)
#In both species, roughly 1k of the genes we can consider at all fall near (w/in 5kb) one of the A/B boundaries we've established here. Could there be issues with pos/neg strand and how close they are to the boundary? I can check on this...or can also assume it's balanced across both issues. If the results from a naive analysis don't look good I can go back and fix this part of that.

#Now, merge compartment.genes and the humans.AB and chimps.AB compartment assignment DFs!
HAB <- select(humans.AB, peakID, compartment, PC1)
CAB <- select(chimps.AB, peakID, compartment, PC1)
colnames(HAB) <- c("HID", "compartment.H", "PC.H")
colnames(CAB) <- c("CID", "compartment.C", "PC.C")

final.AB <- left_join(compartment.genes, HAB, by="HID") %>% left_join(., CAB, by="CID")
final.AB$comp.diff <- ifelse(final.AB$compartment.H==final.AB$compartment.C, "no", "yes") #Note that 311 of these rows have missing data from at least one species so this determination can't be made? Often b/c of being on a scaffold in chimps.
final.AB$PC.diff <- abs(final.AB$PC.H-final.AB$PC.C)
final.AB <- final.AB[order(final.AB$adj.P.Val),]
final.AB$DE <- ifelse(final.AB$adj.P.Val<=0.05, "yes", "no")
table(final.AB$DE, final.AB$comp.diff, dnn=c("DE?", "Different Compartment b/t Species?"))
chisq.test(table(final.AB$DE, final.AB$comp.diff, dnn=c("DE?", "Same Compartment b/t Species?")))
#So roughly 6.61% of DE genes are in different compartments between species, whereas 6.68% of non-DE genes are in different compartments between species...shitty! And not significant!

#Would be nice to know if the differential compartments between species are at least concentrated in those differential contacts b/t species?! Add a column of the DC status between species.
final.AB$DC <- ifelse(final.AB$genes %in% filter(gene.hic.filt, min_FDR.H<=0.05|min_FDR.C<=0.05)$genes, "yes", "no")
table(final.AB$DC, final.AB$comp.diff, dnn=c("DC?", "Different Compartment b/t Species?"))
chisq.test(table(final.AB$DC, final.AB$comp.diff, dnn=c("DC?", "Different Compartment b/t Species?")))
#Again, not significant...can see that the genes which are DC have ~6.3% of them in different compartments b/t species, while the non-DC ones have 6.7% of them in different compartments b/t species. Note that this is also the exact opposite result I was hoping for...

#So a simple classification system is not sufficient for A/B compartment changes between the species. What if I actually took the mean PC value and plotted the difference bewtween species vs decreasing significance? The final.AB df is already ordered by DE p-val, so can do this real quick simply:
ggplot(data=final.AB) + geom_line(aes(x=adj.P.Val, y=PC.diff)) + ggtitle("Absolute Difference of PC1 Ordered by DE Significance") + xlab("Decreasing DE Significance") + ylab("|PC1 Difference b/t Species|")
t.test(filter(final.AB, DE=="yes")$PC.diff, filter(final.AB, DE=="no")$PC.diff)
ggplot(data=final.AB) + geom_violin(aes(group=DE, x=DE, y=PC.diff), draw_quantiles = c(0.25, 0.5, 0.75)) + ggtitle("Absolute Difference of PC1 | DE") + xlab("DE Status") + ylab("|PC1 Difference b/t Species|")
#None of this is particularly encouraging...but what if I did it on DC status? Can just check on binary status here to see if it'll even be significant or not:
t.test(filter(final.AB, DC=="yes")$PC.diff, filter(final.AB, DC=="no")$PC.diff)
#This time it is!...
ggplot(data=final.AB) + geom_violin(aes(group=DC, x=DC, y=PC.diff), draw_quantiles = c(0.25, 0.5, 0.75)) + ggtitle("Absolute Difference of PC1 | DC") + xlab("DC Status") + ylab("|PC1 Difference b/t Species|") + annotate("text", x=1.5, y=1, label="8.5 e - 3")


#Just a quick check to see if not using absolute difference would be better?
final.AB$PC.hdiff <- final.AB$PC.C-final.AB$PC.H
ggplot(data=final.AB) + geom_line(aes(x=adj.P.Val, y=PC.hdiff)) + ggtitle("Difference of PC1 Ordered by DE Significance") + xlab("Decreasing DE Significance") + ylab("PC1 Difference b/t Species (H-C)")
t.test(filter(final.AB, adj.P.Val<=0.05)$PC.hdiff, filter(final.AB, adj.P.Val>0.05)$PC.hdiff)
ggplot(data=final.AB) + geom_violin(aes(group=DE, x=DE, y=PC.hdiff), draw_quantiles = c(0.25, 0.5, 0.75)) + ggtitle("Difference of PC1 | DE") + xlab("DE Status") + ylab("PC1 Difference b/t Species (H-C)")
#None of this is particularly encouraging...but what if I did it on DC status? Can just check on binary status here to see if it'll even be significant or not:
t.test(filter(final.AB, DC=="yes")$PC.hdiff, filter(final.AB, DC=="no")$PC.hdiff)

#Overall, most of the A/B compartment calling results look rather atrocious...nothing much interesting to be gleaned here, unfortuantely.
```

###TAD Analysis
Here, I look at TAD calls from TopDom to see if I can find a trend of DE genes or DC genes being more likely to have contacts that cross TAD boundaries.
```{r}
###First, simpler analysis looking at total number of TADs called, mean TAD sizes, and TAD size density distributions for each individual across the 3 different window sizes called.
TAD.stats <- function(window){
  A_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/window", window,"/A-21792_TOPDOM_ALL.", window, ".domain", sep=""), header=TRUE, data.table=FALSE)
  B_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/window", window, "/B-28126_TOPDOM_ALL.", window, ".domain", sep=""), header=TRUE, data.table=FALSE)
  C_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/window", window, "/C-3649_TOPDOM_ALL.", window, ".domain", sep=""), header=TRUE, data.table=FALSE)
  D_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/window", window, "/D-40300_TOPDOM_ALL.", window, ".domain", sep=""), header=TRUE, data.table=FALSE)
  E_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/window", window, "/E-28815_TOPDOM_ALL.", window, ".domain", sep=""), header=TRUE, data.table=FALSE)
  F_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/window", window, "/F-28834_TOPDOM_ALL.", window, ".domain", sep=""), header=TRUE, data.table=FALSE)
  G_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/window", window, "/G-3624_TOPDOM_ALL.", window, ".domain", sep=""), header=TRUE, data.table=FALSE)
  H_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/window", window, "/H-3651_TOPDOM_ALL.", window, ".domain", sep=""), header=TRUE, data.table=FALSE)
  A_bounds <- filter(A_TAD, tag=="boundary")
  B_bounds <- filter(B_TAD, tag=="boundary")
  E_bounds <- filter(E_TAD, tag=="boundary")
  F_bounds <- filter(F_TAD, tag=="boundary")
  C_bounds <- filter(C_TAD, tag=="boundary")
  D_bounds <- filter(D_TAD, tag=="boundary")
  G_bounds <- filter(G_TAD, tag=="boundary")
  H_bounds <- filter(H_TAD, tag=="boundary")
  A_domains <- filter(A_TAD, tag=="domain")
  B_domains <- filter(B_TAD, tag=="domain")
  E_domains <- filter(E_TAD, tag=="domain")
  F_domains <- filter(F_TAD, tag=="domain")
  C_domains <- filter(C_TAD, tag=="domain")
  D_domains <- filter(D_TAD, tag=="domain")
  G_domains <- filter(G_TAD, tag=="domain")
  H_domains <- filter(H_TAD, tag=="domain")
  
  A_bounds$species <- B_bounds$species <- E_bounds$species <- F_bounds$species <- A_domains$species <- B_domains$species <- E_domains$species <- F_domains$species <- "human"
  C_bounds$species <- D_bounds$species <- G_bounds$species <- H_bounds$species <- C_domains$species <- D_domains$species <- G_domains$species <- H_domains$species <- "chimp"
  A_bounds$ID <- A_domains$ID <- "A"
  B_bounds$ID <- B_domains$ID <- "B"
  C_bounds$ID <- C_domains$ID <- "C"
  D_bounds$ID <- D_domains$ID <- "D"
  E_bounds$ID <- E_domains$ID <- "E"
  F_bounds$ID <- F_domains$ID <- "F"
  G_bounds$ID <- G_domains$ID <- "G"
  H_bounds$ID <- H_domains$ID <- "H"
  
  ggboundaries <- rbind(select(A_bounds, chr, size, species, ID), select(B_bounds, chr, size, species, ID), select(C_bounds, chr, size, species, ID), select(D_bounds, chr, size, species, ID), select(E_bounds, chr, size, species, ID), select(F_bounds, chr, size, species, ID), select(G_bounds, chr, size, species, ID), select(H_bounds, chr, size, species, ID))
  
  ggdomains <- rbind(select(A_domains, chr, size, species, ID), select(B_domains, chr, size, species, ID), select(C_domains, chr, size, species, ID), select(D_domains, chr, size, species, ID), select(E_domains, chr, size, species, ID), select(F_domains, chr, size, species, ID), select(G_domains, chr, size, species, ID), select(H_domains, chr, size, species, ID))
  
  broad.stats <- data.frame(individuals=c("A", "B", "C", "D", "E", "F", "G", "H"), species=c("human", "human", "chimp", "chimp", "human", "human", "chimp", "chimp"), total.TADs=c(nrow(A_domains), nrow(B_domains), nrow(C_domains), nrow(D_domains), nrow(E_domains), nrow(F_domains), nrow(G_domains), nrow(H_domains)), mean.TAD.size=c(mean(A_domains$size), mean(B_domains$size), mean(C_domains$size), mean(D_domains$size), mean(E_domains$size), mean(F_domains$size), mean(G_domains$size), mean(H_domains$size)), total.bounds=c(nrow(A_bounds), nrow(B_bounds), nrow(C_bounds), nrow(D_bounds), nrow(E_bounds), nrow(F_bounds), nrow(G_bounds), nrow(H_bounds)), mean.bound.size=c(mean(A_bounds$size), mean(B_bounds$size), mean(C_bounds$size), mean(D_bounds$size), mean(E_bounds$size), mean(F_bounds$size), mean(G_bounds$size), mean(H_bounds$size)))
  
  result <- list(boundaries=ggboundaries, domains=ggdomains, stats=broad.stats)
  return(result)
  
}

TADs.20 <- TAD.stats(20)
TADs.10 <- TAD.stats(10)
TADs.5 <- TAD.stats(5)

TADs.20$stats$window <- 200
TADs.10$stats$window <- 100
TADs.5$stats$window <- 50

TADs.overall <- rbind(TADs.20$stats, TADs.10$stats, TADs.5$stats)

#Total TADs
ggplot(data=TADs.overall) + geom_line(aes(x=window, group=individuals, y=total.TADs, color=species)) + ggtitle("Total # of TADs Called by Window Size Used") + xlab("Window Size (kb)") + ylab("Total Number of TADs") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=50, y=14000, label="0.015", size=3) + annotate("text", x=100, y=10000, label="2.6 e -3", size=3) + annotate("text", x=200, y=11000, label="1.5 e -4", size=3)
t.test(TADs.20$stats$total.TADs[c(1:2, 5:6)], TADs.20$stats$total.TADs[c(3:4, 7:8)])
t.test(TADs.10$stats$total.TADs[c(1:2, 5:6)], TADs.10$stats$total.TADs[c(3:4, 7:8)])
t.test(TADs.5$stats$total.TADs[c(1:2, 5:6)], TADs.5$stats$total.TADs[c(3:4, 7:8)])

#Mean TAD size
ggplot(data=TADs.overall) + geom_line(aes(x=window, group=individuals, y=mean.TAD.size, color=species)) + ggtitle("Mean TAD Size by Window Size Used") + xlab("Window Size (kb)") + ylab("Mean TAD Size") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=50, y=130000, label="0.013", size=3) + annotate("text", x=100, y=170000, label="4 e -3", size=3) + annotate("text", x=200, y=240000, label="4.7 e -4", size=3)
t.test(TADs.20$stats$mean.TAD.size[c(1:2, 5:6)], TADs.20$stats$mean.TAD.size[c(3:4, 7:8)])
t.test(TADs.10$stats$mean.TAD.size[c(1:2, 5:6)], TADs.10$stats$mean.TAD.size[c(3:4, 7:8)])
t.test(TADs.5$stats$mean.TAD.size[c(1:2, 5:6)], TADs.5$stats$mean.TAD.size[c(3:4, 7:8)])

#TAD size distributions
ggplot(data=TADs.20$domains) + geom_density(aes(x=size, group=ID, color=species, y=..scaled..)) + ggtitle("TAD Size Distributions by Species, 200kb Windows") + xlab("TAD Size") + ylab("Density") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=1000000, y=0.5, label="< 2.2 e -16") + coord_cartesian(xlim=c(0, 2250000))#Already checked and this looks very similar even if chr2/A/B is removed, and across chrs
t.test(filter(TADs.20$domains, species=="human")$size, filter(TADs.20$domains, species=="chimp")$size)

ggplot(data=TADs.10$domains) + geom_density(aes(x=size, group=ID, color=species, y=..scaled..)) + ggtitle("TAD Size Distributions by Species, 100kb Windows") + xlab("TAD Size") + ylab("Density") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=1000000, y=0.5, label="< 2.2 e -16") + coord_cartesian(xlim=c(0, 1500000)) #+ facet_wrap(~chr) #Already checked and this looks very similar even if chr2/A/B is removed, and across chrs
t.test(filter(TADs.10$domains, species=="human")$size, filter(TADs.10$domains, species=="chimp")$size)

ggplot(data=TADs.5$domains) + geom_density(aes(x=size, group=ID, color=species, y=..scaled..)) + ggtitle("TAD Size Distributions by Species, 50kb Windows") + xlab("TAD Size") + ylab("Density") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=1000000, y=0.5, label="< 2.2 e -16") + coord_cartesian(xlim=c(0, 1250000)) #+ facet_wrap(~chr) #Already checked and this looks very similar even if chr2/A/B is removed, and across chrs
t.test(filter(TADs.5$domains, species=="human")$size, filter(TADs.5$domains, species=="chimp")$size)

#TAD size by chr...
ggplot(data=TADs.20$domains) + geom_density(aes(x=size, group=ID, color=species, y=..scaled..)) + ggtitle("TAD Size Distributions by Species, 200kb Windows") + xlab("TAD Size") + ylab("Density") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=1000000, y=0.5, label="< 2.2 e -16") + facet_wrap(~chr)

#Repeat all TAD analyses, but on the boundaries instead of the domains:
#Total TADs
ggplot(data=TADs.overall) + geom_line(aes(x=window, group=individuals, y=total.bounds, color=species)) + ggtitle("Total # of TAD Boundaries Called by Window Size Used") + xlab("Window Size (kb)") + ylab("Total Number of TAD Boundaries") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=50, y=750, label="0.07", size=3) + annotate("text", x=100, y=1275, label="0.01", size=3) + annotate("text", x=200, y=1525, label="4.1 e -5", size=3)
t.test(TADs.20$stats$total.bounds[c(1:2, 5:6)], TADs.20$stats$total.bounds[c(3:4, 7:8)])
t.test(TADs.10$stats$total.bounds[c(1:2, 5:6)], TADs.10$stats$total.bounds[c(3:4, 7:8)])
t.test(TADs.5$stats$total.bounds[c(1:2, 5:6)], TADs.5$stats$total.bounds[c(3:4, 7:8)])

#Mean Boundary Size
ggplot(data=TADs.overall) + geom_line(aes(x=window, group=individuals, y=mean.bound.size, color=species)) + ggtitle("Mean Boundary Size by Window Size Used") + xlab("Window Size (kb)") + ylab("Mean Boundary Size") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=50, y=22000, label="0.31", size=3) + annotate("text", x=100, y=30000, label="0.9", size=3) + annotate("text", x=200, y=74000, label="0.09", size=3)
t.test(TADs.20$stats$mean.bound.size[c(1:2, 5:6)], TADs.20$stats$mean.bound.size[c(3:4, 7:8)])$p.value
t.test(TADs.10$stats$mean.bound.size[c(1:2, 5:6)], TADs.10$stats$mean.bound.size[c(3:4, 7:8)])$p.value
t.test(TADs.5$stats$mean.bound.size[c(1:2, 5:6)], TADs.5$stats$mean.bound.size[c(3:4, 7:8)])$p.value

#Boundary Size distributions
ggplot(data=TADs.20$boundaries) + geom_density(aes(x=size, group=ID, color=species, y=..scaled..)) + ggtitle("Boundary Size Distributions by Species, 200kb Windows") + xlab("Boundary Size") + ylab("Density") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=150000, y=0.5, label=signif(t.test(filter(TADs.20$boundaries, species=="human")$size, filter(TADs.20$boundaries, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 300000))#Already checked and this looks very similar even if chr2/A/B is removed, and across chrs

ggplot(data=TADs.10$boundaries) + geom_density(aes(x=size, group=ID, color=species, y=..scaled..)) + ggtitle("Boundary Size Distributions by Species, 100kb Windows") + xlab("Boundary Size") + ylab("Density") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=70000, y=0.5, label=signif(t.test(filter(TADs.10$boundaries, species=="human")$size, filter(TADs.10$boundaries, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 150000)) #+ facet_wrap(~chr) #Already checked and this looks very similar even if chr2/A/B is removed, and across chrs

ggplot(data=TADs.5$boundaries) + geom_density(aes(x=size, group=ID, color=species, y=..scaled..)) + ggtitle("Boundary Size Distributions by Species, 50kb Windows") + xlab("Boundary Size") + ylab("Density") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + annotate("text", x=1000000, y=0.5, label="< 2.2 e -16") + coord_cartesian(xlim=c(0, 1250000)) #+ facet_wrap(~chr) #Already checked and this looks very similar even if chr2/A/B is removed, and across chrs
t.test(filter(TADs.5$boundaries, species=="human")$size, filter(TADs.5$boundaries, species=="chimp")$size)

#Boundary Size by chr...
ggplot(data=TADs.20$boundaries) + geom_density(aes(x=size, group=ID, color=species, y=..scaled..)) + ggtitle("Boundary Size Distributions by Species, 200kb Windows") + xlab("Boundary Size") + ylab("Density") + scale_color_manual("Species", values=c("red", "blue"), labels=c("Chimpanzee", "Human")) + facet_wrap(~chr)#+ annotate("text", x=1000000, y=0.5, label="< 2.2 e -16") + facet_wrap(~chr)

#Do it on ONLY ortho regions: Need to just do a basic re-run of this comparison on ortho boundaries in the orthos folder of /Users/ittaieres/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM, and also on the domains files. Also need to do intersects on domains files to find % consesrvation amongst orthologous TADs.
TAD.stats.ortho <- function(window){
  H1s <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/orthos/", window, "/H1s.final.merged.bed.ortho.hg38", sep=""), header=FALSE, data.table=FALSE)
  H2s <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/orthos/", window, "/H2s.final.merged.bed.ortho.hg38", sep=""), header=FALSE, data.table=FALSE)
  H3s <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/orthos/", window, "/H3s.final.merged.bed.ortho.hg38", sep=""), header=FALSE, data.table=FALSE)
  H4s <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/orthos/", window, "/H4s.final.merged.bed.ortho.hg38", sep=""), header=FALSE, data.table=FALSE, sep="\t")
  C1s <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/orthos/", window, "/C1s.final.merged.bed.ortho.panTro5", sep=""), header=FALSE, data.table=FALSE)
  C2s <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/orthos/", window, "/C2s.final.merged.bed.ortho.panTro5", sep=""), header=FALSE, data.table=FALSE)
  C3s <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/orthos/", window, "/C3s.final.merged.bed.ortho.panTro5", sep=""), header=FALSE, data.table=FALSE)
  C4s <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/orthos/", window, "/C4s.final.merged.bed.ortho.panTro5", sep=""), header=FALSE, data.table=FALSE, sep="\t")
  H4s <- H4s[,1:3]
  C4s <- C4s[,1:3]
  colnames(H1s) <- colnames(H2s) <- colnames(H3s) <- colnames(H4s) <- colnames(C1s) <- colnames(C2s) <- colnames(C3s) <- colnames(C4s) <- c("chr", "start", "end")
  H1s$size <- H1s$end-H1s$start
  H2s$size <- H2s$end-H2s$start
  H3s$size <- H3s$end-H3s$start
  H4s$size <- H4s$end-H4s$start
  C1s$size <- C1s$end-C1s$start
  C2s$size <- C2s$end-C2s$start
  C3s$size <- C3s$end-C3s$start
  C4s$size <- C4s$end-C4s$start
  H1s$species <- H2s$species <- H3s$species <- H4s$species <- "human"
  C1s$species <- C2s$species <- C3s$species <- C4s$species <- "chimp"
  
  broad.stats <- data.frame(sets=c("H1s", "H2s", "H3s", "H4s", "C1s", "C2s", "C3s", "C4s"), total.TADs=c(nrow(H1s), nrow(H2s), nrow(H3s), nrow(H4s), nrow(C1s), nrow(C2s), nrow(C3s), nrow(C4s)), mean.TAD.size=c(mean(H1s$size), mean(H2s$size), mean(H3s$size), mean(H4s$size), mean(C1s$size), mean(C2s$size), mean(C3s$size), mean(C4s$size)), species=c("human", "human", "human", "human", "chimp", "chimp", "chimp", "chimp"), window=window, stringency=c(1, 2, 3, 4, 1, 2, 3, 4))
  
  result <- list(stats=broad.stats, ones=rbind(H1s, C1s), twos=rbind(H2s, C2s), threes=rbind(H3s, C3s), fours=rbind(H4s, C4s))
  return(result)
  
}

bounds.5 <- TAD.stats.ortho(5)
bounds.10 <- TAD.stats.ortho(10)
bounds.20 <- TAD.stats.ortho(20)

ggboundstats <- rbind(bounds.5$stats, bounds.10$stats, bounds.20$stats)

#Visualize total boundaries found:
ggplot(data=bounds.5$stats) + geom_line(aes(x=stringency, y=total.TADs, color=species)) + xlab("Stringency, # Individuals") + ylab("Total # TAD Boundaries Found") + ggtitle("Number of TAD Boundaries in Each Species vs. Stringency, 50kb")
ggplot(data=bounds.10$stats) + geom_line(aes(x=stringency, y=total.TADs, color=species)) + xlab("Stringency, # Individuals") + ylab("Total # TAD Boundaries Found") + ggtitle("Number of TAD Boundaries in Each Species vs. Stringency, 100kb")
ggplot(data=bounds.20$stats) + geom_line(aes(x=stringency, y=total.TADs, color=species)) + xlab("Stringency, # Individuals") + ylab("Total # TAD Boundaries Found") + ggtitle("Number of TAD Boundaries in Each Species vs. Stringency, 200kb")

#Visualize mean tad boundaries sizes:
ggplot(data=bounds.5$stats) + geom_line(aes(x=stringency, y=mean.TAD.size, color=species)) + xlab("Stringency, # Individuals") + ylab("Mean TAD Boundary Size") + ggtitle("Mean Boundary Size in Each Species vs. Stringency, 50kb")
ggplot(data=bounds.10$stats) + geom_line(aes(x=stringency, y=mean.TAD.size, color=species)) + xlab("Stringency, # Individuals") + ylab("Mean TAD Boundary Size") + ggtitle("Mean Boundary Size in Each Species vs. Stringency, 100kb")
ggplot(data=bounds.20$stats) + geom_line(aes(x=stringency, y=mean.TAD.size, color=species)) + xlab("Stringency, # Individuals") + ylab("Mean TAD Boundary Size") + ggtitle("Mean Boundary Size in Each Species vs. Stringency, 200kb")

#Now visualize and test boundary size differences in the different sets between species:
ggplot(data=bounds.20$ones) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.20$ones, species=="human")$size, filter(bounds.20$ones, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("200kb TAD Boundary Size Distributions by Species | 1")
ggplot(data=bounds.20$twos) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.20$twos, species=="human")$size, filter(bounds.20$twos, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("200kb TAD Boundary Size Distributions by Species | 2")
ggplot(data=bounds.20$threes) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.20$threes, species=="human")$size, filter(bounds.20$threes, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("200kb TAD Boundary Size Distributions by Species | 3")
ggplot(data=bounds.20$fours) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.20$fours, species=="human")$size, filter(bounds.20$fours, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("200kb TAD Boundary Size Distributions by Species | 4")

ggplot(data=bounds.10$ones) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.10$ones, species=="human")$size, filter(bounds.10$ones, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("100kb TAD Boundary Size Distributions by Species | 1")
ggplot(data=bounds.10$twos) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.10$twos, species=="human")$size, filter(bounds.10$twos, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("100kb TAD Boundary Size Distributions by Species | 2")
ggplot(data=bounds.10$threes) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.10$threes, species=="human")$size, filter(bounds.10$threes, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("100kb TAD Boundary Size Distributions by Species | 3")
ggplot(data=bounds.10$fours) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.10$fours, species=="human")$size, filter(bounds.10$fours, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("100kb TAD Boundary Size Distributions by Species | 4")

ggplot(data=bounds.5$ones) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.5$ones, species=="human")$size, filter(bounds.5$ones, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("50kb TAD Boundary Size Distributions by Species | 1")
ggplot(data=bounds.5$twos) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.5$twos, species=="human")$size, filter(bounds.5$twos, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("50kb TAD Boundary Size Distributions by Species | 2")
ggplot(data=bounds.5$threes) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.5$threes, species=="human")$size, filter(bounds.5$threes, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("50kb TAD Boundary Size Distributions by Species | 3")
ggplot(data=bounds.5$fours) + geom_density(aes(x=size, color=species, y=..scaled..)) + xlab("Size") + ylab("Density") + annotate("text", x=250000, y=0.5, label=signif(t.test(filter(bounds.5$fours, species=="human")$size, filter(bounds.5$fours, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0, 500000)) + ggtitle("50kb TAD Boundary Size Distributions by Species | 4")


######Final TAD function to do all this work for me in the conserved RBHLO domains!
ortho.TAD.domains <- function(window){
 A_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/domains/", window,"/trueortho/A-21792_TOPDOM_ALL.", window, ".domain.domains.clean.ortho.hg38", sep=""), header=TRUE, data.table=FALSE)
  B_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/domains/", window, "/trueortho/B-28126_TOPDOM_ALL.", window, ".domain.domains.clean.ortho.hg38", sep=""), header=TRUE, data.table=FALSE)
  C_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/domains/", window, "/trueortho/C-3649_TOPDOM_ALL.", window, ".domain.domains.clean.ortho.panTro5", sep=""), header=TRUE, data.table=FALSE)
  D_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/domains/", window, "/trueortho/D-40300_TOPDOM_ALL.", window, ".domain.domains.clean.ortho.panTro5", sep=""), header=TRUE, data.table=FALSE)
  E_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/domains/", window, "/trueortho/E-28815_TOPDOM_ALL.", window, ".domain.domains.clean.ortho.hg38", sep=""), header=TRUE, data.table=FALSE)
  F_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/domains/", window, "/trueortho/F-28834_TOPDOM_ALL.", window, ".domain.domains.clean.ortho.hg38", sep=""), header=TRUE, data.table=FALSE)
  G_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/domains/", window, "/trueortho/G-3624_TOPDOM_ALL.", window, ".domain.domains.clean.ortho.panTro5", sep=""), header=TRUE, data.table=FALSE)
  H_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/domains/", window, "/trueortho/H-3651_TOPDOM_ALL.", window, ".domain.domains.clean.ortho.panTro5", sep=""), header=TRUE, data.table=FALSE)
  
    colnames(A_TAD) <- colnames(B_TAD) <- colnames(C_TAD) <- colnames(D_TAD) <- colnames(E_TAD) <- colnames(F_TAD) <- colnames(G_TAD) <- colnames(H_TAD) <- c("chr", "start", "end")
  A_TAD$species <- B_TAD$species <- E_TAD$species <- F_TAD$species <- "human"
  C_TAD$species <- D_TAD$species <- G_TAD$species <- H_TAD$species <- "chimp"
  A_TAD$ID <- "A"
  B_TAD$ID <- "B"
  C_TAD$ID <- "C"
  D_TAD$ID <- "D"
  E_TAD$ID <- "E"
  F_TAD$ID <- "F"
  G_TAD$ID <- "G"
  H_TAD$ID <- "H"
  A_TAD$size <- A_TAD$end-A_TAD$start
  B_TAD$size <- B_TAD$end-B_TAD$start
  C_TAD$size <- C_TAD$end-C_TAD$start
  D_TAD$size <- D_TAD$end-D_TAD$start
  E_TAD$size <- E_TAD$end-E_TAD$start
  F_TAD$size <- F_TAD$end-F_TAD$start
  G_TAD$size <- G_TAD$end-G_TAD$start
  H_TAD$size <- H_TAD$end-H_TAD$start
  
  
  ggdomains <- rbind(select(A_TAD, chr, size, species, ID), select(B_TAD, chr, size, species, ID), select(C_TAD, chr, size, species, ID), select(D_TAD, chr, size, species, ID), select(E_TAD, chr, size, species, ID), select(F_TAD, chr, size, species, ID), select(G_TAD, chr, size, species, ID), select(H_TAD, chr, size, species, ID))
  
  broad.stats <- data.frame(individuals=c("A", "B", "C", "D", "E", "F", "G", "H"), species=c("human", "human", "chimp", "chimp", "human", "human", "chimp", "chimp"), total.TADs=c(nrow(A_TAD), nrow(B_TAD), nrow(C_TAD), nrow(D_TAD), nrow(E_TAD), nrow(F_TAD), nrow(G_TAD), nrow(H_TAD)), mean.TAD.size=c(mean(A_TAD$size), mean(B_TAD$size), mean(C_TAD$size), mean(D_TAD$size), mean(E_TAD$size), mean(F_TAD$size), mean(G_TAD$size), mean(H_TAD$size)))
  
  result <- list(stats=broad.stats, domains=ggdomains)
  return(result)
  
}

result.20 <- ortho.TAD.domains(20)
result.10 <- ortho.TAD.domains(10)
result.5 <- ortho.TAD.domains(5)
result.20$stats$window <- 200
result.10$stats$window <- 100
result.5$stats$window <- 50

ggdomainstats <- rbind(result.5$stats, result.10$stats, result.20$stats)

#Visualize total domains found:
ggplot(data=ggdomainstats) + geom_line(aes(x=window, y=total.TADs, color=species, group=individuals)) + xlab("TopDom Window Size Used (kb)") + ylab("Total # TADs Found") + ggtitle("Number of TADs in Each Species by Window Size") + annotate("text", x=50, y=12500, label=signif(t.test(filter(ggdomainstats, window==50, species=="human")$total.TADs, filter(ggdomainstats, window==50, species=="chimp")$total.TADs)$p.value,2), size=3) + annotate("text", x=100, y=13500, label=signif(t.test(filter(ggdomainstats, window==100, species=="human")$total.TADs, filter(ggdomainstats, window==100, species=="chimp")$total.TADs)$p.value,2), size=3) + annotate("text", x=200, y=10000, label=signif(t.test(filter(ggdomainstats, window==200, species=="human")$total.TADs, filter(ggdomainstats, window==200, species=="chimp")$total.TADs)$p.value,2), size=3)

#Same thing, but for mean TAD size rather than total number found:
ggplot(data=ggdomainstats) + geom_line(aes(x=window, y=mean.TAD.size, color=species, group=individuals)) + xlab("TopDom Window Size Used (kb)") + ylab("Mean TAD Size") + ggtitle("Mean TAD Size in Each Species by Window Size") + annotate("text", x=50, y=125000, label=signif(t.test(filter(ggdomainstats, window==50, species=="human")$mean.TAD.size, filter(ggdomainstats, window==50, species=="chimp")$mean.TAD.size)$p.value,2), size=3) + annotate("text", x=100, y=185000, label=signif(t.test(filter(ggdomainstats, window==100, species=="human")$mean.TAD.size, filter(ggdomainstats, window==100, species=="chimp")$mean.TAD.size)$p.value,2), size=3) + annotate("text", x=195, y=250000, label=signif(t.test(filter(ggdomainstats, window==200, species=="human")$mean.TAD.size, filter(ggdomainstats, window==200, species=="chimp")$mean.TAD.size)$p.value,2), size=3)

#Finally, direct assessment of TAD sizes:
ggplot(data=result.20$domains) + geom_density(aes(x=size, y=..scaled.., color=species, group=ID)) + ylab("Density") + xlab("TAD Size") + ggtitle("TAD Size Distributions, Humans vs. Chimps, 200 kb Window") + annotate("text", x=1000000, y=0.5, label="< 2.2 e -16") + coord_cartesian(xlim=c(0,2000000))

t.test(filter(result.20$domains, species=="human")$size, filter(result.20$domains, species=="chimp")$size)$p.value

#Test these same metrics again, but this time on Lindsey's data--looking for significant difference in TAD sizes compared to my human dist'n. Note that LEM's data is using w=5, as their resolution is 40kb (so 200kb window size for each of us, I'm 10kb res w/ w=20).
LEMTAD <- fread("~/Desktop/Hi-C/LEM_TADs/TADs-domain-WG-iPSC-combined-40kb-w5.bed", header=FALSE, data.table=FALSE)
LEMTAD$size <- LEMTAD$V3-LEMTAD$V2
LEMTAD$type <- "LEM"
ggcompare <- data.frame(size=filter(result.20$domains, species=="human")$size, type="IEE")
chimpgg <- data.frame(size=filter(result.20$domains, species=="chimp")$size, type="chimp")
ggcomparer <- rbind(ggcompare, LEMTAD[,5:6], chimpgg)
ggplot(data=ggcomparer) + geom_density(aes(x=size, y=..scaled.., color=type)) + ylab("Density") + xlab("TAD Size") + ggtitle("TAD Size Distn's, IEE vs. LEM")

t.test(filter(result.20$domains, species=="chimp")$size, filter(ggcomparer, type=="LEM")$size)

#Confirms the effect I'm seeing (significantly smaller TADs in chimps) is not just specific to my experiment!

#####MORE TopDOM, but done on 25kb resolution matrices!
ortho.TAD.domains <- function(window){
 A_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/25kb/", window,"/A-21792_TOPDOM_ALL.domain.domains.clean.ortho.hg38", sep=""), header=TRUE, data.table=FALSE)
  B_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/25kb/", window, "/B-28126_TOPDOM_ALL.domain.domains.clean.ortho.hg38", sep=""), header=TRUE, data.table=FALSE)
  C_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/25kb/", window, "/C-3649_TOPDOM_ALL.domain.domains.clean.ortho.panTro5", sep=""), header=TRUE, data.table=FALSE)
  D_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/25kb/", window, "/D-40300_TOPDOM_ALL.domain.domains.clean.ortho.panTro5", sep=""), header=TRUE, data.table=FALSE)
  E_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/25kb/", window, "/E-28815_TOPDOM_ALL.domain.domains.clean.ortho.hg38", sep=""), header=TRUE, data.table=FALSE)
  F_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/25kb/", window, "/F-28834_TOPDOM_ALL.domain.domains.clean.ortho.hg38", sep=""), header=TRUE, data.table=FALSE)
  G_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/25kb/", window, "/G-3624_TOPDOM_ALL.domain.domains.clean.ortho.panTro5", sep=""), header=TRUE, data.table=FALSE)
  H_TAD <- fread(paste("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/25kb/", window, "/H-3651_TOPDOM_ALL.domain.domains.clean.ortho.panTro5", sep=""), header=TRUE, data.table=FALSE)
  
    colnames(A_TAD) <- colnames(B_TAD) <- colnames(C_TAD) <- colnames(D_TAD) <- colnames(E_TAD) <- colnames(F_TAD) <- colnames(G_TAD) <- colnames(H_TAD) <- c("chr", "start", "end")
  A_TAD$species <- B_TAD$species <- E_TAD$species <- F_TAD$species <- "human"
  C_TAD$species <- D_TAD$species <- G_TAD$species <- H_TAD$species <- "chimp"
  A_TAD$ID <- "A"
  B_TAD$ID <- "B"
  C_TAD$ID <- "C"
  D_TAD$ID <- "D"
  E_TAD$ID <- "E"
  F_TAD$ID <- "F"
  G_TAD$ID <- "G"
  H_TAD$ID <- "H"
  A_TAD$size <- A_TAD$end-A_TAD$start
  B_TAD$size <- B_TAD$end-B_TAD$start
  C_TAD$size <- C_TAD$end-C_TAD$start
  D_TAD$size <- D_TAD$end-D_TAD$start
  E_TAD$size <- E_TAD$end-E_TAD$start
  F_TAD$size <- F_TAD$end-F_TAD$start
  G_TAD$size <- G_TAD$end-G_TAD$start
  H_TAD$size <- H_TAD$end-H_TAD$start
  
  
  ggdomains <- rbind(select(A_TAD, chr, size, species, ID), select(B_TAD, chr, size, species, ID), select(C_TAD, chr, size, species, ID), select(D_TAD, chr, size, species, ID), select(E_TAD, chr, size, species, ID), select(F_TAD, chr, size, species, ID), select(G_TAD, chr, size, species, ID), select(H_TAD, chr, size, species, ID))
  
  broad.stats <- data.frame(individuals=c("A", "B", "C", "D", "E", "F", "G", "H"), species=c("human", "human", "chimp", "chimp", "human", "human", "chimp", "chimp"), total.TADs=c(nrow(A_TAD), nrow(B_TAD), nrow(C_TAD), nrow(D_TAD), nrow(E_TAD), nrow(F_TAD), nrow(G_TAD), nrow(H_TAD)), mean.TAD.size=c(mean(A_TAD$size), mean(B_TAD$size), mean(C_TAD$size), mean(D_TAD$size), mean(E_TAD$size), mean(F_TAD$size), mean(G_TAD$size), mean(H_TAD$size)))
  
  result <- list(stats=broad.stats, domains=ggdomains)
  return(result)
  
}

result.20 <- ortho.TAD.domains(20)
result.15 <- ortho.TAD.domains(15)
result.10 <- ortho.TAD.domains(10)
result.5 <- ortho.TAD.domains(5)
result.20$stats$window <- 500
result.15$stats$window <- 375
result.10$stats$window <- 250
result.5$stats$window <- 125


ggdomainstats <- rbind(result.5$stats, result.10$stats, result.15$stats, result.20$stats)

#Visualize total domains found:
ggplot(data=ggdomainstats) + geom_line(aes(x=window, y=total.TADs, color=species, group=individuals)) + xlab("TopDom Window Size Used (kb)") + ylab("Total # TADs Found") + ggtitle("Number of TADs in Each Species by Window Size") + annotate("text", x=125, y=9000, label=signif(t.test(filter(ggdomainstats, window==125, species=="human")$total.TADs, filter(ggdomainstats, window==125, species=="chimp")$total.TADs)$p.value,2), size=3) + annotate("text", x=250, y=13500, label=signif(t.test(filter(ggdomainstats, window==250, species=="human")$total.TADs, filter(ggdomainstats, window==250, species=="chimp")$total.TADs)$p.value,2), size=3) + annotate("text", x=375, y=10000, label=signif(t.test(filter(ggdomainstats, window==375, species=="human")$total.TADs, filter(ggdomainstats, window==375, species=="chimp")$total.TADs)$p.value,2), size=3) + annotate("text", x=500, y=10000, label=signif(t.test(filter(ggdomainstats, window==500, species=="human")$total.TADs, filter(ggdomainstats, window==500, species=="chimp")$total.TADs)$p.value,2), size=3)

#Same thing, but for mean TAD size rather than total number found:
ggplot(data=ggdomainstats) + geom_line(aes(x=window, y=mean.TAD.size, color=species, group=individuals)) + xlab("TopDom Window Size Used (kb)") + ylab("Mean TAD Size") + ggtitle("Mean TAD Size in Each Species by Window Size") + annotate("text", x=50, y=125000, label=signif(t.test(filter(ggdomainstats, window==50, species=="human")$mean.TAD.size, filter(ggdomainstats, window==50, species=="chimp")$mean.TAD.size)$p.value,2), size=3) + annotate("text", x=100, y=185000, label=signif(t.test(filter(ggdomainstats, window==100, species=="human")$mean.TAD.size, filter(ggdomainstats, window==100, species=="chimp")$mean.TAD.size)$p.value,2), size=3) + annotate("text", x=195, y=250000, label=signif(t.test(filter(ggdomainstats, window==200, species=="human")$mean.TAD.size, filter(ggdomainstats, window==200, species=="chimp")$mean.TAD.size)$p.value,2), size=3)

#Finally, direct assessment of TAD sizes:
ggplot(data=result.15$domains) + geom_density(aes(x=size, y=..scaled.., color=species, group=ID)) + ylab("Density") + xlab("TAD Size") + ggtitle("TAD Size Distributions, Humans vs. Chimps, 200 kb Window") + annotate("text", x=1000000, y=0.5, label=signif(t.test(filter(result.20$domains, species=="human")$size, filter(result.20$domains, species=="chimp")$size)$p.value, 2)) + coord_cartesian(xlim=c(0,2000000))

t.test(filter(result.20$domains, species=="human")$size, filter(result.20$domains, species=="chimp")$size)


############JUICER ARROWHEAD TAD ANALYSIS############
ATAD <- fread("~/Desktop/Hi-C/ARROWTADs/A-21792.domains", data.table = FALSE)
ATAD.ortho <- fread("~/Desktop/Hi-C/ARROWTADs/A-21792.domains.ortho.hg38", data.table = FALSE)
BTAD <- fread("~/Desktop/Hi-C/ARROWTADs/B-28126.domains", data.table = FALSE)
BTAD.ortho <- fread("~/Desktop/Hi-C/ARROWTADs/B-28126.domains.ortho.hg38", data.table = FALSE)
CTAD <- fread("~/Desktop/Hi-C/ARROWTADs/C-3649.domains", data.table=FALSE)
CTAD.ortho <- fread("~/Desktop/Hi-C/ARROWTADs/C-3649.domains.ortho.panTro5")
DTAD <- fread("~/Desktop/Hi-C/ARROWTADs/D-40300.domains", data.table=FALSE)
DTAD.ortho <- fread("~/Desktop/Hi-C/ARROWTADs/D-40300.domains.ortho.panTro5", data.table=FALSE)
ETAD <- fread("~/Desktop/Hi-C/ARROWTADs/E-28815.domains", data.table = FALSE)
ETAD.ortho <- fread("~/Desktop/Hi-C/ARROWTADs/E-28815.domains.ortho.hg38", data.table = FALSE)
FTAD <- fread("~/Desktop/Hi-C/ARROWTADs/F-28834.domains", data.table = FALSE)
FTAD.ortho <- fread("~/Desktop/Hi-C/ARROWTADs/F-28834.domains.ortho.hg38", data.table = FALSE)
GTAD <- fread("~/Desktop/Hi-C/ARROWTADs/G-3624.domains", data.table = FALSE)
GTAD.ortho <- fread("~/Desktop/Hi-C/ARROWTADs/G-3624.domains.ortho.panTro5", data.table=FALSE)
HTAD <- fread("~/Desktop/Hi-C/ARROWTADs/H-3651.domains", data.table=FALSE)
HTAD.ortho <- fread("~/Desktop/Hi-C/ARROWTADs/H-3651.domains.ortho.panTro5", data.table=FALSE)

sizer <- function(df, spec, indi){
  colnames(df) <- c("chr", "start", "end")
  df$size <- df$end-df$start
  df$species <- spec
  df$ID <- indi
  df$total.TADs <- nrow(df)
  df$mean.size <- mean(df$size)
  return(df)
}

ATAD <- sizer(ATAD, "human", "A")
ATAD.ortho <- sizer(ATAD.ortho, "human", "A")
BTAD <- sizer(BTAD, "human", "B")
BTAD.ortho <- sizer(BTAD.ortho, "human", "B")
CTAD <- sizer(CTAD, "chimpanzee", "C")
CTAD.ortho <- sizer(CTAD.ortho, "chimpanzee", "C")
DTAD <- sizer(DTAD, "chimpanzee", "D")
DTAD.ortho <- sizer(DTAD.ortho, "chimpanzee", "D")
ETAD <- sizer(ETAD, "human", "E")
ETAD.ortho <- sizer(ETAD.ortho, "human", "E")
FTAD <- sizer(FTAD, "human", "F")
FTAD.ortho <- sizer(FTAD.ortho, "human", "F")
GTAD <- sizer(GTAD, "chimpanzee", "G")
GTAD.ortho <- sizer(GTAD.ortho, "chimpanzee", "G")
HTAD <- sizer(HTAD, "chimpanzee", "H")
HTAD.ortho <- sizer(HTAD.ortho, "chimpanzee", "H")

ALLTADS <- rbind(ATAD, BTAD, CTAD, DTAD, ETAD, FTAD, GTAD, HTAD)
ORTHOTADS <- rbind(ATAD.ortho, BTAD.ortho, CTAD.ortho, DTAD.ortho, ETAD.ortho, FTAD.ortho, GTAD.ortho, HTAD.ortho)

#Don't bother looking at total TADs called and their mean sizes; not really the relevant comparison here. Just size dist'ns
ggplot(data=ALLTADS) + geom_density(aes(x=size, y=..scaled.., group=ID, color=species)) + ggtitle("ARROWHEAD TAD Size by Species") + xlab("ARROWHEAD TAD Size") + ylab("Density") + coord_cartesian(xlim=c(0, 1500000)) + annotate("text", x=1000000, y=0.5, label=signif(t.test(filter(ALLTADS, species=="human")$size, filter(ALLTADS, species=="chimpanzee")$size)$p.value, 2))

ggplot(data=ORTHOTADS) + geom_density(aes(x=size, y=..scaled.., group=ID, color=species)) + ggtitle("ARROWHEAD Orthologous TAD Size by Species") + xlab("ARROWHEAD Orthologous TAD Size") + ylab("Density") + coord_cartesian(xlim=c(0, 1500000)) + annotate("text", x=1000000, y=0.5, label=signif(t.test(filter(ORTHOTADS, species=="human")$size, filter(ORTHOTADS, species=="chimpanzee")$size)$p.value, 2))

#Total # Discovered
ggplot(data=ALLTADS) + geom_bar(aes(x=ID, fill=species)) + ggtitle("Total Number of ARROWHEAD TADs Called") + xlab("Individual") + ylab("Total # ARROWHEAD TADs") + coord_cartesian(ylim=c(0, 8100))

ggplot(data=ORTHOTADS) + geom_bar(aes(x=ID, fill=species)) + ggtitle("Total Number of Orthologus ARROWHEAD TADs Called") + xlab("Individual") + ylab("Total # Orthologous ARROWHEAD TADs") + coord_cartesian(ylim=c(0, 8100))

#Mean Sizes
sizedf <- data.frame(size=c(ATAD$mean.size[1], BTAD$mean.size[1], CTAD$mean.size[1], DTAD$mean.size[1], ETAD$mean.size[1], FTAD$mean.size[1], GTAD$mean.size[1], HTAD$mean.size[1]), species=c(rep("human", 2), rep("chimpanzee", 2),rep("human", 2), rep("chimpanzee", 2)), ID=c("A","B", "C", "D", "E", "F", "G", "H"))
ggplot(data=sizedf) + geom_bar(aes(x=ID, fill=species, y=size), stat="identity") + ggtitle("Mean TAD Size By Individual") + xlab("Individual") + ylab("Mean TAD Size") + annotate("text", x=3.5, y=370000, label=signif(t.test(filter(sizedf, species=="human")$size, filter(sizedf, species=="chimpanzee")$size)$p.value, 2))

sizedf.ortho <- data.frame(size=c(ATAD.ortho$mean.size[1], BTAD.ortho$mean.size[1], CTAD.ortho$mean.size[1], DTAD.ortho$mean.size[1], ETAD.ortho$mean.size[1], FTAD.ortho$mean.size[1], GTAD.ortho$mean.size[1], HTAD.ortho$mean.size[1]), species=c(rep("human", 2), rep("chimpanzee", 2),rep("human", 2), rep("chimpanzee", 2)), ID=c("A","B", "C", "D", "E", "F", "G", "H"))
ggplot(data=sizedf.ortho) + geom_bar(aes(x=ID, fill=species, y=size), stat="identity") + ggtitle("Mean Orthologous TAD Size By Individual") + xlab("Individual") + ylab("Mean Orthologous TAD Size") + annotate("text", x=3.5, y=375000, label=signif(t.test(filter(sizedf.ortho, species=="human")$size, filter(sizedf.ortho, species=="chimpanzee")$size)$p.value, 2))

######NOW, actually move to assess DE/DC status effects of boundaries and the like!:
#The ultimate command run is akin to (bedtools pairtobed -type notispan -a filt.bins.humans.bedPE -b TOPDOM/hbounds.final.bed > TOPDOM/hg38.TD.bounds.notispan.bed)


#Load in the pairs that are NOT interrupted by a TAD boundary! First using the agnostic approach where I just take all boundaries, and then for more stringent criteria (i.e. boundary found in at least 2 individuals, at least 3, or all 4)
TADcross.humans <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/5s_unions/hu.TD.bounds.notispan.1.bed")
TADcross.humans.2 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/5s_unions/hu.TD.bounds.notispan.2.bed")
TADcross.humans.3 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/5s_unions/hu.TD.bounds.notispan.3.bed")
TADcross.humans.4 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/5s_unions/hu.TD.bounds.notispan.4.bed")

TADcross.chimps <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/5s_unions/ch.TD.bounds.notispan.1.bed")
TADcross.chimps.2 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/5s_unions/ch.TD.bounds.notispan.2.bed")
TADcross.chimps.3 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/5s_unions/ch.TD.bounds.notispan.3.bed")
TADcross.chimps.4 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/5s_unions/ch.TD.bounds.notispan.4.bed")

full.annotations <- readRDS("~/Desktop/Hi-C/enrichdfs/full.data.annotations.RDS")

TADcross.humans$HpairID <- paste(paste(TADcross.humans$V1, TADcross.humans$V2, sep="-"), paste(TADcross.humans$V4, TADcross.humans$V5, sep="-"), sep="_")
TADcross.humans.2$HpairID <- paste(paste(TADcross.humans.2$V1, TADcross.humans.2$V2, sep="-"), paste(TADcross.humans.2$V4, TADcross.humans.2$V5, sep="-"), sep="_")
TADcross.humans.3$HpairID <- paste(paste(TADcross.humans.3$V1, TADcross.humans.3$V2, sep="-"), paste(TADcross.humans.3$V4, TADcross.humans.3$V5, sep="-"), sep="_")
TADcross.humans.4$HpairID <- paste(paste(TADcross.humans.4$V1, TADcross.humans.4$V2, sep="-"), paste(TADcross.humans.4$V4, TADcross.humans.4$V5, sep="-"), sep="_")

TADcross.chimps$CpairID <- paste(paste(TADcross.chimps$V1, TADcross.chimps$V2, sep="-"), paste(TADcross.chimps$V4, TADcross.chimps$V5, sep="-"), sep="_")
TADcross.chimps.2$CpairID <- paste(paste(TADcross.chimps.2$V1, TADcross.chimps.2$V2, sep="-"), paste(TADcross.chimps.2$V4, TADcross.chimps.2$V5, sep="-"), sep="_")
TADcross.chimps.3$CpairID <- paste(paste(TADcross.chimps.3$V1, TADcross.chimps.3$V2, sep="-"), paste(TADcross.chimps.3$V4, TADcross.chimps.3$V5, sep="-"), sep="_")
TADcross.chimps.4$CpairID <- paste(paste(TADcross.chimps.4$V1, TADcross.chimps.4$V2, sep="-"), paste(TADcross.chimps.4$V4, TADcross.chimps.4$V5, sep="-"), sep="_")

full.annotations$HTAD.interrupt <- ifelse(full.annotations$HpairID %in% TADcross.humans$HpairID, "no", "yes")
full.annotations$HTAD.interrupt.2 <- ifelse(full.annotations$HpairID %in% TADcross.humans.2$HpairID, "no", "yes")
full.annotations$HTAD.interrupt.3 <- ifelse(full.annotations$HpairID %in% TADcross.humans.3$HpairID, "no", "yes")
full.annotations$HTAD.interrupt.4 <- ifelse(full.annotations$HpairID %in% TADcross.humans.4$HpairID, "no", "yes")
full.annotations$CTAD.interrupt <- ifelse(full.annotations$CpairID %in% TADcross.chimps$CpairID, "no", "yes")
full.annotations$CTAD.interrupt.2 <- ifelse(full.annotations$CpairID %in% TADcross.chimps.2$CpairID, "no", "yes")
full.annotations$CTAD.interrupt.3 <- ifelse(full.annotations$CpairID %in% TADcross.chimps.3$CpairID, "no", "yes")
full.annotations$CTAD.interrupt.4 <- ifelse(full.annotations$CpairID %in% TADcross.chimps.4$CpairID, "no", "yes")

full.annotations$diff.TAD.interrupt <- ifelse(full.annotations$HTAD.interrupt==full.annotations$CTAD.interrupt, "no", "yes")
full.annotations$diff.TAD.interrupt.2 <- ifelse(full.annotations$HTAD.interrupt.2==full.annotations$CTAD.interrupt.2, "no", "yes")
full.annotations$diff.TAD.interrupt.3 <- ifelse(full.annotations$HTAD.interrupt.3==full.annotations$CTAD.interrupt.3, "no", "yes")
full.annotations$diff.TAD.interrupt.4 <- ifelse(full.annotations$HTAD.interrupt.4==full.annotations$CTAD.interrupt.4, "no", "yes")

chisq.summarizer <- function(df, col1, robust){
  DEtable <- table(df$DE, df[,col1], dnn=c("DE?", paste("TAD ", robust, " Boundary Cross Diff. b/t Species?", sep="")))
  promsDEtable <- table(filter(df, true.promoter=="yes")$DE, filter(df, true.promoter=="yes")[,col1], dnn=c("DE?", paste("TAD ", robust, " Boundary Cross Diff. b/t Species?", sep="")))
  DCtable <- table(df$DC, df[,col1], dnn=c("DC?", paste("TAD ", robust, " Boundary Cross Diff. b/t Species?", sep="")))
  promsDCtable <- table(filter(df, true.promoter=="yes")$DC, filter(df, true.promoter=="yes")[,col1], dnn=c("DC?", paste("TAD ", robust, " Boundary Cross Diff. b/t Species?", sep="")))
  print(paste("As seen in the table below, amongst all hits, ", signif((DEtable[2,2]/sum(DEtable[2,]))*100, 3), "% of DE contacts cross TAD boundaries | ", robust, "  differentially between species, while ", signif((DEtable[1,2]/sum(DEtable[1,]))*100, 3), "% of non-DE contacts do so. Alternatively, the contacts differentially crossing TAD boundaries | ", robust, "  are ", signif((DEtable[2,2]/sum(DEtable[,2]))*100, 3), "% DE, while those not crossing are ", signif((DEtable[2,1]/sum(DEtable[,1]))*100, 3), "% DE. This is chi-squared significant w/ p-val ", signif(chisq.test(DEtable)$p.val, 2), sep=""))
  print(DEtable)
  print(paste("As seen in the table below, amongst all hits, ", signif((DCtable[2,2]/sum(DCtable[2,]))*100, 3), "% of DC contacts cross TAD boundaries | ", robust, "  differentially between species, while ", signif((DCtable[1,2]/sum(DCtable[1,]))*100, 3), "% of non-DC contacts do so. Alternatively, the contacts differentially crossing TAD boundaries | ", robust, "  are ", signif((DCtable[2,2]/sum(DCtable[,2]))*100, 3), "% DC, while those not crossing are ", signif((DCtable[2,1]/sum(DCtable[,1]))*100, 3), "% DC. This is chi-squared significant w/ p-val ", signif(chisq.test(DCtable)$p.val, 2), sep=""))
  print(DCtable)
  print(paste("As seen in the table below, amongst promoter-contacting hits, ", signif((promsDEtable[2,2]/sum(promsDEtable[2,]))*100, 3), "% of DE contacts cross TAD boundaries | ", robust, "  differentially between species, while ", signif((promsDEtable[1,2]/sum(promsDEtable[1,]))*100, 3), "% of non-DE contacts do so. Alternatively, the contacts differentially crossing TAD boundaries | ", robust, "  are ", signif((promsDEtable[2,2]/sum(promsDEtable[,2]))*100, 3), "% DE, while those not crossing are ", signif((promsDEtable[2,1]/sum(promsDEtable[,1]))*100, 3), "% DE. This is chi-squared significant w/ p-val ", signif(chisq.test(promsDEtable)$p.val, 2), sep=""))
  print(promsDEtable)
  print(paste("As seen in the table below, amongst promoter-contacting hits, ", signif((promsDCtable[2,2]/sum(promsDCtable[2,]))*100, 3), "% of DC contacts cross TAD boundaries | ", robust, "  differentially between species, while ", signif((promsDCtable[1,2]/sum(promsDCtable[1,]))*100, 3), "% of non-DC contacts do so. Alternatively, the contacts differentially crossing TAD boundaries | ", robust, "  are ", signif((promsDCtable[2,2]/sum(promsDCtable[,2]))*100, 3), "% DC, while those not crossing are ", signif((promsDCtable[2,1]/sum(promsDCtable[,1]))*100, 3), "% DC. This is chi-squared significant w/ p-val ", signif(chisq.test(promsDCtable)$p.val, 2), sep=""))
  print(promsDCtable)
}

#Call the summarizer on all the different TAD boundary specs :)
chisq.summarizer(full.annotations, "diff.TAD.interrupt", 1)
chisq.summarizer(full.annotations, "diff.TAD.interrupt.2", 2)
chisq.summarizer(full.annotations, "diff.TAD.interrupt.3", 3)
chisq.summarizer(full.annotations, "diff.TAD.interrupt.4", 4)

#Now do the same thing again, but for window sizes of 5 and 10 instead!
TADcross.humans <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/10s_unions/hu.TD.bounds.notispan.1.bed")
TADcross.humans.2 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/10s_unions/hu.TD.bounds.notispan.2.bed")
TADcross.humans.3 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/10s_unions/hu.TD.bounds.notispan.3.bed")
TADcross.humans.4 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/10s_unions/hu.TD.bounds.notispan.4.bed")

TADcross.chimps <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/10s_unions/ch.TD.bounds.notispan.1.bed")
TADcross.chimps.2 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/10s_unions/ch.TD.bounds.notispan.2.bed")
TADcross.chimps.3 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/10s_unions/ch.TD.bounds.notispan.3.bed")
TADcross.chimps.4 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/10s_unions/ch.TD.bounds.notispan.4.bed")

full.annotations <- readRDS("~/Desktop/Hi-C/enrichdfs/full.data.annotations.RDS")

TADcross.humans$HpairID <- paste(paste(TADcross.humans$V1, TADcross.humans$V2, sep="-"), paste(TADcross.humans$V4, TADcross.humans$V5, sep="-"), sep="_")
TADcross.humans.2$HpairID <- paste(paste(TADcross.humans.2$V1, TADcross.humans.2$V2, sep="-"), paste(TADcross.humans.2$V4, TADcross.humans.2$V5, sep="-"), sep="_")
TADcross.humans.3$HpairID <- paste(paste(TADcross.humans.3$V1, TADcross.humans.3$V2, sep="-"), paste(TADcross.humans.3$V4, TADcross.humans.3$V5, sep="-"), sep="_")
TADcross.humans.4$HpairID <- paste(paste(TADcross.humans.4$V1, TADcross.humans.4$V2, sep="-"), paste(TADcross.humans.4$V4, TADcross.humans.4$V5, sep="-"), sep="_")

TADcross.chimps$CpairID <- paste(paste(TADcross.chimps$V1, TADcross.chimps$V2, sep="-"), paste(TADcross.chimps$V4, TADcross.chimps$V5, sep="-"), sep="_")
TADcross.chimps.2$CpairID <- paste(paste(TADcross.chimps.2$V1, TADcross.chimps.2$V2, sep="-"), paste(TADcross.chimps.2$V4, TADcross.chimps.2$V5, sep="-"), sep="_")
TADcross.chimps.3$CpairID <- paste(paste(TADcross.chimps.3$V1, TADcross.chimps.3$V2, sep="-"), paste(TADcross.chimps.3$V4, TADcross.chimps.3$V5, sep="-"), sep="_")
TADcross.chimps.4$CpairID <- paste(paste(TADcross.chimps.4$V1, TADcross.chimps.4$V2, sep="-"), paste(TADcross.chimps.4$V4, TADcross.chimps.4$V5, sep="-"), sep="_")

full.annotations$HTAD.interrupt <- ifelse(full.annotations$HpairID %in% TADcross.humans$HpairID, "no", "yes")
full.annotations$HTAD.interrupt.2 <- ifelse(full.annotations$HpairID %in% TADcross.humans.2$HpairID, "no", "yes")
full.annotations$HTAD.interrupt.3 <- ifelse(full.annotations$HpairID %in% TADcross.humans.3$HpairID, "no", "yes")
full.annotations$HTAD.interrupt.4 <- ifelse(full.annotations$HpairID %in% TADcross.humans.4$HpairID, "no", "yes")
full.annotations$CTAD.interrupt <- ifelse(full.annotations$CpairID %in% TADcross.chimps$CpairID, "no", "yes")
full.annotations$CTAD.interrupt.2 <- ifelse(full.annotations$CpairID %in% TADcross.chimps.2$CpairID, "no", "yes")
full.annotations$CTAD.interrupt.3 <- ifelse(full.annotations$CpairID %in% TADcross.chimps.3$CpairID, "no", "yes")
full.annotations$CTAD.interrupt.4 <- ifelse(full.annotations$CpairID %in% TADcross.chimps.4$CpairID, "no", "yes")

full.annotations$diff.TAD.interrupt <- ifelse(full.annotations$HTAD.interrupt==full.annotations$CTAD.interrupt, "no", "yes")
full.annotations$diff.TAD.interrupt.2 <- ifelse(full.annotations$HTAD.interrupt.2==full.annotations$CTAD.interrupt.2, "no", "yes")
full.annotations$diff.TAD.interrupt.3 <- ifelse(full.annotations$HTAD.interrupt.3==full.annotations$CTAD.interrupt.3, "no", "yes")
full.annotations$diff.TAD.interrupt.4 <- ifelse(full.annotations$HTAD.interrupt.4==full.annotations$CTAD.interrupt.4, "no", "yes")

chisq.summarizer(full.annotations, "diff.TAD.interrupt", 1)
chisq.summarizer(full.annotations, "diff.TAD.interrupt.2", 2)
chisq.summarizer(full.annotations, "diff.TAD.interrupt.3", 3)
chisq.summarizer(full.annotations, "diff.TAD.interrupt.4", 4)

###Now for window size of 5 (50kb total):
TADcross.humans <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/20s_unions/hu.TD.bounds.notispan.1.bed")
TADcross.humans.2 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/20s_unions/hu.TD.bounds.notispan.2.bed")
TADcross.humans.3 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/20s_unions/hu.TD.bounds.notispan.3.bed")
TADcross.humans.4 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/20s_unions/hu.TD.bounds.notispan.4.bed")

TADcross.chimps <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/20s_unions/ch.TD.bounds.notispan.1.bed")
TADcross.chimps.2 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/20s_unions/ch.TD.bounds.notispan.2.bed")
TADcross.chimps.3 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/20s_unions/ch.TD.bounds.notispan.3.bed")
TADcross.chimps.4 <- fread("~/Desktop/Hi-C/pgltoolswork/new_updated/TOPDOM/20s_unions/ch.TD.bounds.notispan.4.bed")

full.annotations <- readRDS("~/Desktop/Hi-C/enrichdfs/full.data.annotations.RDS")

TADcross.humans$HpairID <- paste(paste(TADcross.humans$V1, TADcross.humans$V2, sep="-"), paste(TADcross.humans$V4, TADcross.humans$V5, sep="-"), sep="_")
TADcross.humans.2$HpairID <- paste(paste(TADcross.humans.2$V1, TADcross.humans.2$V2, sep="-"), paste(TADcross.humans.2$V4, TADcross.humans.2$V5, sep="-"), sep="_")
TADcross.humans.3$HpairID <- paste(paste(TADcross.humans.3$V1, TADcross.humans.3$V2, sep="-"), paste(TADcross.humans.3$V4, TADcross.humans.3$V5, sep="-"), sep="_")
TADcross.humans.4$HpairID <- paste(paste(TADcross.humans.4$V1, TADcross.humans.4$V2, sep="-"), paste(TADcross.humans.4$V4, TADcross.humans.4$V5, sep="-"), sep="_")

TADcross.chimps$CpairID <- paste(paste(TADcross.chimps$V1, TADcross.chimps$V2, sep="-"), paste(TADcross.chimps$V4, TADcross.chimps$V5, sep="-"), sep="_")
TADcross.chimps.2$CpairID <- paste(paste(TADcross.chimps.2$V1, TADcross.chimps.2$V2, sep="-"), paste(TADcross.chimps.2$V4, TADcross.chimps.2$V5, sep="-"), sep="_")
TADcross.chimps.3$CpairID <- paste(paste(TADcross.chimps.3$V1, TADcross.chimps.3$V2, sep="-"), paste(TADcross.chimps.3$V4, TADcross.chimps.3$V5, sep="-"), sep="_")
TADcross.chimps.4$CpairID <- paste(paste(TADcross.chimps.4$V1, TADcross.chimps.4$V2, sep="-"), paste(TADcross.chimps.4$V4, TADcross.chimps.4$V5, sep="-"), sep="_")

full.annotations$HTAD.interrupt <- ifelse(full.annotations$HpairID %in% TADcross.humans$HpairID, "no", "yes")
full.annotations$HTAD.interrupt.2 <- ifelse(full.annotations$HpairID %in% TADcross.humans.2$HpairID, "no", "yes")
full.annotations$HTAD.interrupt.3 <- ifelse(full.annotations$HpairID %in% TADcross.humans.3$HpairID, "no", "yes")
full.annotations$HTAD.interrupt.4 <- ifelse(full.annotations$HpairID %in% TADcross.humans.4$HpairID, "no", "yes")
full.annotations$CTAD.interrupt <- ifelse(full.annotations$CpairID %in% TADcross.chimps$CpairID, "no", "yes")
full.annotations$CTAD.interrupt.2 <- ifelse(full.annotations$CpairID %in% TADcross.chimps.2$CpairID, "no", "yes")
full.annotations$CTAD.interrupt.3 <- ifelse(full.annotations$CpairID %in% TADcross.chimps.3$CpairID, "no", "yes")
full.annotations$CTAD.interrupt.4 <- ifelse(full.annotations$CpairID %in% TADcross.chimps.4$CpairID, "no", "yes")

full.annotations$diff.TAD.interrupt <- ifelse(full.annotations$HTAD.interrupt==full.annotations$CTAD.interrupt, "no", "yes")
full.annotations$diff.TAD.interrupt.2 <- ifelse(full.annotations$HTAD.interrupt.2==full.annotations$CTAD.interrupt.2, "no", "yes")
full.annotations$diff.TAD.interrupt.3 <- ifelse(full.annotations$HTAD.interrupt.3==full.annotations$CTAD.interrupt.3, "no", "yes")
full.annotations$diff.TAD.interrupt.4 <- ifelse(full.annotations$HTAD.interrupt.4==full.annotations$CTAD.interrupt.4, "no", "yes")

chisq.summarizer(full.annotations, "diff.TAD.interrupt", 1)
chisq.summarizer(full.annotations, "diff.TAD.interrupt.2", 2)
chisq.summarizer(full.annotations, "diff.TAD.interrupt.3", 3)
chisq.summarizer(full.annotations, "diff.TAD.interrupt.4", 4)
```


###Exploration of genes with or without an upstream contact
Here, I look at whether a gene's position along its overlapping Hi-C bin affects whether or not that gene will have an upstream contact in the significant Hi-C data. I also look to see if genes that contain an upstream contact in the Hi-C data have different expression dynamics than those that don't.
```{r Exploration of genes with or without an upstream contact}
##Exploration of genes that do or don't have an upstream contact. First, I simply add columns to gene.hic.overlap.info indicating the US FDR values for humans and chimps, as well as whether there is an US contact present in each species, either species, or both.
gene.hic.overlap.info$hUSFDR <- ifelse(gene.hic.overlap.info$Hstrand.H=="+", gene.hic.overlap.info$US_FDR.H, gene.hic.overlap.info$DS_FDR.H)
gene.hic.overlap.info$cUSFDR <- ifelse(gene.hic.overlap.info$Hstrand.C=="+", gene.hic.overlap.info$US_FDR.C, gene.hic.overlap.info$DS_FDR.C)
gene.hic.overlap.info$hUS_present <- ifelse(is.na(gene.hic.overlap.info$hUSFDR), "no", "yes")
gene.hic.overlap.info$cUS_present <- ifelse(is.na(gene.hic.overlap.info$cUSFDR), "no", "yes")
gene.hic.overlap.info$ALLUS_present <- ifelse((gene.hic.overlap.info$hUS_present=="yes"&gene.hic.overlap.info$cUS_present=="yes"), "yes", "no")
gene.hic.overlap.info$EITHERUS_present <- ifelse((gene.hic.overlap.info$hUS_present=="yes"&gene.hic.overlap.info$cUS_present=="no")|(gene.hic.overlap.info$hUS_present=="no"&gene.hic.overlap.info$cUS_present=="yes"), "yes", "no")
meandists <- select(gene.hic.overlap.info, bin_pos.H, bin_pos.C)
gene.hic.overlap.info$ave_bin_pos <- rowMeans(meandists, na.rm=TRUE)
gene.hic.overlap.info$UStype <- ifelse(gene.hic.overlap.info$ALLUS_present=="yes", "both", ifelse(gene.hic.overlap.info$EITHERUS_present=="yes", "one", "neither"))

#Set up the same thing with downstream FDR, just to see!
gene.hic.overlap.info$hDSFDR <- ifelse(gene.hic.overlap.info$Hstrand.H=="-", gene.hic.overlap.info$US_FDR.H, gene.hic.overlap.info$DS_FDR.H)
gene.hic.overlap.info$cDSFDR <- ifelse(gene.hic.overlap.info$Hstrand.C=="-", gene.hic.overlap.info$US_FDR.C, gene.hic.overlap.info$DS_FDR.C)
gene.hic.overlap.info$hDS_present <- ifelse(is.na(gene.hic.overlap.info$hDSFDR), "no", "yes")
gene.hic.overlap.info$cDS_present <- ifelse(is.na(gene.hic.overlap.info$cDSFDR), "no", "yes")
gene.hic.overlap.info$ALLDS_present <- ifelse((gene.hic.overlap.info$hDS_present=="yes"&gene.hic.overlap.info$cDS_present=="yes"), "yes", "no")
gene.hic.overlap.info$EITHERDS_present <- ifelse((gene.hic.overlap.info$hDS_present=="yes"&gene.hic.overlap.info$cDS_present=="no")|(gene.hic.overlap.info$hDS_present=="no"&gene.hic.overlap.info$cDS_present=="yes"), "yes", "no")
gene.hic.overlap.info$DStype <- ifelse(gene.hic.overlap.info$ALLDS_present=="yes", "both", ifelse(gene.hic.overlap.info$EITHERDS_present=="yes", "one", "neither"))

#Now, plot out where along a bin the TSS of each gene falls, separately for genes with and without an US contact. Also look at a variety of other things related to where along a chromosome the gene falls and that sort of thing, all leading to nothing.
plotdf <- select(gene.hic.overlap.info, "hUS_present", "cUS_present", EITHERUS_present, ALLUS_present, "bin_pos.H", "bin_pos.C", ave_bin_pos, UStype)
ggplot(data=plotdf) + geom_boxplot(aes(x=hUS_present, y=bin_pos.H, group=hUS_present)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Position of the gene TSS along the Hi-C bin") + ggtitle("Distribution of Genes' TSS Along Overlapping Hi-C Bin, Humans")
ggplot(data=plotdf) + geom_boxplot(aes(x=cUS_present, y=bin_pos.C, group=cUS_present)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Position of the gene TSS along the Hi-C bin") + ggtitle("Distribution of Genes' TSS Along Overlapping Hi-C Bin, Chimps")
ggplot(data=plotdf) + geom_density(aes(x=bin_pos.H, group=hUS_present, color=hUS_present, y=..scaled..)) + xlab("Position of the gene TSS along Hi-C bin") + ylab("Density") + ggtitle("Distributions of Genes' TSS Overlapping Hi-C Bin, Humans") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))
ggplot(data=plotdf) + geom_density(aes(x=bin_pos.C, group=cUS_present, color=cUS_present, y=..scaled..)) + xlab("Position of the gene TSS along Hi-C bin") + ylab("Density") + ggtitle("Distributions of Genes' TSS Overlapping Hi-C Bin, Chimps") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

ggplot(data=plotdf) + geom_density(aes(x=ave_bin_pos, group=UStype, color=UStype, y=..scaled..)) + xlab("Position of the gene TSS along Hi-C bin") + ylab("Density") + ggtitle("Distributions of Genes' TSS Overlapping Hi-C Bin, Average") + scale_color_manual(name="Upstream Contact?", labels = c("Both Species", "Neither Species", "One Species"), values=c("Red", "Blue", "Green"))


ggplot(data=plotdf) + geom_density(aes(x=ave_bin_pos, group=EITHERUS_present, color=EITHERUS_present, y=..scaled..)) + xlab("Position of the gene TSS along Hi-C bin") + ylab("Density") + ggtitle("Distributions of Genes' TSS Overlapping Hi-C Bin, Average") + scale_color_manual(name="Upstream Contact in only 1 species?", labels = c("No", "Yes"), values=c("Red", "Blue"))
ggplot(data=plotdf) + geom_density(aes(x=ave_bin_pos, group=ALLUS_present, color=ALLUS_present, y=..scaled..)) + xlab("Position of the gene TSS along Hi-C bin") + ylab("Density") + ggtitle("Distributions of Genes' TSS Overlapping Hi-C Bin, Average") + scale_color_manual(name="Upstream Contact in both species?", labels = c("No", "Yes"), values=c("Red", "Blue"))

##Now, take a look at the proportion of genes with an upstream contact based upon where along the Hi-C bin the gene TSS overlaps. Do this for bins of 100 bp at a time.
densitydf <- data.frame(prop_present_bin.H=NA, prop_present_cum_bin.H=NA, prop_present_tot.H=NA, prop_present_bin.C=NA, prop_present_cum_bin.C=NA, prop_present_tot.C=NA, prop_present_bin.EITHER=NA, prop_present_cum_bin.EITHER=NA, prop_present_tot.EITHER=NA, prop_present_bin.ALL=NA, prop_present_cum_bin.ALL=NA, prop_present_tot.ALL=NA, position=seq(0, 10000, 100))
for(row in 1:nrow(densitydf)){
  currentbin <- densitydf$position[row]
  mydat <- filter(plotdf, bin_pos.H<=currentbin)
  mydatbinned <- filter(plotdf, bin_pos.H<=currentbin&bin_pos.H>(currentbin-100))
  densitydf[row, 1] <- sum(mydatbinned$hUS_present=="yes")/nrow(mydatbinned)
  densitydf[row, 2] <- sum(mydat$hUS_present=="yes")/nrow(mydat)
  densitydf[row, 3] <- sum(mydat$hUS_present=="yes")/nrow(plotdf)
  
  mydat <- filter(plotdf, bin_pos.C<=densitydf$position[row])
  mydatbinned <- filter(plotdf, bin_pos.C<=currentbin&bin_pos.C>(currentbin-100))
  densitydf[row, 4] <- sum(mydatbinned$cUS_present=="yes")/nrow(mydatbinned)
  densitydf[row, 5] <- sum(mydat$cUS_present=="yes")/nrow(mydat)
  densitydf[row, 6] <- sum(mydat$cUS_present=="yes")/nrow(plotdf)
  
  mydat <- filter(plotdf, ave_bin_pos<=currentbin)
  mydatbinned <- filter(plotdf, ave_bin_pos<=currentbin&ave_bin_pos>(currentbin-100))
  densitydf[row, 7] <- sum(mydatbinned$EITHERUS_present=="yes")/nrow(mydatbinned)
  densitydf[row, 8] <- sum(mydat$EITHERUS_present=="yes")/nrow(mydat)
  densitydf[row, 9] <- sum(mydat$EITHERUS_present=="yes")/nrow(plotdf)
  densitydf[row, 10] <- sum(mydatbinned$ALLUS_present=="yes")/nrow(mydatbinned)
  densitydf[row, 11] <- sum(mydat$ALLUS_present=="yes")/nrow(mydat)
  densitydf[row, 12] <- sum(mydat$ALLUS_present=="yes")/nrow(plotdf)
}

densitydf <- densitydf[-1,] #Get rid of first row of meaningless results of 0!

#Visualize separately for humans and chimps
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_cum_bin.H)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Cumulative Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Genes w/ US Contact | gene's Hi-C Bin Position, Humans") + coord_cartesian(ylim=c(0.52, 0.72))
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_cum_bin.C)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Cumulative Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Genes w/ US Contact | gene's Hi-C Bin Position, Chimps") + coord_cartesian(ylim=c(0.52, 0.72))

ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_bin.H)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Binned Genes w/ US Contact | Hi-C Bin Position, Humans") + coord_cartesian(ylim=c(0.5, 0.9))
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_bin.C)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Binned Genes w/ US Contact | Hi-C Bin Position, Chimps") + coord_cartesian(ylim=c(0.5, 0.9))

#Visualize separately for situation where only one species has US contact
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_cum_bin.EITHER)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Cumulative Proportion of Genes with an Upstream Contact") + ggtitle("Cumul. Proportion Genes w/ US Contact | Hi-C Bin Position, 1 SP") + coord_cartesian(ylim=c(0, 0.65))
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_bin.EITHER)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Binned Genes w/ US Contact | Hi-C Bin Position, 1 SP") + coord_cartesian(ylim=c(0, 0.8))
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_tot.EITHER)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Total Genes w/ US Contact | Hi-C Bin Position, 1 SP") + coord_cartesian(ylim=c(0, 0.5))

#Visualize separately for situation where US contact present in both species.
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_cum_bin.ALL)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Genes w/ US Contact | Hi-C Bin Position, 2 SP") + coord_cartesian(ylim=c(0, 0.65))
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_bin.ALL)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Binned Genes w/ US Contact | Hi-C Bin Position, 2 SP") + coord_cartesian(ylim=c(0, 0.8))
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_tot.ALL)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Total Genes w/ US Contact | Hi-C Bin Position, 2 SP") + coord_cartesian(ylim=c(0, 0.5))
#Strong downward trend at the beginning for humans and starting up at the higher level than chimps, need to look at what genes are falling into these bins!

#Making a plot to be able to visualize all at once.
ggUSbin <- data.frame(prop=c(densitydf$prop_present_bin.H, densitydf$prop_present_bin.C, densitydf$prop_present_bin.EITHER, densitydf$prop_present_bin.ALL), type=c(rep("human", 100), rep("chimp", 100), rep("either", 100), rep("both", 100)), position=rep(densitydf$position, 4))
ggUScum <- data.frame(prop=c(densitydf$prop_present_cum_bin.H, densitydf$prop_present_cum_bin.C, densitydf$prop_present_cum_bin.EITHER, densitydf$prop_present_cum_bin.ALL), type=c(rep("human", 100), rep("chimp", 100), rep("either", 100), rep("both", 100)), position=rep(densitydf$position, 4))
ggUStot <- data.frame(prop=c(densitydf$prop_present_tot.H, densitydf$prop_present_tot.C, densitydf$prop_present_tot.EITHER, densitydf$prop_present_tot.ALL), type=c(rep("human", 100), rep("chimp", 100), rep("either", 100), rep("both", 100)), position=rep(densitydf$position, 4))

ggplot(data=ggUSbin) + geom_line(aes(x=position, group=type, color=type, y=prop)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Binned Genes with an Upstream Contact") + ggtitle("Binned Proportion Genes w/ US Contact | gene's Hi-C Bin Position") + theme(plot.title=element_text(hjust=0.2)) + guides(color=guide_legend(title="Species"))
ggplot(data=ggUScum) + geom_line(aes(x=position, group=type, color=type, y=prop)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Cumulative Proportion of Genes with an Upstream Contact") + ggtitle("Cumulative Proportion Genes w/ US Contact | gene's Hi-C Bin Position") + theme(plot.title=element_text(hjust=0.2)) + guides(color=guide_legend(title="Species"))
ggplot(data=ggUStot) + geom_line(aes(x=position, group=type, color=type, y=prop)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of ALL Genes that contain an Upstream Contact") + ggtitle("Proportion ALL Genes w/ US Contact | Hi-C Bin Position")

#Now, look at chromosomal distribution of genes, separated out by whether or not they have an upstream contact. Also see if the gene lengths for genes with and without US contact varies, as well as the genes' positions along the chromosome (represented as a fraction of chromosomal length).
colnames(human_lengths) <- c("genes", "gene.length")
test <- left_join(detable, human_lengths, by="genes")
test2 <- left_join(test, humgenes, by="genes")
chrplotdf <- select(gene.hic.overlap.info, hUS_present, genechr.H, genepos.H, cUS_present, genechr.C, genepos.C, genes)
test3 <- left_join(chrplotdf, test2, by="genes")
plotdf <- select(test3, Hchr, Hstart, hUS_present, genechr.H, genepos.H, cUS_present, genechr.C, genepos.C, gene.length)
plotdf$perc_dist <- NA
hsizes <-fread("~/Downloads/juicer.for.review.archive/juicebox_tools/src/juicebox/tools/chrom/sizes/hg38.chrom.sizes", header=FALSE, data.table=FALSE)
colnames(hsizes) <- c("chr", "length")
rownames(hsizes) <- hsizes$chr
for(row in 1:nrow(plotdf)){
  mychr <- plotdf$Hchr[row]
  mylength <- hsizes[mychr, 2]
  plotdf$perc_dist[row] <- plotdf$Hstart[row]/mylength
}
plotdf$Hchr <- factor(plotdf$Hchr)
plotdf$Hchr <- factor(plotdf$Hchr, levels(plotdf$Hchr)[c(1, 12, 16:22, 2:11, 13:15, 23:24)])

ggplot(data=plotdf) + geom_histogram(aes(x=Hchr, group=hUS_present, fill=hUS_present), stat="count", position="dodge") + ggtitle("Chromosmal distribution of genes, Humans") + scale_fill_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("indianred2", "turquoise"))

ggplot(data=plotdf) + stat_density(aes(x=gene.length, group=hUS_present, color=hUS_present), position="identity", geom="line") + coord_cartesian(xlim = c(0, 25000)) + xlab("Gene Length") + ggtitle("Distribution of gene lengths, Humans") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))
ggplot(data=plotdf) + stat_density(aes(x=perc_dist, group=hUS_present, color=hUS_present), position="identity", geom="line") + xlab("Fractional Length Along Chromosome") + ggtitle("Distribution of gene positions along chromosome, Humans") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

#Worth doing this chromo-by-chromo
ggplot(data=plotdf) + stat_density(aes(x=perc_dist, linetype=hUS_present), position="identity", geom="line") + xlab("Fractional Length Along Chromosome") + ggtitle("Distribution of gene positions along chromosome, Humans") + facet_wrap(~as.factor(Hchr), scales = "fixed") + theme(axis.text.x=element_text(face="bold", size=5, angle=45)) + scale_linetype_manual(name="Upstream Contact?", labels=c("No", "Yes"), values=c("solid", "twodash"))

#Now, the same thing as above, but for chimps.
colnames(chimp_lengths) <- c("genes", "gene.length")
test <- left_join(detable, chimp_lengths, by="genes")
test2 <- left_join(test, chimpgenes, by="genes")
chrplotdf <- select(gene.hic.overlap.info, hUS_present, genechr.H, genepos.H, cUS_present, genechr.C, genepos.C, genes)
test3 <- left_join(chrplotdf, test2, by="genes")
plotdf <- select(test3, Cchr, Cstart, hUS_present, genechr.H, genepos.H, cUS_present, genechr.C, genepos.C, gene.length)
plotdf$perc_dist <- NA
csizes <-fread("~/Desktop/Hi-C/panTro5.chrom.sizes", header=FALSE, data.table=FALSE)
csizes <- csizes[1:25,]
colnames(csizes) <- c("chr", "length")
rownames(csizes) <- csizes$chr
for(row in 1:nrow(plotdf)){
  mychr <- plotdf$Cchr[row]
  mylength <- csizes[mychr, 2]
  plotdf$perc_dist[row] <- plotdf$Cstart[row]/mylength
}
bad.indices <- grep(pattern = "random", plotdf$Cchr)
plotdf <- plotdf[-bad.indices,]
plotdf$Cchr <- factor(plotdf$Cchr)
plotdf$Cchr <- factor(plotdf$Cchr, levels(plotdf$Cchr)[c(1, 15:16, 17:23, 2:14, 24:25)])

ggplot(data=plotdf) + geom_histogram(aes(x=Cchr, group=cUS_present, fill=cUS_present), stat="count", position="dodge") + ggtitle("Chromosmal distribution of genes, Chimps") + scale_fill_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("indianred2", "turquoise"))

ggplot(data=plotdf) + stat_density(aes(x=gene.length, group=cUS_present, color=cUS_present), position="identity", geom="line") + coord_cartesian(xlim = c(0, 25000)) + xlab("Gene Length") + ggtitle("Distribution of gene lengths, Chimps") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))
ggplot(data=plotdf) + stat_density(aes(x=perc_dist, group=cUS_present, color=cUS_present), position="identity", geom="line") + xlab("Fractional Length Along Chromosome") + ggtitle("Distribution of gene positions along chromosome, Chimps") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

#Worth doing this chromo-by-chromo
ggplot(data=plotdf[c(-10922, -11284, -11285, -11286),]) + stat_density(aes(x=perc_dist, linetype=cUS_present), position="identity", geom="line") + xlab("Fractional Length Along Chromosome") + ggtitle("Distribution of gene positions along chromosome, Chimps") + facet_wrap(~as.factor(Cchr), scales = "fixed") + theme(axis.text.x=element_text(face="bold", size=5, angle=45)) + scale_linetype_manual(name="Upstream Contact?", labels=c("No", "Yes"), values=c("solid", "twodash"))

#Look at these metrics with expression.
RPKM2 <- as.data.frame(weighted.data$E)
RPKM2$genes <- rownames(RPKM2)
RPKM2$Hmean <- rowMeans(RPKM2[,c(1:2, 5:6)])
RPKM2$Cmean <- rowMeans(RPKM2[,c(3:4, 7:8)])
RPKM2$ALLmean <- rowMeans(RPKM2[,c(1:8)])
USexprs.test <- left_join(gene.hic.overlap.info, RPKM2, by="genes")
exprsdf <- select(USexprs.test, hUS_present, cUS_present, EITHERUS_present, ALLUS_present, Hmean, Cmean, ALLmean, UStype)

ggplot(data=exprsdf) + geom_boxplot(aes(x=hUS_present, group=hUS_present, y=Hmean)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), Human") + ggtitle("Mean Human Expression Distributions for Genes | US Contact")
ggplot(data=exprsdf) + stat_density(aes(x=Hmean, group=hUS_present, color=hUS_present, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Human Expression Distributions for Genes | US Contact ") + xlab("Mean Expression Value (RPKM), Human") + ylab("Density") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue")) + annotate("text", x=0, y=0.75, label="5.351 e -5", size=4)

#Now t-test the two distributions!
presents <- filter(exprsdf, hUS_present=="yes") %>% select(., hUS_present, Hmean, Cmean, ALLmean)
absents <- filter(exprsdf, hUS_present=="no") %>% select(., hUS_present, Hmean, Cmean, ALLmean)
t.test(presents$Hmean, absents$Hmean)

ggplot(data=exprsdf) + geom_boxplot(aes(x=cUS_present, group=cUS_present, y=Cmean)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), Chimp") + ggtitle("Mean Chimp Expression Distributions for Genes | US Contact")
ggplot(data=exprsdf) + stat_density(aes(x=Cmean, group=cUS_present, color=cUS_present, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Chimp Expression Distributions for Genes | US Contact ") + xlab("Mean Expression Value (RPKM), Chimp") + ylab("Density") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue")) + annotate("text", x=0, y=0.75, label="7.77 e -7", size=4)

presents <- filter(exprsdf, cUS_present=="yes") %>% select(., cUS_present, Hmean, Cmean, ALLmean)
absents <- filter(exprsdf, cUS_present=="no") %>% select(., cUS_present, Hmean, Cmean, ALLmean)
t.test(presents$Cmean, absents$Cmean)

exprsdf$UStype <- factor(exprsdf$UStype, levels=c("neither", "one", "both"))
ggplot(data=exprsdf) + geom_boxplot(aes(x=UStype, group=UStype, y=ALLmean)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), All Individuals") + ggtitle("Mean Expression Distributions for Genes | US Contact")
ggplot(data=exprsdf) + stat_density(aes(x=ALLmean, group=UStype, color=UStype, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Expression Distributions for Genes | US Contact ") + xlab("Mean Expression Value (RPKM), All Individuals") + ylab("Density") + scale_color_manual(name="Upstream Contact?", labels = c("Neither Species", "One Species", "Both Species"), values=c("Red", "Blue", "Green")) + annotate("text", x=-3, y=0.8, label="N-O pval: 4.941 e -6", size=3) + annotate("text", x=-3, y=0.675, label="O-B pval: 0.06651", size=3) + annotate("text", x=-3, y=0.55, label="N-B pval: 2.146 e -6", size=3)

#T-test these pairwise!
neither <- filter(exprsdf, UStype=="neither") %>% select(., Hmean, Cmean, ALLmean)
one <- filter(exprsdf, UStype=="one") %>% select(., Hmean, Cmean, ALLmean)
both <- filter(exprsdf, UStype=="both") %>% select(., Hmean, Cmean, ALLmean)
t.test(neither$ALLmean, one$ALLmean)
t.test(one$ALLmean, both$ALLmean)
t.test(neither$ALLmean, both$ALLmean)

#Now repeat all of the relevant visualizations for downstream!
DSexprs.test <- left_join(gene.hic.overlap.info, RPKM2, by="genes")
exprsdf <- select(DSexprs.test, hDS_present, cDS_present, EITHERDS_present, ALLDS_present, Hmean, Cmean, ALLmean, DStype)

ggplot(data=exprsdf) + geom_boxplot(aes(x=hDS_present, group=hDS_present, y=Hmean)) + xlab("downstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), Human") + ggtitle("Mean Human Expression Distributions for Genes | DS Contact")
ggplot(data=exprsdf) + stat_density(aes(x=Hmean, group=hDS_present, color=hDS_present, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Human Expression Distributions for Genes | DS Contact ") + xlab("Mean Expression Value (RPKM), Human") + ylab("Density") + scale_color_manual(name="downstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue")) + annotate("text", x=0, y=0.75, label="0.66", size=4)

#Now t-test the two distributions!
presents <- filter(exprsdf, hDS_present=="yes") %>% select(., hDS_present, Hmean, Cmean, ALLmean)
absents <- filter(exprsdf, hDS_present=="no") %>% select(., hDS_present, Hmean, Cmean, ALLmean)
t.test(presents$Hmean, absents$Hmean)

ggplot(data=exprsdf) + geom_boxplot(aes(x=cDS_present, group=cDS_present, y=Cmean)) + xlab("downstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), Chimp") + ggtitle("Mean Chimp Expression Distributions for Genes | DS Contact")
ggplot(data=exprsdf) + stat_density(aes(x=Cmean, group=cDS_present, color=cDS_present, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Chimp Expression Distributions for Genes | DS Contact ") + xlab("Mean Expression Value (RPKM), Chimp") + ylab("Density") + scale_color_manual(name="downstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue")) + annotate("text", x=0, y=0.75, label="0.52", size=4)

presents <- filter(exprsdf, cDS_present=="yes") %>% select(., cDS_present, Hmean, Cmean, ALLmean)
absents <- filter(exprsdf, cDS_present=="no") %>% select(., cDS_present, Hmean, Cmean, ALLmean)
t.test(presents$Cmean, absents$Cmean)

exprsdf$DStype <- factor(exprsdf$DStype, levels=c("neither", "one", "both"))
ggplot(data=exprsdf) + geom_boxplot(aes(x=DStype, group=DStype, y=ALLmean)) + xlab("downstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), All Individuals") + ggtitle("Mean Expression Distributions for Genes | DS Contact")
ggplot(data=exprsdf) + stat_density(aes(x=ALLmean, group=DStype, color=DStype, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Expression Distributions for Genes | DS Contact ") + xlab("Mean Expression Value (RPKM), All Individuals") + ylab("Density") + scale_color_manual(name="downstream Contact?", labels = c("Neither Species", "One Species", "Both Species"), values=c("Red", "Blue", "Green")) + annotate("text", x=-3, y=0.8, label="N-O pval: 1.3 e -7", size=3) + annotate("text", x=-3, y=0.675, label="O-B pval: 2.3 e -7", size=3) + annotate("text", x=-3, y=0.55, label="N-B pval: 0.92", size=3)

#T-test these pairwise!
neither <- filter(exprsdf, DStype=="neither") %>% select(., Hmean, Cmean, ALLmean)
one <- filter(exprsdf, DStype=="one") %>% select(., Hmean, Cmean, ALLmean)
both <- filter(exprsdf, DStype=="both") %>% select(., Hmean, Cmean, ALLmean)
t.test(neither$ALLmean, one$ALLmean)
t.test(one$ALLmean, both$ALLmean)
t.test(neither$ALLmean, both$ALLmean)

#Now, could literally repeat many of these analyses with ONLY DE genes. But it doesn't look particularly interesting or any different from what I already showed, so collapse it here--aside from the expression part, which is somewhat interesting.
filter(gene.hic.overlap.info, adj.P.Val<=0.05) %>% select(., "hUS_present", "cUS_present", "bin_pos.H", "bin_pos.C") -> DEplotDF
filter(USexprs.test, adj.P.Val<=0.05) %>% select(., hUS_present, cUS_present, EITHERUS_present, ALLUS_present, Hmean, Cmean, ALLmean, UStype) -> DEexprsDF

##First, look at distance along bin that gene is seen in.
ggplot(data=DEplotDF) + geom_boxplot(aes(x=hUS_present, y=bin_pos.H, group=hUS_present)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Position of the gene TSS along the Hi-C bin") + ggtitle("Distribution of Genes' TSS Along Overlapping Hi-C Bin, Humans")
ggplot(data=DEplotDF) + geom_boxplot(aes(x=cUS_present, y=bin_pos.C, group=cUS_present)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Position of the gene TSS along the Hi-C bin") + ggtitle("Distribution of Genes' TSS Along Overlapping Hi-C Bin, Chimps")
ggplot(data=DEplotDF) + geom_density(aes(x=bin_pos.H, group=hUS_present, color=hUS_present, y=..scaled..)) + xlab("Position of the gene TSS along Hi-C bin") + ylab("Density") + ggtitle("Distributions of Genes' TSS Overlapping Hi-C Bin, Humans") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))
ggplot(data=DEplotDF) + geom_density(aes(x=bin_pos.C, group=cUS_present, color=cUS_present, y=..scaled..)) + xlab("Position of the gene TSS along Hi-C bin") + ylab("Density") + ggtitle("Distributions of Genes' TSS Overlapping Hi-C Bin, Chimps") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

#Look at proportion of genes with or without an upstream contact moving along the bin to see if gene's position within a bin affects this.
densitydf <- data.frame(prop_present_bin.H=NA, prop_present_cum.H=NA, prop_present_bin.C=NA, prop_present_cum.C=NA, position=seq(0, 10000, 100))
for(row in 1:nrow(densitydf)){
  mydat <- filter(DEplotDF, bin_pos.H<=densitydf$position[row])
  densitydf[row, 1] <- sum(mydat$hUS_present=="yes", rm.na=TRUE)/nrow(mydat)
  densitydf[row, 2] <- sum(mydat$hUS_present=="yes", rm.na=TRUE)/nrow(DEplotDF)
  
  mydat <- filter(DEplotDF, bin_pos.C<=densitydf$position[row])
  densitydf[row, 3] <- sum(mydat$cUS_present=="yes", rm.na=TRUE)/nrow(mydat)
  densitydf[row, 4] <- sum(mydat$cUS_present=="yes", rm.na=TRUE)/nrow(DEplotDF)
}



ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_bin.H)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Genes w/ US Contact | gene's Hi-C Bin Position, Humans")
ggplot(data=densitydf[-1,]) + geom_line(aes(x=position, y=prop_present_bin.C)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Genes with an Upstream Contact") + ggtitle("Proportion Genes w/ US Contact | gene's Hi-C Bin Position, Chimps")

#Now, the same thing, but visualized together.
ggUSbin <- data.frame(prop=c(densitydf$prop_present_bin.H, densitydf$prop_present_bin.C), type=c(rep("human", 101), rep("chimp", 101)), position=rep(densitydf$position, 2))
ggUScum <- data.frame(prop=c(densitydf$prop_present_cum.H, densitydf$prop_present_cum.C), type=c(rep("human", 101), rep("chimp", 101)), position=rep(densitydf$position, 2))

ggplot(data=ggUSbin) + geom_line(aes(x=position, group=type, color=type, y=prop)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Proportion of Binned Genes with an Upstream Contact") + ggtitle("Binned Proportion DE Genes w/ US Contact | gene's Hi-C Bin Position") + theme(plot.title=element_text(hjust=0.2)) + guides(color=guide_legend(title="Species"))
ggplot(data=ggUScum) + geom_line(aes(x=position, group=type, color=type, y=prop)) + xlab("Position Along Hi-C Bin, 100 BP Intervals") + ylab("Cumulative Proportion of Genes with an Upstream Contact") + ggtitle("Cumulative Proportion DE Genes w/ US Contact | gene's Hi-C Bin Position") + theme(plot.title=element_text(hjust=0.3)) + guides(color=guide_legend(title="Species"))


####Visualize questions dealing with RPKM expression here. Essentially the only interesting part of this.
ggplot(data=DEexprsDF) + geom_boxplot(aes(x=hUS_present, group=hUS_present, y=Hmean)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), Human") + ggtitle("Mean Human Expression Distributions for Genes | US Contact")
ggplot(data=DEexprsDF) + stat_density(aes(x=Hmean, group=hUS_present, color=hUS_present, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Human Expression Distributions for Genes | US Contact ") + xlab("Mean Expression Value (RPKM), Human") + ylab("Density") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

ggplot(data=DEexprsDF) + geom_boxplot(aes(x=cUS_present, group=cUS_present, y=Cmean)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), Chimp") + ggtitle("Mean Chimp Expression Distributions for Genes | US Contact")
ggplot(data=DEexprsDF) + stat_density(aes(x=Cmean, group=cUS_present, color=cUS_present, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Chimp Expression Distributions for Genes | US Contact ") + xlab("Mean Expression Value (RPKM), Chimp") + ylab("Density") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

ggplot(data=DEexprsDF) + geom_boxplot(aes(x=ALLUS_present, group=ALLUS_present, y=ALLmean)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), All Individuals") + ggtitle("Mean Expression Distributions for Genes | US Contact")
ggplot(data=DEexprsDF) + stat_density(aes(x=ALLmean, group=ALLUS_present, color=ALLUS_present), geom="line", position="identity") + ggtitle("Mean Expression Distributions for Genes | US Contact ") + xlab("Mean Expression Value (RPKM), All Individuals") + ylab("Density") + scale_color_manual(name="Upstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

#Joint visualization.
ggplot(data=DEexprsDF) + geom_boxplot(aes(x=UStype, group=UStype, y=ALLmean)) + xlab("Upstream Contact Present for Hi-C Bin Overlapping DE Gene?") + ylab("Mean Expression Value (RPKM), All Individuals") + ggtitle("Mean Expression Distributions for DE Genes | US Contact")
ggplot(data=DEexprsDF) + stat_density(aes(x=ALLmean, group=UStype, color=UStype, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Expression Distributions for DE Genes | US Contact ") + xlab("Mean Expression Value (RPKM), All Individuals") + ylab("Density") + scale_color_manual(name="Upstream Contact?", labels = c("Neither Species", "One Species", "Both Species"), values=c("Red", "Blue", "Green")) + annotate("text", x=-2, y=0.8, label="N-O pval: 0.002136", size=3) + annotate("text", x=-2, y=0.675, label="O-B pval: 0.2836", size=3) + annotate("text", x=-2, y=0.55, label="N-B pval: 0.001425", size=3)

#T-test these pairwise! Technically did this beforehand to put labels on plot.
neither <- filter(DEexprsDF, UStype=="neither") %>% select(., Hmean, Cmean, ALLmean)
one <- filter(DEexprsDF, UStype=="one") %>% select(., Hmean, Cmean, ALLmean)
both <- filter(DEexprsDF, UStype=="both") %>% select(., Hmean, Cmean, ALLmean)
t.test(neither$ALLmean, one$ALLmean)
t.test(one$ALLmean, both$ALLmean)
t.test(neither$ALLmean, both$ALLmean)

#Repeat RPKM DE visualization for DS contacts:
filter(gene.hic.overlap.info, adj.P.Val<=0.05) %>% select(., "hDS_present", "cDS_present", "bin_pos.H", "bin_pos.C") -> DEplotDF
filter(DSexprs.test, adj.P.Val<=0.05) %>% select(., hDS_present, cDS_present, EITHERDS_present, ALLDS_present, Hmean, Cmean, ALLmean, DStype) -> DEexprsDF

####Visualize questions dealing with RPKM expression here. Essentially the only interesting part of this.
ggplot(data=DEexprsDF) + geom_boxplot(aes(x=hDS_present, group=hDS_present, y=Hmean)) + xlab("Downstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), Human") + ggtitle("Mean Human Expression Distributions for Genes | DS Contact")
ggplot(data=DEexprsDF) + stat_density(aes(x=Hmean, group=hDS_present, color=hDS_present, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Human Expression Distributions for Genes | DS Contact ") + xlab("Mean Expression Value (RPKM), Human") + ylab("Density") + scale_color_manual(name="Downstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

ggplot(data=DEexprsDF) + geom_boxplot(aes(x=cDS_present, group=cDS_present, y=Cmean)) + xlab("Downstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), Chimp") + ggtitle("Mean Chimp Expression Distributions for Genes | DS Contact")
ggplot(data=DEexprsDF) + stat_density(aes(x=Cmean, group=cDS_present, color=cDS_present, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Chimp Expression Distributions for Genes | DS Contact ") + xlab("Mean Expression Value (RPKM), Chimp") + ylab("Density") + scale_color_manual(name="Downstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

ggplot(data=DEexprsDF) + geom_boxplot(aes(x=ALLDS_present, group=ALLDS_present, y=ALLmean)) + xlab("Downstream Contact Present for Hi-C Bin Overlapping Gene?") + ylab("Mean Expression Value (RPKM), All Individuals") + ggtitle("Mean Expression Distributions for Genes | DS Contact")
ggplot(data=DEexprsDF) + stat_density(aes(x=ALLmean, group=ALLDS_present, color=ALLDS_present), geom="line", position="identity") + ggtitle("Mean Expression Distributions for Genes | DS Contact ") + xlab("Mean Expression Value (RPKM), All Individuals") + ylab("Density") + scale_color_manual(name="Downstream Contact?", labels = c("No", "Yes"), values=c("Red", "Blue"))

#Joint visualization.
ggplot(data=DEexprsDF) + geom_boxplot(aes(x=DStype, group=DStype, y=ALLmean)) + xlab("Downstream Contact Present for Hi-C Bin Overlapping DE Gene?") + ylab("Mean Expression Value (RPKM), All Individuals") + ggtitle("Mean Expression Distributions for DE Genes | DS Contact")
ggplot(data=DEexprsDF) + stat_density(aes(x=ALLmean, group=DStype, color=DStype, y=..scaled..), geom="line", position="identity") + ggtitle("Mean Expression Distributions for DE Genes | DS Contact ") + xlab("Mean Expression Value (RPKM), All Individuals") + ylab("Density") + scale_color_manual(name="Downstream Contact?", labels = c("Neither Species", "One Species", "Both Species"), values=c("Red", "Blue", "Green")) + annotate("text", x=-2, y=0.8, label="N-O pval: 3.2 e -4", size=3) + annotate("text", x=-2, y=0.675, label="O-B pval: 8.8 e -5", size=3) + annotate("text", x=-2, y=0.55, label="N-B pval: 0.54", size=3)

#T-test these pairwise! Technically did this beforehand to put labels on plot.
neither <- filter(DEexprsDF, DStype=="neither") %>% select(., Hmean, Cmean, ALLmean)
one <- filter(DEexprsDF, DStype=="one") %>% select(., Hmean, Cmean, ALLmean)
both <- filter(DEexprsDF, DStype=="both") %>% select(., Hmean, Cmean, ALLmean)
t.test(neither$ALLmean, one$ALLmean)
t.test(one$ALLmean, both$ALLmean)
t.test(neither$ALLmean, both$ALLmean)
#FWIW, there are 209 instances of "one", 968 of "both" and 1091 of "neither", so perhaps the set size here is what's really doing it. But that situation is essentially similar in US contacts as well (197, 1008, 1063).
```
There are some interesting stories to be told here about increasing expression when you DO have a statistically significant upstream contact.

###Differences in effect size/sign changes
This next section would be to look at differences in effect size and sign changes when doing the two separate lms (one before and one after regressing out Hi-C data from RPKM expression). Unfortunately the ash results I get have all their svalues as 1 so this is boring/not interesting right now. Hence it is not included. But let's give it another go!
```{r Differences in Effect Sizes}
#######FRESH CODE 6-21-18#########
design <- model.matrix(~meta.data$SP)
exprs <- select(hmin, "A-21792", "B-28126", "C-3649", "D-40300", "E-28815", "F-28834", "G-3624", "H-3651", genes) #Should be done on just DE genes, filter with adj.P.Val<=0.05
hic <- select(hmin,"A_21792_HIC", "B_28126_HIC", "C_3649_HIC", "D_40300_HIC", "E_28815_HIC", "F_28834_HIC", "G_3624_HIC", "H_3651_HIC")
present <- sapply(1:nrow(hic), function(i) !any(is.na(hic[i,])))
genes <- exprs$genes
DEgenes <- filter(hmin, adj.P.Val<=0.05) %>% select(., genes)
myDEindices <- which(genes %in% DEgenes[,1])
exprs <- exprs[,-9]
exprs <- data.matrix(exprs[present,])
hic <- data.matrix(hic[present,])
designy <- as.factor(c("human", "human", "chimp", "chimp", "human", "human", "chimp", "chimp"))
colnames(hic) <- colnames(exprs)
hic <- as.data.table(hic)
exprs <- as.data.table(exprs)
test <- mediate.test.regressing(exprs, designy, hic)

#Shrink dat variance!
vshrDE <- vash(test$d_se[myDEindices], df=6)
vshrnonDE <- vash(test$d_se[-myDEindices], df=6)
vshrink <- vash(test$d_se, df=6)

#Separate out DE from non-DE genes:
DEtest <- test[myDEindices,]
nonDEtest <- test[-myDEindices,]

#Ash on DE genes
ash_reg <- ash(as.vector(DEtest$d), as.vector(vshrDE$sd.post), mixcompdist = "normal") #Now it works with this design coding. Use 6 df, as 2-group comparison and 8 individual samples (samples - 2)
summary(ash_reg$result$svalue<=0.05) #Incredible result, looks too good to be true.
ind_sig <- (ash_reg$result$svalue < 0.05)
ind_sig[ind_sig == TRUE] <- "red"
ind_sig[ind_sig == FALSE] <- "black"
plot(x=ash_reg$result$betahat, y=ash_reg$result$sebetahat, ylab="Standard error of the difference", xlab="Difference in effect size from 2 lms", main="Difference of effect size (DE genes)", pch=16, cex=0.6, col=ind_sig)#, xlim=c(-2.5, 2.5), ylim=c(0, 1.3))
legend("topleft", legend=c("s < 0.05", "s >= 0.05"), col=c("red", "black"), pch=16:16, cex=0.8)
plot(ash_reg$result$betahat, -log10(ash_reg$result$svalue))

#Now on non-DE genes
ash_reg_nonDE <- ash(as.vector(nonDEtest$d), as.vector(vshrnonDE$sd.post), mixcompdist = "normal") #Now it works with this design coding. Use 6 df, as 2-group comparison and 8 individual samples (samples - 2)
summary(ash_reg_nonDE$result$svalue<=0.05) #Incredible result, looks too good to be true.
ind_sig <- (ash_reg_nonDE$result$svalue < 0.05)
ind_sig[ind_sig == TRUE] <- "red"
ind_sig[ind_sig == FALSE] <- "black"
plot(x=ash_reg_nonDE$result$betahat, y=ash_reg_nonDE$result$sebetahat, ylab="Standard error of the difference", xlab="Difference in effect size from 2 lms", main="Difference of effect size (DE genes)", pch=16, cex=0.6, col=ind_sig)#, xlim=c(-2.5, 2.5), ylim=c(0, 1.3))
legend("topleft", legend=c("s < 0.05", "s >= 0.05"), col=c("red", "black"), pch=16:16, cex=0.8)
plot(ash_reg_nonDE$result$betahat, -log10(ash_reg_nonDE$result$svalue))

#Now on the full set, for comparison's sake.
ash_reg_full <- ash(as.vector(test$d), as.vector(vshrink$sd.post), mixcompdist = "normal") #Now it works with this design coding. Use 6 df, as 2-group comparison and 8 individual samples (samples - 2)
summary(ash_reg_full$result$svalue<=0.05) #Incredible result, looks too good to be true.
ind_sig <- (ash_reg_full$result$svalue < 0.05)
ind_sig[ind_sig == TRUE] <- "red"
ind_sig[ind_sig == FALSE] <- "black"
plot(x=ash_reg_full$result$betahat, y=ash_reg_full$result$sebetahat, ylab="Standard error of the difference", xlab="Difference in effect size from 2 lms", main="Difference of effect size (DE genes)", pch=16, cex=0.6, col=ind_sig)#, xlim=c(-2.5, 2.5), ylim=c(0, 1.3))
legend("topleft", legend=c("s < 0.05", "s >= 0.05"), col=c("red", "black"), pch=16:16, cex=0.8)
plot(ash_reg_full$result$betahat, -log10(ash_reg_full$result$svalue))

#Look at effect size shrinkage in full set ash vs. separated DE/nonDE ash:
plot(c(ash_reg$result$PosteriorMean, ash_reg_nonDE$result$PosteriorMean), ash_reg_full$result$PosteriorMean)

#Look at this just in DE:
plot(ash_reg$result$PosteriorMean, ash_reg_full$result$PosteriorMean[myDEindices])

#Look at this just in non-DE:
plot(ash_reg_nonDE$result$PosteriorMean, ash_reg_full$result$PosteriorMean[-myDEindices])
```

###Expression distance analysis
Here I see if species differences in contact frequencies in adjacent bins to a given Hi-C bin overlapping a gene can predict the logFC of expression of that gene across the species. These preliminary results are not especially exciting but there is a lot to be played with here.
```{r Analysis on a bin-by-bin level for all bins adjacent to a gene on either side}
#Read in all the adjacency matrices
adj.A <- read.csv("~/Desktop/Hi-C/adjbins/adj_bins_50_A-21792_10kb_norm", header=TRUE, sep = "\t")
adj.B <- read.csv("~/Desktop/Hi-C/adjbins/adj_bins_50_B-28126_10kb_norm", header=TRUE, sep = "\t")
adj.E <- read.csv("~/Desktop/Hi-C/adjbins/adj_bins_50_E-28815_10kb_norm", header=TRUE, sep = "\t")
adj.F <- read.csv("~/Desktop/Hi-C/adjbins/adj_bins_50_F-28834_10kb_norm", header=TRUE, sep = "\t")

adj.C <- read.csv("~/Desktop/Hi-C/adjbins/adj_bins_50_C-3649_10kb_norm", header=TRUE, sep = "\t")
adj.D <- read.csv("~/Desktop/Hi-C/adjbins/adj_bins_50_D-40300_10kb_norm", header=TRUE, sep = "\t")
adj.G <- read.csv("~/Desktop/Hi-C/adjbins/adj_bins_50_G-3624_10kb_norm", header=TRUE, sep = "\t")
adj.H <- read.csv("~/Desktop/Hi-C/adjbins/adj_bins_50_H-3651_10kb_norm", header=TRUE, sep = "\t")

#Get mean values across individuals within a species, first for humans, then chimps.
adj.hum.mean <- matrix(nrow = nrow(adj.A), ncol = ncol(adj.A)) #Humans
for(row in 1:nrow(adj.hum.mean)){
  for(col in 1:ncol(adj.hum.mean)){
    adj.hum.mean[row,col] <- mean(c(adj.A[row,col], adj.B[row,col], adj.E[row,col], adj.F[row,col]))
  }
}
rownames(adj.hum.mean) <- rownames(adj.A)
adj.chimp.mean <- matrix(nrow = nrow(adj.C), ncol = ncol(adj.C)) #Chimps
for(row in 1:nrow(adj.chimp.mean)){
  for(col in 1:ncol(adj.chimp.mean)){
    adj.chimp.mean[row,col] <- mean(c(adj.C[row,col], adj.D[row,col], adj.G[row,col], adj.H[row,col]))
  }
}
rownames(adj.chimp.mean) <- rownames(adj.C)

#Extract other relevant data for joining on, as well as for making necessary inversions of the adjacency matrices based on gene strand.
genedf <- select(gene.hic.filt, genes, logFC, HID, CID, Hstrand.H, Hstrand.C) #Have checked, both strands are identical between the species here
genedf <- genedf[complete.cases(genedf),] #Leaves us with about ~7500 genes; 500 of which will be repeats on overlapping bins--can leave them in for now, just remove instances of those entirely, or try to just keep the one with a larger logFC. Just remove at random for now:
badHs <- which(duplicated(genedf$HID))
badCs <- which(duplicated(genedf$CID))

genedf <- genedf[c(-badHs, -badCs),] #Have now removed any instances of duplicated bins here!

#Reformat the species mean dataframes.
adj.hum.mean <- as.data.frame(adj.hum.mean)
adj.hum.mean$HID <- rownames(adj.hum.mean)
adj.chimp.mean <- as.data.frame(adj.chimp.mean)
adj.chimp.mean$CID <- rownames(adj.chimp.mean)

adj.full <- left_join(adj.hum.mean, genedf, by="HID") %>% left_join(., adj.chimp.mean, by="CID", suffix=c(".human", ".chimp")) #Join to get the full set of information
adj.full <- adj.full[complete.cases(adj.full),] #Get rid of rows where we don't have all the info

for(row in 1:nrow(adj.full)){#Check strand by species; if strand is negative, flip the entire set of values across bins around for the species.
  if(adj.full$Hstrand.H[row]=="-"){adj.full[row,1:101] <- adj.full[row, 101:1]}
  if(adj.full$Hstrand.C[row]=="-"){adj.full[row, 108:208] <- adj.full[row, 208:108]}
}

#Prepare the final adjacency table now.
adj.final <- select(adj.full, genes, logFC)
adj.final[,3:103] <- abs(adj.full[,1:101]-adj.full[,108:208]) #Subtract chimp values from human values, just like the expression contrast is coded.
#adj.final[,3:103] <- abs(adj.full[,1:101]-adj.full[,108:208]) #Subtract chimp values from human values, just like the expression contrast is coded.
model.covs <- paste(colnames(adj.final)[c(3:52, 54:103)], collapse=" + ") #Obtain the long linear equation here.
model.full <- paste("logFC ~ ", model.covs, sep="")

#Test with abs valu of logFC
adj.final$logFC <- abs(adj.final$logFC)

#Remove gene's own bin
adj.final$V51.human <- NA

#Now, run an actual linear model. First basic, then lasso.
simple.result <- lm(eval(model.full), data=adj.final)
set.seed(30) #set.seed for cv.glmnet
cv.lasso <- cv.glmnet(as.matrix(adj.final[,c(3:52,54:103)]), as.matrix(adj.final[,2]), alpha=1)
#plot(cv.lasso)
cv.lasso$lambda.min
#plot(1:101, as.matrix(coef(cv.lasso, s="lambda.min"))[2:102,1])

#Visualization!
binsplotdf <- summary(simple.result)$coefficients
binsplotdf <- as.data.frame(binsplotdf[-1,])
#binsplotdf$location <- c(-50:-1, 0, 1:50)*10
binsplotdf$location <- c(-50:-1, 1:50)*10
binsplotdf$significant <- ifelse(binsplotdf$`Pr(>|t|)`<=0.05, "yes", "no")
#binsplotdf$lasso.val <- as.matrix(coef(cv.lasso, s="lambda.min"))[2:102, 1]
binsplotdf$lasso.val <- as.matrix(coef(cv.lasso, s="lambda.min"))[2:101, 1]
colnames(binsplotdf) <- c("beta", "std.error", "t.val", "p.val", "location", "significant", "lasso.value")
binsplotdf$lasso.value <- ifelse(binsplotdf$lasso.value==0, "no", "yes")
ggplot(data=binsplotdf) + geom_pointrange(aes(x=location, y=beta, ymin=beta-std.error, ymax=beta+std.error, color=significant, shape=lasso.value), size=0.5) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + ggtitle("Expression logFC ~ Mean Species Contact Frequency Difference") + scale_x_discrete(limits=seq(-500, 500, 100)) + scale_color_manual("LM-Significant?", labels=c("No", "Yes"), values=c("blue", "red")) + scale_shape_discrete("LASSO-Significant?", labels=c("No", "Yes"))

#######################Same thing, absolute vals
ggplot(data=binsplotdf) + geom_pointrange(aes(x=location, y=abs(beta), ymin=abs(beta)-std.error, ymax=abs(beta)+std.error, color=significant, shape=lasso.value), size=0.5) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + ggtitle("Expression logFC ~ Mean Species Contact Frequency Difference") + scale_x_discrete(limits=seq(-500, 500, 100)) + scale_color_manual("LM-Significant?", labels=c("No", "Yes"), values=c("blue", "red")) + scale_shape_discrete("LASSO-Significant?", labels=c("No", "Yes"))

##############Try again, but only with 20 adjacent bins on each side!
adj.final.20 <- select(adj.full, genes, logFC)
adj.final.20[,3:43] <- abs(adj.full[,31:71]-adj.full[,138:178]) #Humans minus chimps...
model.covs.20 <- paste(colnames(adj.final.20)[c(3:22,24:43)], collapse=" + ")
adj.final.20$V51.human <- NA #Remove gene's own bin
model.full.20 <- paste("logFC ~ ", model.covs.20, sep="")
adj.final.20$logFC <- abs(adj.final.20$logFC)
simple.result.20 <- lm(eval(model.full.20), data=adj.final.20) #LM for 20
set.seed(31)
cv.lasso20 <- cv.glmnet(as.matrix(adj.final.20[,c(3:22, 24:43)]), as.matrix(adj.final.20[,2]), alpha=1) #Was just 3:43 but that threw an NA error
#plot(cv.lasso20)
#plot(1:41, as.matrix(coef(cv.lasso20, s="lambda.min"))[2:42,1])
binsplotdf20 <- summary(simple.result.20)$coefficients
binsplotdf20 <- as.data.frame(binsplotdf20[-1,])
#binsplotdf20$location <- c(-20:-1, 0, 1:20)*10
binsplotdf20$location <- c(-20:-1, 1:20)*10
binsplotdf20$significant <- ifelse(binsplotdf20$`Pr(>|t|)`<=0.05, "yes", "no")
binsplotdf20$lasso.val <- as.matrix(coef(cv.lasso20, s="lambda.min"))[2:41, 1]
colnames(binsplotdf20) <- c("beta", "std.error", "t.val", "p.val", "location", "significant", "lasso.value")
binsplotdf20$lasso.value <- ifelse(binsplotdf20$lasso.value==0, "no", "yes")
ggplot(data=binsplotdf20) + geom_pointrange(aes(x=location, y=beta, ymin=beta-std.error, ymax=beta+std.error, color=significant, shape=lasso.value), size=0.5) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + ggtitle("Expression logFC ~ Mean Species Contact Frequency Difference") + scale_color_manual("LM-Significant?", labels=c("No", "Yes"), values=c("blue", "red")) + scale_shape_discrete("LASSO-Significant?", labels=c("No", "Yes")) + scale_x_discrete(limits=seq(-200, 200, 100))

#######################Same thing, absolute vals
ggplot(data=binsplotdf20) + geom_pointrange(aes(x=location, y=abs(beta), ymin=abs(beta)-std.error, ymax=abs(beta)+std.error, color=significant, shape=lasso.value), size=0.5) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + ggtitle("Expression logFC ~ Mean Species Contact Frequency Difference") + scale_color_manual("LM-Significant?", labels=c("No", "Yes"), values=c("blue", "red")) + scale_shape_discrete("LASSO-Significant?", labels=c("No", "Yes")) + scale_x_discrete(limits=seq(-200, 200, 100))

############Repeat analysis for ONLY DE genes:
DEgenedf <- filter(gene.hic.filt, adj.P.Val <=0.05) %>% select(., genes, logFC, HID, CID, Hstrand.H, Hstrand.C) #Have checked, both strands are identical between the species here
DEgenedf <- DEgenedf[complete.cases(DEgenedf),] #Leaves us with about ~7500 genes; 500 of which will be repeats on overlapping bins--can leave them in for now, just remove instances of those entirely, or try to just keep the one with a larger logFC. Just remove at random for now:
badHs <- which(duplicated(DEgenedf$HID))
badCs <- which(duplicated(DEgenedf$CID))

DEgenedf <- DEgenedf[c(-badHs, -badCs),] #Have now removed any instances of duplicated bins here!

adj.DE <- left_join(adj.hum.mean, DEgenedf, by="HID") %>% left_join(., adj.chimp.mean, by="CID", suffix=c(".human", ".chimp")) #Join to get the full set of information
adj.DE <- adj.DE[complete.cases(adj.DE),] #Get rid of rows where we don't have all the info

for(row in 1:nrow(adj.DE)){#Check strand by species; if strand is negative, flip the entire set of values across bins around for the species.
  if(adj.DE$Hstrand.H[row]=="-"){adj.DE[row,1:101] <- adj.DE[row, 101:1]}
  if(adj.DE$Hstrand.C[row]=="-"){adj.DE[row, 108:208] <- adj.DE[row, 208:108]}
}

#########Final modeling and visualization on DE genes, both full bin set and 20 bins on each side.
adj.final.DE <- select(adj.DE, genes, logFC)
adj.final.DE[,3:103] <- abs(adj.DE[,1:101]-adj.DE[,108:208]) #Subtract chimp values from human values. Like in expression.
adj.final.DE$logFC <- abs(adj.final.DE$logFC)
#adj.final.DE[,3:103] <- abs(adj.DE[,1:101]-adj.DE[,108:208]) #Same thing but with absolute difference
model.covs.DE <- paste(colnames(adj.final.DE)[c(3:52,54:103)], collapse=" + ") #Obtain the long linear equation here.
model.full.DE <- paste("logFC ~ ", model.covs.DE, sep="")

#Test with abs valu of logFC
#adj.final.DE$logFC <- abs(adj.final.DE$logFC)

#Remove gene's own bin
adj.final.DE$V51.human <- NA

#Now, run an actual linear model. First basic, then lasso.
simple.result.DE <- lm(eval(model.full.DE), data=adj.final.DE)
set.seed(30) #set.seed for cv.glmnet
cv.lasso.DE <- cv.glmnet(as.matrix(adj.final.DE[,c(3:52,54:103)]), as.matrix(adj.final.DE[,2]), alpha=1)
#plot(cv.lasso)
cv.lasso.DE$lambda.min
#plot(1:101, as.matrix(coef(cv.lasso, s="lambda.min"))[1:101,1])

#Visualization!
binsplotdf.DE <- summary(simple.result.DE)$coefficients
binsplotdf.DE <- as.data.frame(binsplotdf.DE[-1,])
#binsplotdf$location <- c(-50:-1, 0, 1:50)*10
binsplotdf.DE$location <- c(-50:-1, 1:50)*10
binsplotdf.DE$significant <- ifelse(binsplotdf.DE$`Pr(>|t|)`<=0.05, "yes", "no")
#binsplotdf$lasso.val <- as.matrix(coef(cv.lasso, s="lambda.min"))[2:102, 1]
binsplotdf.DE$lasso.val <- as.matrix(coef(cv.lasso, s="lambda.min"))[2:101, 1]
colnames(binsplotdf.DE) <- c("beta", "std.error", "t.val", "p.val", "location", "significant", "lasso.value")
binsplotdf.DE$lasso.value <- ifelse(binsplotdf.DE$lasso.value==0, "no", "yes")
ggplot(data=binsplotdf.DE) + geom_pointrange(aes(x=location, y=beta, ymin=beta-std.error, ymax=beta+std.error, color=significant, shape=lasso.value), size=0.5) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + ggtitle("DE logFC ~ Mean Species Contact Frequency Difference") + scale_x_discrete(limits=seq(-500, 500, 100)) + scale_color_manual("LM-Significant?", labels=c("No", "Yes"), values=c("blue", "red")) + scale_shape_discrete("LASSO-Significant?", labels=c("No", "Yes"))

#######################Same thing, absolute vals
ggplot(data=binsplotdf.DE) + geom_pointrange(aes(x=location, y=abs(beta), ymin=abs(beta)-std.error, ymax=abs(beta)+std.error, color=significant, shape=lasso.value), size=0.5) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + ggtitle("DE logFC ~ Mean Species Contact Frequency Difference") + scale_x_discrete(limits=seq(-500, 500, 100)) + scale_color_manual("LM-Significant?", labels=c("No", "Yes"), values=c("blue", "red")) + scale_shape_discrete("LASSO-Significant?", labels=c("No", "Yes"))

##############Try again, but only with 20 adjacent bins on each side!
adj.final.20.DE <- select(adj.DE, genes, logFC)
adj.final.20.DE[,3:43] <- abs(adj.DE[,31:71]-adj.DE[,138:178]) #Humans minus chimps...
adj.final.20.DE$logFC <- abs(adj.final.20.DE$logFC)
model.covs.20.DE <- paste(colnames(adj.final.20.DE)[c(3:22,24:43)], collapse=" + ")
adj.final.20.DE$V51.human <- NA #Remove gene's own bin
model.full.20.DE <- paste("logFC ~ ", model.covs.20.DE, sep="")
simple.result.20.DE <- lm(eval(model.full.20.DE), data=adj.final.20.DE) #LM for 20
set.seed(31)
cv.lasso20.DE <- cv.glmnet(as.matrix(adj.final.20.DE[,c(3:22, 24:43)]), as.matrix(adj.final.20.DE[,2]), alpha=1) #Was just 3:43 but that threw an NA error
#plot(cv.lasso20)
#plot(1:41, as.matrix(coef(cv.lasso20, s="lambda.min"))[2:42,1])
binsplotdf20.DE <- summary(simple.result.20.DE)$coefficients
binsplotdf20.DE <- as.data.frame(binsplotdf20.DE[-1,])
#binsplotdf20.DE$location <- c(-20:-1, 0, 1:20)*10
binsplotdf20.DE$location <- c(-20:-1, 1:20)*10
binsplotdf20.DE$significant <- ifelse(binsplotdf20.DE$`Pr(>|t|)`<=0.05, "yes", "no")
binsplotdf20.DE$lasso.val <- as.matrix(coef(cv.lasso20.DE, s="lambda.min"))[2:41, 1]
colnames(binsplotdf20.DE) <- c("beta", "std.error", "t.val", "p.val", "location", "significant", "lasso.value")
binsplotdf20.DE$lasso.value <- ifelse(binsplotdf20.DE$lasso.value==0, "no", "yes")
ggplot(data=binsplotdf20.DE) + geom_pointrange(aes(x=location, y=beta, ymin=beta-std.error, ymax=beta+std.error, color=significant, shape=lasso.value), size=0.5) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + ggtitle("DE logFC ~ Mean Species Contact Frequency Difference") + scale_color_manual("LM-Significant?", labels=c("No", "Yes"), values=c("blue", "red")) + scale_shape_discrete("LASSO-Significant?", labels=c("No", "Yes")) + scale_x_discrete(limits=seq(-200, 200, 100))

#######################Same thing, absolute vals
ggplot(data=binsplotdf20.DE) + geom_pointrange(aes(x=location, y=abs(beta), ymin=abs(beta)-std.error, ymax=abs(beta)+std.error, color=significant, shape=lasso.value), size=0.5) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + ggtitle("DE logFC ~ Mean Species Contact Frequency Difference") + scale_color_manual("LM-Significant?", labels=c("No", "Yes"), values=c("blue", "red")) + scale_shape_discrete("LASSO-Significant?", labels=c("No", "Yes")) + scale_x_discrete(limits=seq(-200, 200, 100))


####Assessing the significance of this with permutations. Still needs to be worked on.
#Now, run an actual linear model.
# simple.result <- lm(eval(model.full), data=adj.final.DE)
# 
# #Visualization!
# binsplotdfDE <- summary(simple.result)$coefficients
# binsplotdfDE <- as.data.frame(binsplotdfDE[-1,])
# binsplotdfDE$location <- c(-50:-1, 1:50)*10
# binsplotdfDE$significant <- ifelse(binsplotdfDE$`Pr(>|t|)`<=0.05, "yes", "no")
# colnames(binsplotdfDE) <- c("beta", "std.error", "t.val", "p.val", "location", "significant")
# ggplot(data=binsplotdfDE) + geom_pointrange(aes(x=location, y=beta, ymin=beta-std.error, ymax=beta+std.error, color=significant), size=0.25) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + scale_color_manual("Significant?", labels=c("Yes", "No"), values=c("blue", "red")) + ggtitle("Exp. logFC ~ Mean Species Contact Freq Difference, DE Genes") + scale_x_discrete(limits=seq(-500, 500, 100))
# 
# #Lasso implementation on just DE genes:
# valuesDE <- as.matrix(adj.final.DE[,3:103])
# responseDE <- as.matrix(adj.final.DE[,2])
# set.seed(31)
# cv.lasso.DE <- cv.glmnet(valuesDE[,-51], responseDE, alpha=1)
# cv.lasso.DE$lambda.min
# #plot(1:101, as.matrix(coef(cv.lasso.DE, s="lambda.min"))[1:101, 1])
# 
# lm.perms <- lm.DE.perms <- lasso.perms <- lasso.DE.perms <- matrix(nrow=101, ncol=100)
# for(permutation in 1:100){
#   adj.all <- adj.final[,-53]
#   adj.DEonly <- adj.final.DE[,-53]
#   adj.all[,3:102] <- shuffler(adj.all[,3:102])
#   adj.DEonly[, 3:102] <- shuffler(adj.DEonly[,3:102])
#   lm.perms[,permutation] <- lm(model.full, data=adj.all)$coefficients
#   lm.DE.perms[,permutation] <- lm(model.full, data=adj.DEonly)$coefficients
#   lasso.perms[,permutation] <- coef(cv.glmnet(as.matrix(adj.all[,3:102]), adj.all$logFC, alpha=1), s="lambda.min")[,1]
#   lasso.DE.perms[,permutation] <- coef(cv.glmnet(as.matrix(adj.DEonly[,3:102]), adj.DEonly$logFC, alpha=1), s="lambda.min")[,1]
# }
# 
# rownames(lm.perms) <- rownames(lm.DE.perms) <- rownames(lasso.perms) <- rownames(lasso.DE.perms) <- names(simple.result$coefficients)
# lm.perms <- as.data.frame(lm.perms)
# lm.perms$location <- c(NA, seq(-500, 500, 10))
# testdf <- melt(t(lm.perms[-1,]))
# ggplot(data=as.data.frame(testdf)) + geom_boxplot(aes(x=Var2, y=value, group=Var2))
# testdf <- as.data.frame(testdf)
# testdf$location <- rep(-50:50, each=100)[-5001:-5100]
# testdf$location <- testdf$location*10
# 
# ggplot(data=binsplotdf) + geom_pointrange(aes(x=location, y=abs(beta), ymin=abs(beta)-std.error, ymax=abs(beta)+std.error, color=significant, shape=lasso.value), size=0.5) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + ggtitle("Expression logFC ~ Mean Species Contact Frequency Difference") + geom_boxplot(data=testdf, aes(x=location, y=value, group=location), alpha=0.001) + scale_x_discrete(limits=seq(-500, 500, 100)) + scale_color_manual("LM-Significant?", labels=c("No", "Yes"), values=c("blue", "red")) + scale_shape_discrete("LASSO-Significant?", labels=c("No", "Yes"))
# 
# as.matrix(coef(cv.lasso, s="lambda.min"))
# binsplotdf$type <- "lm"
# binsplotdf[102:202,1] <- (as.matrix(coef(cv.lasso, s="lambda.min")[2:102, 1]))*2.5 #2.5 is an arbitrary number, just wanted something to scale it up so it can be compared to lm results easily
# binsplotdf$location[102:202] <- binsplotdf$location[1:101]
# binsplotdf$type[102:202] <- "lasso"
# 
# ggplot(data=binsplotdf[1:101,]) + geom_pointrange(aes(x=location, y=abs(beta), ymin=abs(beta)-std.error, ymax=abs(beta)+std.error, color=significant, shape=type), size=0.25) + geom_point(data=binsplotdf[102:202,], aes(x=location, y=abs(beta), shape=type)) + geom_line(aes(x=location, y=lmpermmean[-1])) + xlab("Bin Location Relative to Gene (kb)") + ylab("Effect Size") + scale_color_manual("Significant?", labels=c("Yes", "No"), values=c("blue", "red")) + ggtitle("Expression logFC ~ Mean Species Contact Frequency Difference") + scale_x_discrete(limits=seq(-500, 500, 100))
# 
# lmpermmean <- rowMeans(lm.perms) #Check if genes in this set are on the same chromo b/t species; check with a permutation that actually breaks association between logFC and distance by pulling out other random locations from Hi-C and shuffling my logFC vector here with them, to see if this is a general trend of all Hi-C data or if it's just in these genes
# #Can also later separate genes out into three classes of high, low, med in terms of conservation WRT chimp/human genome alignment; can try doing it with just syntenic and non-syntenic genes at first as well for an initial naive pass
```

## Session information

<!-- Insert the session information into the document -->
```{r session-info}
```
